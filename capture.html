<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence – Certificazione</title>
<style>
  :root{--bd:#ddd;--accent:#0b5cff;--mut:#666}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0}
  header{display:grid;grid-template-columns:180px 1fr auto auto 200px 1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:10px}
  input,select,button{padding:8px;border:1px solid var(--bd);border-radius:8px;background:#fafafa}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  button[data-on="1"]{box-shadow:0 0 0 3px rgba(11,92,255,.2)}
  #state{justify-self:end;font-size:12px;color:#222;background:#f3f4f6;border-radius:999px;padding:.25rem .6rem}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 10px;border-bottom:1px solid #f0f0f0}
  #work{display:grid;grid-template-columns:1.2fr .8fr;gap:10px;padding:10px}
  video{width:100%;background:#000;border-radius:8px;height:75vh}
  #cropWrap{position:relative;user-select:none;-webkit-user-select:none}
  #img{max-width:100%;display:none;-webkit-user-drag:none;user-drag:none}
  #img.hasSrc{display:block}
  #rect{position:absolute;border:2px dashed #000;background:rgba(0,0,0,.12);display:none;pointer-events:none}
  #log{height:170px;border:1px solid #eee;border-radius:8px;padding:8px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <input id="client" placeholder="Cliente…" />
  <input id="addr" type="url" placeholder="https://…" />
  <button id="btnPreview" class="primary">Anteprima (condivisione)</button>
  <button id="btnOpen">Apri scheda</button>
  <input id="rcpts" placeholder="Destinatari PEC/email" />
  <input id="subj"  value="Web Evidence – Screenshot" />
  <button id="btnStart">Inizia certificazione</button>
  <button id="btnFinish" disabled>Termina</button>
  <span id="state">Pronto</span>
</header>

<div class="toolbar">
  <button id="capFrame"  disabled>Scatta frame (selezione)</button>
  <button id="capFull"   disabled>Scatta intero</button>
  <button id="capReset"  disabled>Annulla selezione</button>

  <span style="margin-left:16px">
    <label>SM:</label>
    <select id="smDim">
      <option>1366xfull</option><option selected>1920xfull</option><option>2560xfull</option><option>3840xfull</option>
      <option disabled>──────────</option>
      <option>1366x768</option><option>1600x900</option><option>1920x1080</option><option>2560x1440</option><option>3840x2160</option>
    </select>
    <button id="btnSMfull" disabled>SM full-page</button>
    <button id="btnSMview" disabled>SM view</button>
    <button id="btnPSI"   disabled>PSI</button>
    <button id="btnSnap"  disabled>Snapshot pagina</button>
  </span>

  <span style="margin-left:auto">
    <button id="savePng"  disabled>Salva PNG</button>
    <button id="savePngEmail" disabled>Salva+Email</button>
    <button id="saveVideo" disabled>Salva VIDEO</button>
  </span>
</div>

<div id="work">
  <video id="video" autoplay playsinline></video>
  <div id="cropWrap">
    <img id="img" alt=""/>
    <div id="rect"></div>
  </div>
</div>

<div style="padding:8px 10px"><b>Log</b></div>
<div id="log"></div>

<script>
/* ---------- Parametri ---------- */
const qs=new URLSearchParams(location.search);
const APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
const DEFU=qs.get('u')||'', DEFC=qs.get('client')||'', DEFT=qs.get('to')||'', DEFS=qs.get('subj')||'';
client.value=DEFC||''; addr.value=DEFU||''; rcpts.value=DEFT||''; if(DEFS) subj.value=DEFS;

/* ---------- Stato ---------- */
let SID=''; let currentUrl=(addr.value||'').trim();
let stream=null, mediaRec=null, chunks=[];
let last={type:'',dataUrl:'',meta:null,crop:null};
const video=document.getElementById('video'), img=document.getElementById('img'), rect=document.getElementById('rect'), wrap=document.getElementById('cropWrap');

/* ---------- Utils ---------- */
const setState = s => document.getElementById('state').textContent=s;
const log = s => { const L=document.getElementById('log'); L.textContent+=(L.textContent?'\n':'')+'['+(new Date().toLocaleTimeString())+'] '+s; L.scrollTop=L.scrollHeight; };
const mark = (btn,on)=>{ if(!btn) return; btn.dataset.on = on?'1':'0'; };
async function GET(q){ const r=await fetch(APP+(APP.includes('?')?'&':'?')+q); return r.json(); }
async function POST(body){ const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(body)}); return r.json(); }
function needSID(){ if(!SID){ alert('Avvia “Inizia certificazione” prima.'); return true;} return false; }
function hostFrom(u){ try{ return new URL(u).hostname; }catch(_){ return ''; } }
function dataUrlFromImage(full=false){
  if(!img.src) return null;
  const natW=img.naturalWidth, natH=img.naturalHeight;
  const c=document.createElement('canvas'), ctx=c.getContext('2d');
  if(full || rect.style.display==='none' || !parseFloat(rect.style.width)||!parseFloat(rect.style.height)){
    c.width=natW; c.height=natH; ctx.drawImage(img,0,0); return {dataUrl:c.toDataURL('image/png'), crop:null};
  }
  const dispW=img.clientWidth, dispH=img.clientHeight;
  const rx=Math.round(parseFloat(rect.style.left)*natW/dispW);
  const ry=Math.round(parseFloat(rect.style.top )*natH/dispH);
  const rw=Math.round(parseFloat(rect.style.width)*natW/dispW);
  const rh=Math.round(parseFloat(rect.style.height)*natH/dispH);
  c.width=Math.max(1,rw); c.height=Math.max(1,rh);
  ctx.drawImage(img,rx,ry,rw,rh,0,0,c.width,c.height);
  return {dataUrl:c.toDataURL('image/png'), crop:{x:rx,y:ry,w:c.width,h:c.height,naturalW:natW,naturalH:natH}};
}

/* ---------- Anteprima = condivisione schermo ---------- */
btnPreview.onclick = async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:false});
    video.srcObject = stream; await video.play();
    log('Condivisione attiva (scheda/finestra/schermo).');
    setState('Anteprima attiva');
    // abilita comandi base
    ['capFrame','capFull','capReset','btnStart'].forEach(id=>document.getElementById(id).disabled=false);
    mark(btnPreview,true);
    if(SID){ await GET('mode=note&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)+'&msg='+encodeURIComponent('USER_PREVIEW_STARTED')+'&ua='+encodeURIComponent(navigator.userAgent||'')); }
  }catch(e){ alert('Condivisione negata: '+(e.message||e)); }
};
btnOpen.onclick = ()=>{ const u=(addr.value||'').trim(); if(u) window.open(u,'_blank','noopener'); };

/* ---------- Fence ---------- */
(function fence(){
  let drag=false,sx=0,sy=0;
  function bounds(e){ const r=wrap.getBoundingClientRect(); return {x:Math.max(0,Math.min(e.clientX-r.left,r.width)), y:Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  wrap.addEventListener('pointerdown', e=>{
    if(!img.classList.contains('hasSrc')) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; wrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y;
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px',display:'block'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; const w=parseFloat(rect.style.width)||0,h=parseFloat(rect.style.height)||0; if(w<3&&h<3){rect.style.width='160px';rect.style.height='100px';} });
})();
capReset.onclick = ()=>{ rect.style.display='none'; log('Selezione rimossa'); };

/* ---------- Scatti da video ---------- */
capFrame.onclick = ()=>{
  if(!stream || !video.videoWidth){ alert('Anteprima non attiva'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight; c.getContext('2d').drawImage(video,0,0);
  img.src=c.toDataURL('image/png'); img.classList.add('hasSrc');
  last={type:'image',dataUrl:img.src,meta:{provider:'screen-capture',label:'FRAME_CROP',dimension:`${video.videoWidth}x${video.videoHeight}`}};
  savePng.disabled=false; savePngEmail.disabled=false;
};
capFull.onclick = ()=>{ capFrame.click(); rect.style.display='none'; last.meta.label='FRAME_FULL'; };

/* ---------- Start / Finish ---------- */
btnStart.onclick = async ()=>{
  const cli=client.value.trim(), u=(addr.value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!u){ alert('URL obbligatoria'); return; }
  currentUrl=u; setState('Creo sessione…'); mark(btnStart,true); btnStart.disabled=true;
  const host=hostFrom(u);
  const js=await GET('mode=start&t='+encodeURIComponent(TOKEN)
    +'&u='+encodeURIComponent(u)
    +'&host='+encodeURIComponent(host)
    +'&client='+encodeURIComponent(cli)
    +'&ua='+encodeURIComponent(navigator.userAgent||'')
    +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
    +'&lang='+encodeURIComponent(navigator.language||'')
    +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)
    +'&page='+encodeURIComponent(location.href||''));
  if(!js.ok){ alert(js.error); mark(btnStart,false); btnStart.disabled=false; setState('Errore'); return; }
  SID=js.sessionId;
  ['btnFinish','btnSMfull','btnSMview','btnPSI','btnSnap'].forEach(id=>document.getElementById(id).disabled=false);
  log('Sessione avviata: '+js.base+' (snapshot iniziale salvato)');
  setState('Sessione attiva');
};

btnFinish.onclick = async ()=>{
  if(!SID){ alert('Nessuna sessione attiva'); return; }
  setState('Creo ZIP…'); mark(btnFinish,true); btnFinish.disabled=true;
  const qs='mode=finish&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)
          +(rcpts.value?('&to='+encodeURIComponent(rcpts.value)):'')
          +(subj.value?('&subj='+encodeURIComponent(subj.value)):'');
  const js=await GET(qs);
  if(!js.ok){ alert(js.error); mark(btnFinish,false); btnFinish.disabled=false; setState('Errore'); return; }
  log('ZIP: '+js.zipUrl); setState('Completato');
  document.querySelectorAll('button').forEach(b=> b.disabled=false);
  // dopo finish: blocca azioni che alterano lo stato
  ['capFrame','capFull','savePng','savePngEmail','saveVideo','btnSMfull','btnSMview','btnPSI','btnSnap'].forEach(id=>document.getElementById(id).disabled=true);
};

/* ---------- SM / PSI / Snapshot ---------- */
async function runSMPSI(kind){
  const u=(addr.value||currentUrl||'').trim(); if(!u){ alert('URL mancante'); return; }
  if(!SID){ alert('Avvia certificazione'); return; }
  setState(kind+'…'); const dim=(kind==='SM_FULL'?smDim.value:smDim.value.replace('full','1080'));
  const q = kind==='PSI'
    ? 'mode=psi&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)
    : 'mode=sm&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)+'&dim='+encodeURIComponent(kind==='SM_FULL'?dim:dim);
  const js=await GET(q);
  if(!js.ok){ alert(js.error); setState('Errore'); return; }
  // salvataggio diretto (senza fence)
  const meta=js.meta||{provider:(kind==='PSI'?'psi':'screenshotmachine'),label:(kind==='PSI'?'PSI':'SM'),dimension:dim};
  const save=await POST({authToken:TOKEN,sid:SID,fileNameHint:'shot.png',dataUrl:js.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,canonical:'',sourceMeta:meta,crop:null}});
  if(!save.ok){ alert(save.error); setState('Errore'); return; }
  log(kind+' salvato: '+save.name+' sha='+save.sha256); setState('Pronto');
}
btnSMfull.onclick = ()=> runSMPSI('SM_FULL');
btnSMview.onclick = ()=> runSMPSI('SM_VIEW');
btnPSI.onclick    = ()=> runSMPSI('PSI');
btnSnap.onclick   = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||currentUrl||'').trim(); setState('Snapshot…');
  const js=await GET('mode=snapshot&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)+'&u='+encodeURIComponent(u));
  if(!js.ok){ alert(js.error); setState('Errore'); return; }
  log('Snapshot salvato (asset='+js.assets+')'); setState('Pronto');
};

/* ---------- Registrazione video ---------- */
recStart.onclick = ()=>{
  if(!stream){ alert('Attiva Anteprima prima'); return; }
  chunks=[]; mediaRec=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
  mediaRec.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRec.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const fr=new FileReader(); fr.onload=()=>{ last={type:'video',dataUrl:String(fr.result),meta:{provider:'screen-record',label:'RECORDING'},crop:null}; saveVideo.disabled=true; saveVideo.disabled=false; log('Video pronto da salvare'); }; fr.readAsDataURL(blob);
  };
  mediaRec.start(); recStart.disabled=true; recStop.disabled=false; document.getElementById('recState').textContent='REC';
};
recStop.onclick = ()=>{ if(mediaRec && mediaRec.state!=='inactive') mediaRec.stop(); recStart.disabled=false; recStop.disabled=true; document.getElementById('recState').textContent='idle'; };

/* ---------- Salvataggi manuali ---------- */
async function savePNG(email){
  if(!SID){ alert('Avvia certificazione'); return; }
  const payload=dataUrlFromImage(rect.style.display==='none'); if(!payload){ alert('Nessuna immagine'); return; }
  const u=(addr.value||currentUrl||'').trim();
  const js=await POST({authToken:TOKEN,sid:SID,fileNameHint:'shot.png',dataUrl:payload.dataUrl,sendEmail:email,recipients:rcpts.value||undefined,subject:subj.value||undefined,meta:{url:u,finalUrl:u,canonical:'',sourceMeta:{provider:'screen-capture',label:(payload.crop?'FRAME_CROP':'FRAME_FULL')},crop:payload.crop}});
  if(!js.ok){ alert(js.error); return; }
  log('PNG salvato: '+js.name+' sha='+js.sha256);
}
savePng.onclick = ()=> savePNG(false);
savePngEmail.onclick = ()=> savePNG(true);

saveVideo.onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(last.type!=='video'){ alert('Nessun video pronto'); return; }
  const u=(addr.value||currentUrl||'').trim();
  const js=await POST({authToken:TOKEN,sid:SID,fileNameHint:'rec.webm',dataUrl:last.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screen-record',label:'RECORDING'}}});
  if(!js.ok){ alert(js.error); return; }
  log('VIDEO salvato: '+js.name+' sha='+js.sha256); saveVideo.disabled=true;
};

/* ---------- Avvio UI ---------- */
window.addEventListener('load', ()=>{ setState('Pronto'); });
</script>
</body>
</html>
