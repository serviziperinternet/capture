<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence – v14.1</title>
<style>
  :root{--bd:#ddd;--accent:#0b5cff;--mut:#666}
  *{box-sizing:border-box}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0;color:#111;background:#fff}
  header{display:grid;grid-template-columns:170px 1fr auto auto 260px 1fr auto auto auto;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:10px}
  input,button,select{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fafafa}
  input[type="url"], input[type="text"]{background:#fff}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  #state{justify-self:end;font-size:12px;color:#222;background:#f3f4f6;border-radius:999px;padding:.25rem .6rem}

  .wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .card{border:1px solid #eee;border-radius:12px;background:#fff}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #f3f4f4;font-size:13px;font-weight:700}

  .side{padding:12px}
  #thumb{width:300px;height:300px;display:block;background:#1b1b1b;border:1px dashed #ccc;border-radius:10px}

  .controls{display:flex;flex-direction:column;gap:10px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .checks{display:flex;gap:18px;align-items:center}

  .capture{grid-column:1 / -1}
  .cap-wrap{position:relative;padding:12px}
  #imgLarge{max-width:100%;display:none;border-radius:12px;border:1px solid #eee;background:#000}
  #imgLarge.hasSrc{display:block}
  #rect{position:absolute;border:2px dashed #fff;outline:9999px solid rgba(0,0,0,.35);display:none;pointer-events:none}

  #log{height:180px;border:1px solid #eee;border-radius:10px;padding:8px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}
  details{border:1px solid #eee;border-radius:10px;padding:8px 12px;margin:8px 12px}
</style>
</head>
<body>

<header>
  <input id="client" placeholder="Cliente…" />
  <input id="addr" type="url" placeholder="https://…" />
  <button id="btnOpen">Apri finestra pulita</button>
  <button id="btnPreview" class="primary">Seleziona finestra</button>

  <input id="rcpts" placeholder="Destinatari PEC/email" />
  <input id="subj" value="Web Evidence – Pacchetto prove" />
  <select id="pecMode" title="Modalità invio PEC">
    <option value="normal">PEC normale</option>
    <option value="key">PEC via KEY</option>
  </select>
  <button id="btnStart">Inizia certificazione</button>
  <button id="btnFinish" disabled>Termina</button>

  <span id="state">Pronto</span>
</header>

<div class="wrap">
  <!-- Colonna sinistra: ANTEPRIMA LIVE 300×300 (clone) -->
  <div class="card side">
    <h3>Anteprima LIVE (300×300)</h3>
    <canvas id="thumb" width="300" height="300" aria-label="Anteprima"></canvas>
  </div>

  <!-- Colonna destra: CONTROLLI -->
  <div class="card">
    <h3>Controlli</h3>
    <div class="controls">
      <div class="row checks">
        <label><input type="checkbox" id="chkFull"> Screenshot cattura completa</label>
        <label><input type="checkbox" id="chkAssets"> Scarica asset</label>
      </div>
      <div class="row">
        <button id="btnSnap">Scatta</button>
        <button id="btnSave" class="primary">Salva</button>
        <button id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <!-- Riga sotto: FINESTRA DI CATTURA (immagine scattata + fence) -->
  <div class="card capture">
    <h3>Finestra di cattura (scatto)</h3>
    <div class="cap-wrap" id="capWrap">
      <img id="imgLarge" alt="Scatto"/>
      <div id="rect"></div>
    </div>
  </div>
</div>

<details>
  <summary><b>FAQ & Istruzioni rapide</b></summary>
  <ol>
    <li><b>Anteprima LIVE</b>: miniatura 300×300 che clona la finestra condivisa.</li>
    <li><b>Scatto</b>: finisce nell’area grande; trascina per ritagliare (fence). <i>Salva</i> crea PNG con SHA.</li>
    <li><b>Start</b>: se spunti “Screenshot cattura completa” (SM) e/o “Scarica asset”, il server li esegue subito allo start.</li>
    <li><b>Finish</b>: genera MANIFEST (SHA), aggiorna index.html e crea lo ZIP. Seleziona <b>PEC normale</b> o <b>PEC via KEY</b> prima di terminare.</li>
    <li><b>Token</b>: passa <code>&t=…</code> nell’URL della Web App. <b>Client</b> e <b>URL</b> sono obbligatori.</li>
  </ol>
</details>

<div style="padding:8px 12px"><b>Log</b></div>
<div id="log"></div>

<script>
/* ===== Query ===== */
const qs=new URLSearchParams(location.search);
const APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
if(qs.get('u')) addr.value=qs.get('u');
if(qs.get('client')) client.value=qs.get('client');
if(qs.get('to')) rcpts.value=qs.get('to');
if(qs.get('subj')) subj.value=qs.get('subj');
if(qs.get('pecMode')) document.getElementById('pecMode').value=qs.get('pecMode');

/* ===== Stato ===== */
let SID=''; let stream=null; let rafId=null; // render loop per anteprima

const $ = id => document.getElementById(id);
const video = document.createElement('video'); // nascosto, serve solo per la preview
video.autoplay=true; video.muted=true; video.playsInline=true;
const thumb=$('thumb'), imgLarge=$('imgLarge'), rect=$('rect'), capWrap=$('capWrap');

/* ===== Helpers ===== */
const setState = s => $('state').textContent=s;
const log = s => { const L=$('log'); L.textContent+=(L.textContent?'\n':'')+'['+(new Date().toLocaleTimeString())+'] '+s; L.scrollTop=L.scrollHeight; setState(s); };
async function note(type, data={}){ if(!SID) return; const q='mode=note&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)+'&msg='+encodeURIComponent(type+' '+JSON.stringify(data)); try{ await fetch(APP+(APP.includes('?')?'&':'?')+q); }catch(_){}};
function hasStream(){ return !!(video.srcObject && video.videoWidth); }

function drawPreview(){
  if(!hasStream()){ rafId=requestAnimationFrame(drawPreview); return; }
  const ctx=thumb.getContext('2d'); const tw=thumb.width, th=thumb.height; const vw=video.videoWidth, vh=video.videoHeight; if(!vw||!vh){ rafId=requestAnimationFrame(drawPreview); return; }
  ctx.clearRect(0,0,tw,th);
  const br=vw/vh; let dw=tw, dh=tw/br; if(dh>th){ dh=th; dw=th*br; } const dx=(tw-dw)/2, dy=(th-dh)/2;
  ctx.drawImage(video, dx, dy, dw, dh);
  rafId=requestAnimationFrame(drawPreview);
}

/* ===== Apertura finestra pulita + Selezione ===== */
$('btnOpen').onclick = ()=>{
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  window.open(u, '_we_clean_'+Date.now(), 'noopener,width=1280,height=900,menubar=no,toolbar=no,location=no,status=no');
  log('Finestra/pagina aperta. Ora premi “Seleziona finestra”.');
};
$('btnPreview').onclick = async ()=>{
  try{
    const constraints={video:{displaySurface:'window',preferCurrentTab:true},audio:false};
    stream = await navigator.mediaDevices.getDisplayMedia(constraints);
    video.srcObject = stream; await video.play();
    if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview);
    log('Condivisione attiva (anteprima LIVE in alto a sinistra).');
    stream.getVideoTracks()[0].addEventListener('ended', ()=>{ log('Condivisione terminata'); if(rafId){ cancelAnimationFrame(rafId); rafId=null; } });
    note('PREVIEW_START');
  }catch(e){ alert('Condivisione negata: '+(e.message||e)); }
};

/* ===== Sessione ===== */
async function GET(q){ const r=await fetch(APP+(APP.includes('?')?'&':'?')+q); return r.json(); }
async function POST(body){ const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(body)}); return r.json(); }

$('btnStart').onclick = async ()=>{
  const cli=client.value.trim(), u=(addr.value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!u){ alert('URL obbligatoria'); return; }
  const full=$('chkFull').checked?1:0; const assets=$('chkAssets').checked?1:0;
  setState('Creo sessione…');
  const js=await GET('mode=start&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)
    +'&client='+encodeURIComponent(cli)
    +'&full='+full+'&assets='+assets
    +'&ua='+encodeURIComponent(navigator.userAgent||'')
    +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
    +'&lang='+encodeURIComponent(navigator.language||'')
    +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)
    +'&page='+encodeURIComponent(location.href||''));
  if(!js.ok){ alert(js.error||'Errore avvio'); setState('Errore'); return; }
  SID=js.sessionId; $('btnFinish').disabled=false;
  log('Sessione: '+js.base); setState('Pronto'); note('SESSION_START',{base:js.base});
};

$('btnFinish').onclick = async ()=>{
  if(!SID){ alert('Nessuna sessione'); return; }
  setState('Creo ZIP…');
  const js=await GET('mode=finish&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)
    +(rcpts.value?('&to='+encodeURIComponent(rcpts.value)):'')
    +(subj.value?('&subj='+encodeURIComponent(subj.value)):''))+('&pecMode='+encodeURIComponent(document.getElementById('pecMode').value)));
  if(!js.ok){ alert(js.error||'Errore finish'); setState('Errore'); return; }
  log('ZIP: '+js.zipUrl); setState('Completato'); note('SESSION_FINISH',{zip:js.zipUrl});
  document.querySelectorAll('button').forEach(b=> b.disabled=true);
};

/* ===== Fence + Scatto ===== */
(function fence(){
  let drag=false,sx=0,sy=0;
  function bounds(e){ const r=capWrap.getBoundingClientRect(); return {x=Math.max(0,Math.min(e.clientX-r.left,r.width)), y=Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  capWrap.addEventListener('pointerdown', e=>{
    if(!imgLarge.classList.contains('hasSrc')) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; capWrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y; rect.style.display='block';
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; });
})();

$('btnSnap').onclick = async ()=>{
  if(!hasStream()){ alert('Attiva “Seleziona finestra”'); return; }
  try{
    const track=stream.getVideoTracks()[0]; const cap=new ImageCapture(track);
    const bitmap=await cap.grabFrame();
    const c=document.createElement('canvas'); c.width=bitmap.width; c.height=bitmap.height; c.getContext('2d').drawImage(bitmap,0,0);
    imgLarge.src=c.toDataURL('image/png'); imgLarge.classList.add('hasSrc'); rect.style.display='none';
    log('Scatto eseguito → immagine grande pronta.'); note('SNAP_OK',{w:bitmap.width,h:bitmap.height});
  }catch(e){ log('Errore scatto: '+(e.message||e)); }
};

function makePayload(){
  if(!imgLarge.classList.contains('hasSrc')) return null;
  const natW=imgLarge.naturalWidth, natH=imgLarge.naturalHeight;
  const dispW=imgLarge.clientWidth, dispH=imgLarge.clientHeight;
  const rx=parseFloat(rect.style.left)||0, ry=parseFloat(rect.style.top)||0;
  const rw=parseFloat(rect.style.width)||0, rh=parseFloat(rect.style.height)||0;
  const needCrop = rect.style.display!=='none' && rw>2 && rh>2;

  const c=document.createElement('canvas'); const ctx=c.getContext('2d');
  if(!needCrop){
    c.width=natW; c.height=natH; const tmp=new Image(); tmp.src=imgLarge.src;
    return new Promise(res=>{ tmp.onload=()=>{ ctx.drawImage(tmp,0,0); res({dataUrl:c.toDataURL('image/png'), crop:null}); }; });
  }
  const ax=Math.round(rx*natW/dispW), ay=Math.round(ry*natH/dispH);
  const aw=Math.round(rw*natW/dispW), ah=Math.round(rh*natH/dispH);
  c.width=Math.max(1,aw); c.height=Math.max(1,ah); const tmp=new Image(); tmp.src=imgLarge.src;
  return new Promise(res=>{ tmp.onload=()=>{ ctx.drawImage(tmp,ax,ay,aw,ah,0,0,c.width,c.height); res({dataUrl:c.toDataURL('image/png'), crop:{x:ax,y:ay,w:aw,h:ah,naturalW:natW,naturalH:natH}}); }; });
}

$('btnSave').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const payload = await makePayload(); if(!payload){ alert('Nessuna immagine'); return; }
  const u=(addr.value||'').trim();
  const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:payload.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screen-capture',label:(payload.crop?'FRAME_CROP':'FRAME_FULL')},crop:payload.crop}});
  if(!sv.ok){ alert(sv.error||'Errore salvataggio'); return; }
  log('PNG salvato: '+sv.name+' sha='+sv.sha256); note('PNG_SAVED',{name:sv.name,sha:sv.sha256});
};

$('btnReset').onclick = ()=>{
  const tctx=thumb.getContext('2d'); tctx.clearRect(0,0,thumb.width,thumb.height);
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){} stream=null; }
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  imgLarge.removeAttribute('src'); imgLarge.classList.remove('hasSrc'); rect.style.display='none';
  log('Reset effettuato'); note('RESET');
};

setState('Pronto');
</script>
</body>
</html>
