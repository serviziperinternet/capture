<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence – v15.2</title>
<style>
  :root{--bd:#ddd;--ok:#18a957;--danger:#e11d48}
  *{box-sizing:border-box}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0;color:#111;background:#fff}

  header{padding:10px;border-bottom:1px solid #eee}
  .hrow{display:grid;gap:8px;align-items:center}
  .row1{grid-template-columns:170px 1fr auto}
  .row2{grid-template-columns:auto auto 220px 1fr}
  input,button,select{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fafafa}
  input[type="url"], input[type="text"]{background:#fff}
  .success{background:var(--ok)!important;border-color:var(--ok)!important;color:#fff}
  .danger{background:var(--danger)!important;border-color:var(--danger)!important;color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}

  .wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .card{border:1px solid #eee;border-radius:12px;background:#fff}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #f3f4f4;font-size:13px;font-weight:700}

  .side{padding:12px}
  #thumb{width:300px;height:300px;display:block;background:#000;border:1px dashed #ccc;border-radius:10px}
  .mut{color:#666}

  .controls{display:flex;flex-direction:column;gap:10px;padding:12px}
  .controls .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .dim{opacity:.6}

  #logWrap{padding:0 12px 12px}
  #logBox{height:190px;border:1px solid #eee;border-radius:10px;padding:10px;overflow:auto;font:12px/1.55 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}

  .capCard{grid-column:2}
  .cap-wrap{position:relative;padding:12px;overflow:auto;border-top:1px solid #f3f4f6}
  #imgLarge{max-width:100%;display:none;border-radius:12px;border:1px solid #eee;background:#000}
  #imgLarge.hasSrc{display:block}
  #rect{position:absolute;border:2px dashed #fff;display:none;pointer-events:none}
</style>
</head>
<body>

<header>
  <div class="hrow row1">
    <input id="client" placeholder="Cliente…" />
    <input id="addr" type="url" placeholder="https://…" />
    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
      <button id="btnStart" class="success" type="button">Inizia certificazione</button>
      <button id="btnFinish" class="danger" type="button" style="display:none">Termina certificazione</button>
    </div>
  </div>
  <div class="hrow row2" style="margin-top:8px">
    <button id="btnOpen" type="button" disabled class="dim" style="display:none">Apri sito in finestra</button>
    <button id="btnShare" type="button" disabled class="dim" style="display:none">Condividi</button>
    <select id="pecMode" title="Modalità invio PEC">
      <option value="normal" selected>PEC normale</option>
      <option value="key">PEC via KEY</option>
      <option value="auto">PEC auto</option>
    </select>
    <input id="rcpts" placeholder="Destinatari PEC/email (virgola per più indirizzi)" />
  </div>
</header>

<div class="wrap">
  <div class="card side" style="grid-column:1">
    <h3>Anteprima LIVE (300×300)</h3>
    <canvas id="thumb" width="300" height="300" aria-label="Anteprima"></canvas>
    <div class="mut" style="margin-top:8px">1) Inizia → 2) Apri → 3) Condividi</div>
  </div>

  <div class="card" style="grid-column:2">
    <h3>Controlli</h3>
    <div class="controls" id="controlsBox">
      <div class="row">
        <button id="btnFull" type="button" disabled class="dim">Cattura full page</button>
        <button id="btnAssets" type="button" disabled class="dim">Scarica asset</button>
      </div>
      <div class="row">
        <button id="btnSnap" type="button" disabled class="dim">Scatta</button>
        <button id="btnSave" type="button" disabled class="dim">Salva</button>
      </div>
    </div>
    <div id="logWrap">
      <h3 style="border:none;padding:6px 0 6px 0;margin:0">Log</h3>
      <div id="logBox"></div>
    </div>
  </div>

  <div class="card capCard">
    <h3>Finestra di cattura (scatto)</h3>
    <div class="cap-wrap" id="capWrap">
      <img id="imgLarge" alt="Scatto"/>
      <div id="rect"></div>
    </div>
  </div>
</div>

<script>
/* ===== util ===== */
const $=id=>document.getElementById(id);
function logLine(s, important=false){
  const L=$('logBox');
  const entry='['+(new Date().toLocaleTimeString())+'] '+s+(important?'\n':'');
  L.textContent = entry + '\n' + L.textContent; L.scrollTop=0;
}
function enable(el,on){ el.disabled=!on; el.classList.toggle('dim', !on); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ===== query/config ===== */
const qs=new URLSearchParams(location.search);
let APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
if(qs.get('u')) addr.value=qs.get('u');
if(qs.get('client')) client.value=qs.get('client');
if(qs.get('dom')) client.dataset.domain=qs.get('dom');
if(qs.get('domain')) client.dataset.domain=qs.get('domain');
if(qs.get('to')) $('rcpts').value=qs.get('to');

/* ===== stato ===== */
let SID=''; let stream=null; let rafId=null; let lockedShare=false; let hasShot=false;
const video=document.createElement('video'); video.autoplay=true; video.muted=true; video.playsInline=true;
const thumb=$('thumb'), imgLarge=$('imgLarge'), rect=$('rect'), capWrap=$('capWrap');

/* ===== server ===== */
async function GET(q){ const r=await fetch(APP+(APP.includes('?')?'&':'?')+q); return r.json(); }
async function POST(b){ const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(b)}); return r.json(); }

/* ===== busy guard + stati UI ===== */
let BUSY=false, PREV_STATE=null;
function snapshotUIState(){
  return {
    full:!$('btnFull').disabled, assets:!$('btnAssets').disabled, snap:!$('btnSnap').disabled, save:!$('btnSave').disabled,
    open:!$('btnOpen').disabled && $('btnOpen').style.display!=='none',
    share:!$('btnShare').disabled && $('btnShare').style.display!=='none',
    finish:!$('btnFinish').disabled && $('btnFinish').style.display!=='none'
  };
}
function setUIState(state){
  // state: idle | started | shared | locked | finished
  if(state==='idle'){
    enable($('btnFull'), false); enable($('btnAssets'), false); enable($('btnSnap'), false); enable($('btnSave'), false);
    $('btnOpen').style.display='none'; $('btnShare').style.display='none';
  }
  if(state==='started'){
    $('btnOpen').style.display='inline-block'; enable($('btnOpen'), true);
    $('btnShare').style.display='inline-block'; enable($('btnShare'), false);
    enable($('btnFull'), true); enable($('btnAssets'), true);
    enable($('btnSnap'), false); enable($('btnSave'), false);
  }
  if(state==='shared'){
    enable($('btnFull'), true); enable($('btnAssets'), true);
    enable($('btnSnap'), true); enable($('btnSave'), hasShot);
  }
  if(state==='locked'){
    enable($('btnSnap'), false); enable($('btnSave'), false);
    enable($('btnFull'), true); enable($('btnAssets'), true);
  }
  if(state==='finished'){
    document.querySelectorAll('button').forEach(b=> b.disabled=true);
  }
}
async function withBusy(label, fn){
  if(BUSY){ logLine('ATTESA PER: '+BUSY); return; }
  BUSY=label; PREV_STATE=snapshotUIState();
  // disabilita tutto
  document.querySelectorAll('button').forEach(b=> b.disabled=true);
  logLine('ATTESA PER: '+label, true);
  try{ const res=await fn(); logLine('PRONTO: '+label, true); return res; }
  catch(e){ logLine('ERRORE in '+label+': '+(e.message||e), true); }
  finally{
    BUSY=false;
    // ripristina
    if($('btnFinish').style.display==='inline-block') $('btnFinish').disabled=false;
    if(PREV_STATE){
      enable($('btnFull'), !!PREV_STATE.full);
      enable($('btnAssets'), !!PREV_STATE.assets);
      enable($('btnSnap'), !!PREV_STATE.snap);
      enable($('btnSave'), !!PREV_STATE.save);
      if($('btnOpen').style.display!=='none') $('btnOpen').disabled=!PREV_STATE.open;
      if($('btnShare').style.display!=='none') $('btnShare').disabled=!PREV_STATE.share;
    }
  }
}

/* ===== anteprima ===== */
function drawPreview(){
  const ctx=thumb.getContext('2d'); const tw=thumb.width, th=thumb.height;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,tw,th);
  if(!(video.videoWidth && video.videoHeight)){ rafId=requestAnimationFrame(drawPreview); return; }
  const vw=video.videoWidth, vh=video.videoHeight;
  const br=vw/vh; let dw=tw, dh=tw/br; if(dh>th){ dh=th; dw=th*br; } const dx=(tw-dw)/2, dy=(th-dh)/2;
  ctx.drawImage(video, dx, dy, dw, dh);
  rafId=requestAnimationFrame(drawPreview);
}
(function(){ if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview); })();

/* ===== START ===== */
$('btnStart').onclick = async ()=>{
  if(SID){ logLine('Sessione già attiva.'); return; }
  const cli=client.value.trim(), url=(addr.value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!url){ alert('URL obbligatoria'); return; }

  // blocca SUBITO (anti-manomissione)
  $('btnStart').style.opacity=.5; $('btnStart').disabled=true;
  addr.readOnly=true; addr.disabled=true; client.readOnly=true; client.disabled=true;
  logLine('Avvio certificazione…');

  await withBusy('Avvio certificazione', async ()=>{
    const host = (client.dataset.domain||'') || (new URL(url)).hostname.replace(/^www\./,'');
    const js=await GET('mode=start&t='+encodeURIComponent(TOKEN||'')
      +'&u='+encodeURIComponent(url)+'&client='+encodeURIComponent(cli)
      +'&domain='+encodeURIComponent(host)
      +'&ua='+encodeURIComponent(navigator.userAgent||'')
      +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
      +'&lang='+encodeURIComponent(navigator.language||'')
      +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)
      +'&page='+encodeURIComponent(location.href||'')
    );
    if(!js.ok) throw new Error(js.error||'Errore avvio');
    SID=js.sessionId;

    // subject auto
    const now=new Date(), pad=n=>('0'+n).slice(-2);
    window._SUBJ_DEFAULT='Web Evidence – '+cli+' – '+host+' – '+now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+' '+pad(now.getHours())+':'+pad(now.getMinutes());

    logLine('SESSIONE: '+js.base+(js.folderUrl?(' → '+js.folderUrl):''), true);
    if(js.trace) js.trace.forEach(t=>logLine(t));

    // swap start→finish e abilita comandi
    $('btnStart').style.display='none';
    $('btnFinish').style.display='inline-block'; $('btnFinish').disabled=false;
    setUIState('started');
  });
};

/* ===== Apri / Condividi ===== */
$('btnOpen').onclick = ()=>{
  const url=(addr.value||'').trim(); if(!url){ alert('URL obbligatoria'); return; }
  window.open(url, '_we_clean_'+Date.now(), 'noopener,noreferrer,width=1280,height=900,menubar=no,toolbar=no,location=no,status=no');
  logLine('Finestra/pagina aperta.');
  $('btnOpen').style.display='none';
  enable($('btnShare'), true);
};
$('btnShare').onclick = async ()=>{
  await withBusy('Condivisione schermo', async ()=>{
    const s = await navigator.mediaDevices.getDisplayMedia({video:true,audio:false});
    stream = s; video.srcObject = s;
    await new Promise(r=>video.addEventListener('loadedmetadata', r, {once:true}));
    video.play();
    if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview);
    logLine('Condivisione attiva (anteprima a sinistra).', true);

    const vt = s.getVideoTracks()[0];
    vt.addEventListener('ended', ()=>{
      logLine('Condivisione terminata. Scatto disattivato per questa sessione.', true);
      lockedShare=true; setUIState('locked');
    });

    enable($('btnSnap'), true);
    $('btnShare').disabled=true; $('btnShare').classList.add('dim');
    setUIState('shared');
  });
};

/* ===== verifica URL ===== */
async function verifyUrlOrStop(){
  const chk=await GET('mode=checkUrl&sid='+encodeURIComponent(SID)+'&u='+encodeURIComponent(addr.value||''));
  if(!chk.ok || chk.mismatch){ logLine('URL variata / verifica fallita. Operazione bloccata.', true); return false; }
  return true;
}

/* ===== Full page ===== */
$('btnFull').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  await withBusy('Cattura full page', async ()=>{
    logLine('SM 1920×1240 in corso…');
    let sm1=await GET('mode=sm&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u)+'&dim=1920x1240');
    if(!sm1.ok) throw new Error(sm1.error||'SM 1240');
    let sv1=await POST({authToken:TOKEN,sid:SID,dataUrl:sm1.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screenshotmachine',label:'SM_1920x1240'}}});
    logLine('Salvato: '+sv1.name+' sha='+sv1.sha256, true);

    logLine('SM 1920×full in corso…');
    let sm2=await GET('mode=sm&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u)+'&dim=1920xfull');
    if(!sm2.ok) throw new Error(sm2.error||'SM full');
    let sv2=await POST({authToken:TOKEN,sid:SID,dataUrl:sm2.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screenshotmachine',label:'SM_1920xfull'}}});
    logLine('Salvato: '+sv2.name+' sha='+sv2.sha256, true);

    logLine('PSI final screenshot…');
    let psi=await GET('mode=psi&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u));
    if(psi.ok && psi.dataUrl){
      let sv3=await POST({authToken:TOKEN,sid:SID,dataUrl:psi.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'psi',label:'PSI_FINAL'}}});
      logLine('PSI salvato: '+sv3.name+' sha='+sv3.sha256, true);
    }else{
      logLine('PSI non disponibile.');
    }
  });
};

/* ===== Asset ===== */
$('btnAssets').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  await withBusy('Scarica asset', async ()=>{
    const sj=await GET('mode=snapshot&t='+encodeURIComponent(TOKEN||'')+'&id='+encodeURIComponent(SID)+'&u='+encodeURIComponent(u));
    if(!sj.ok) throw new Error(sj.error||'Snapshot error');
    logLine('HTML+asset salvati: '+sj.count, true);
  });
};

/* ===== Fence + Scatta + Salva ===== */
(function fence(){
  let drag=false,sx=0,sy=0;
  function bounds(e){ const r=capWrap.getBoundingClientRect(); return {x:Math.max(0,Math.min(e.clientX-r.left,r.width)), y:Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  capWrap.addEventListener('pointerdown', e=>{
    if(!imgLarge.classList.contains('hasSrc')) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; capWrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y; rect.style.display='block';
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; });
})();

$('btnSnap').onclick = async ()=>{
  if(lockedShare){ logLine('Condivisione chiusa: scatto non consentito.', true); return; }
  if(!(await verifyUrlOrStop())) return;

  await withBusy('Scatto', async ()=>{
    if(!(stream && stream.getVideoTracks().length && stream.getVideoTracks()[0].readyState==='live')){
      logLine('Condivisione non attiva: premi “Condividi”.', true);
      return;
    }
    const w = video.videoWidth||1920, h = video.videoHeight||1080;
    const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(video,0,0,w,h);
    imgLarge.src=c.toDataURL('image/png'); imgLarge.classList.add('hasSrc'); rect.style.display='none';
    hasShot=true; enable($('btnSave'), true);
    logLine('Scatto eseguito → immagine grande pronta.', true);
  });
};

function makePayload(){
  if(!imgLarge.classList.contains('hasSrc')) return null;
  const natW=imgLarge.naturalWidth, natH=imgLarge.naturalHeight;
  const dispW=imgLarge.clientWidth, dispH=imgLarge.clientHeight;
  const rx=parseFloat(rect.style.left)||0, ry=parseFloat(rect.style.top)||0;
  const rw=parseFloat(rect.style.width)||0, rh=parseFloat(rect.style.height)||0;
  const needCrop = rect.style.display!=='none' && rw>2 && rh>2;

  const c=document.createElement('canvas'); const ctx=c.getContext('2d');
  if(!needCrop){
    c.width=natW; c.height=natH; const tmp=new Image(); tmp.src=imgLarge.src;
    return new Promise(res=>{ tmp.onload=()=>{ ctx.drawImage(tmp,0,0); res({dataUrl:c.toDataURL('image/png'), crop:null}); }; });
  }
  const ax=Math.round(rx*natW/dispW), ay=Math.round(ry*natH/dispH);
  const aw=Math.round(rw*natW/dispW), ah=Math.round(rh*natH/dispH);
  c.width=Math.max(1,aw); c.height=Math.max(1,ah); const tmp=new Image(); tmp.src=imgLarge.src;
  return new Promise(res=>{ tmp.onload=()=>{ ctx.drawImage(tmp,ax,ay,aw,ah,0,0,c.width,c.height); res({dataUrl:c.toDataURL('image/png'), crop:{x:ax,y:ay,w:aw,h:ah,naturalW:natW,naturalH:natH}}); }; });
}

$('btnSave').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!hasShot){ alert('Fai prima uno scatto'); return; }
  if(!(await verifyUrlOrStop())) return;

  await withBusy('Salvataggio scatto', async ()=>{
    const payload = await makePayload(); if(!payload){ logLine('Nessuna immagine.'); return; }
    const u=(addr.value||'').trim();
    const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:payload.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screen-capture',label:(payload.crop?'FRAME_CROP':'FRAME_FULL')},crop:payload.crop}});
    if(!sv.ok) throw new Error(sv.error||'Errore salvataggio');
    logLine('PNG salvato: '+sv.name+' sha='+sv.sha256, true);
  });
};

/* ===== Termina ===== */
$('btnFinish').onclick = async ()=>{
  if(!SID){ alert('Nessuna sessione'); return; }
  await withBusy('Termina certificazione (ZIP + invio)', async ()=>{
    const q='mode=finish'
      +'&t='+encodeURIComponent(TOKEN||'')
      +'&id='+encodeURIComponent(SID)
      +($('rcpts').value?('&to='+encodeURIComponent($('rcpts').value)):'')
      + '&subj='+encodeURIComponent(window._SUBJ_DEFAULT||'Web Evidence')
      +'&pecMode='+encodeURIComponent(document.getElementById('pecMode').value);
    const js=await GET(q);
    if(!js.ok) throw new Error(js.error||'Errore finish');
    logLine('ZIP creato nella cartella sessione: '+js.zipName, true);
    if(js.zipUrl) logLine('Link ZIP: '+js.zipUrl);
    setUIState('finished');
  });
};
</script>
</body>
</html>
