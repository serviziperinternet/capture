/**
 * Web Evidence – v15.3.5
 * - Log client/server più dettagliati (CHECK_URL con orig/now/match nel session.log)
 * - GET/POST front-end con retry e PING iniziale (lato HTML)
 * - Asset fetch: estensioni corrette, SHA256 e finalUrl
 * - SM 1920x1240 + 1920xfull + PSI final
 * - ZIP + PEC relay (se configurato) o MailApp
 */

function doGet(e){
  ensureConfig_();
  var mode=(e && e.parameter && e.parameter.mode)||'';
  if(!mode){
    // API only (la UI è servita da GitHub Pages)
    return HtmlService.createHtmlOutput('Web Evidence API OK');
  }
  try{
    switch(mode){
      case 'cfg':      return json_(cfgOut_());
      case 'start':    return json_(start_(e));
      case 'finish':   return json_(finish_(e));
      case 'snapshot': return json_(snapshot_(e));
      case 'sm':       return json_(sm_(e));
      case 'psi':      return json_(psi_(e));
      case 'note':     return json_(note_(e));
      case 'checkUrl': return json_(checkUrl_(e));
      default:         return json_({ok:false,error:'Unknown mode'});
    }
  }catch(err){ return json_({ok:false,error:String(err)}); }
}

function doPost(e){
  ensureConfig_();
  try{
    var body = e && e.postData && e.postData.contents ? JSON.parse(e.postData.contents) : {};
    return json_(saveDataUrl_(body));
  }catch(err){ return json_({ok:false,error:String(err)}); }
}

/* ===== CONFIG ===== */
function ensureConfig_(){
  var props = PropertiesService.getScriptProperties();
  var ss = null; try{ ss = SpreadsheetApp.getActive(); }catch(_){}
  if(!ss){
    var sid = props.getProperty('CONFIG_SHEET_ID');
    if(sid){ try{ ss = SpreadsheetApp.openById(sid); }catch(_){ } }
  }
  if(!ss) return;
  var sh = ss.getSheetByName('DATA'); if(!sh) return;
  var rng = sh.getRange(1,1,Math.max(1,sh.getLastRow()),2).getDisplayValues();
  var map = {};
  for(var i=0;i<rng.length;i++){
    var k = String(rng[i][0]||'').trim().toLowerCase();
    var v = String(rng[i][1]||'').trim();
    if(!k) continue; map[k]=v;
  }
  if(map['key screenshot']) props.setProperty('SM_KEY', map['key screenshot']);
  if(map['pagespeed api key']) props.setProperty('PSI_KEY', map['pagespeed api key']);
  if(map['invio email']) props.setProperty('DEFAULT_TO', map['invio email']);
  if(map['oggetto email']) props.setProperty('DEFAULT_SUBJ', map['oggetto email']);
  if(map['dominio']) props.setProperty('DEFAULT_DOMAIN', map['dominio']);
  if(map['token']) props.setProperty('TOKEN', map['token']);
}
function cfgOut_(){
  var p = PropertiesService.getScriptProperties();
  return { ok:true,
    defaultTo:p.getProperty('DEFAULT_TO')||'',
    defaultSubj:p.getProperty('DEFAULT_SUBJ')||'Certificazione',
    defaultDomain:p.getProperty('DEFAULT_DOMAIN')||'',
    token:p.getProperty('TOKEN')||'',
    smKeyPresent:!!(p.getProperty('SM_KEY')||''),
    psiKeyPresent:!!(p.getProperty('PSI_KEY')||'') };
}

/* ===== START ===== */
function start_(e){
  var trace=[];
  var url=(e.parameter.u||'').trim();
  var client=(e.parameter.client||'').trim();
  if(!url) throw new Error('URL obbligatoria');
  if(!client) throw new Error('Cliente obbligatorio');

  var domParam=(e.parameter.domain||e.parameter.dom||'').trim();
  var host=domParam || hostOf_(url) || (PropertiesService.getScriptProperties().getProperty('DEFAULT_DOMAIN')||'') || 'unknown';

  var root=ensureRoot_(); trace.push('Root: '+root.getName());
  var ts=Utilities.formatDate(new Date(),'Europe/Rome',"yyyy-MM-dd__HH-mm-ss");
  var base=clientSan_(client)+'__'+host+'__'+ts;
  var sessName=base, n=1; while(root.getFoldersByName(sessName).hasNext()){ n++; sessName=base+'_'+n; }
  var sess=root.createFolder(sessName); trace.push('Creata cartella sessione: '+sessName+' ('+driveUrl_(sess)+')');

  var F={};
  F.info       = ensurePath_(sess,'00_istruzioni');
  F.asset_html = ensurePath_(sess,'asset/html');
  F.asset_css  = ensurePath_(sess,'asset/css');
  F.asset_js   = ensurePath_(sess,'asset/js');
  F.asset_img  = ensurePath_(sess,'asset/img');
  F.asset_video= ensurePath_(sess,'asset/video');
  F.asset_font = ensurePath_(sess,'asset/fonts');
  F.asset_other= ensurePath_(sess,'asset/other');
  F.shot_comp  = ensurePath_(sess,'shot/completi');
  F.shot_crop  = ensurePath_(sess,'shot/scatti_parziali');
  F.shot_vid   = ensurePath_(sess,'shot/video');
  F.logs       = ensurePath_(sess,'logs');
  for(var k in F){ trace.push('Cartella: '+F[k].getName()); }

  var f1=F.info.createFile('README.txt', README_TXT_(url,host,client), MimeType.PLAIN_TEXT);
  var f2=F.info.createFile('ISTRUZIONI_STRUTTURA.txt', ISTRUZIONI_TXT_(), MimeType.PLAIN_TEXT);
  var f3=F.info.createFile('FAQ_LEGALE.txt', FAQ_LEGALE_TXT_(), MimeType.PLAIN_TEXT);
  var f4=F.info.createFile('AVVISO_STREAMING.txt', AVVISO_STREAMING_TXT_(), MimeType.PLAIN_TEXT);
  trace.push('Creati: README('+f1.getSize()+'B), ISTRUZIONI('+f2.getSize()+'B), FAQ('+f3.getSize()+'B), AVVISO('+f4.getSize()+'B)');

  var manifest={ version:15.35, createdUTC:Utilities.formatDate(new Date(),'UTC',"yyyy-MM-dd'T'HH:mm:ss'Z'"),
    url:url, host:host, client:client,
    env:{ ua:e.parameter.ua||'', tz:e.parameter.tz||'', lang:e.parameter.lang||'',
      vw:e.parameter.vw||'', vh:e.parameter.vh||'', sw:e.parameter.sw||'', sh:e.parameter.sh||'',
      dpr:e.parameter.dpr||'', page:e.parameter.page||'' } };
  var mf=sess.createFile('manifest.json', JSON.stringify(manifest,null,2), MimeType.PLAIN_TEXT);
  trace.push('Creato: manifest.json ('+mf.getSize()+'B)');

  var logFile=F.logs.createFile('session.log','',MimeType.PLAIN_TEXT);
  logAppend_(logFile,'SESSION_START url='+url+' host='+host+' client='+client);
  logAppend_(logFile,'CLIENT_INFO ua='+manifest.env.ua+' tz='+manifest.env.tz+' lang='+manifest.env.lang+' vw='+manifest.env.vw+' vh='+manifest.env.vh+' sw='+manifest.env.sw+' sh='+manifest.env.sh+' dpr='+manifest.env.dpr);
  for(var i=0;i<trace.length;i++) logAppend_(logFile, trace[i]);

  return {ok:true, sessionId:sess.getId(), base:sessName, folderUrl:driveUrl_(sess), trace:trace};
}

/* ===== CHECK URL ===== */
function checkUrl_(e){
  var sid=e.parameter.sid||''; var u=(e.parameter.u||'').trim();
  if(!sid||!u) return {ok:false,error:'Missing sid/url'};
  var sess=DriveApp.getFolderById(sid);
  var it=sess.getFilesByName('manifest.json'); if(!it.hasNext()) return {ok:false,error:'Manifest non trovato'};
  var mf=JSON.parse(it.next().getBlob().getDataAsString()||'{}');
  var same=normalizeUrl_(mf.url||'')===normalizeUrl_(u);

  // LOG dettagliato del check
  try{
    var logFile=ensureLog_(sess);
    logAppend_(logFile,'CHECK_URL orig='+ (mf.url||'') +' now='+u+' match='+(same?'1':'0'));
  }catch(_){}

  return {ok:true, mismatch:!same, orig:(mf.url||''), now:u};
}
function normalizeUrl_(u){ try{ return String(u).replace(/\/+$/,''); }catch(_){ return String(u||'').replace(/\/+$/,''); } }

/* ===== FINISH ===== */
function finish_(e){
  var id=e.parameter.id; if(!id) throw new Error('Missing id');
  var sess=DriveApp.getFolderById(id);
  var logFile=ensureLog_(sess);

  logAppend_(logFile,'CALC_CHECKSUMS_START');
  var chk=computeChecksumsAll_(sess); sess.createFile('checksums.sha256.txt', chk, MimeType.PLAIN_TEXT);
  logAppend_(logFile,'CHECKSUMS_OK');

  logAppend_(logFile,'ZIP_BUILD_START');
  var zipBlob=zipFolderBlob_(sess);
  var zip=sess.createFile(zipBlob);
  logAppend_(logFile,'ZIP_OK '+zip.getName()+' size='+zip.getSize()+'B');

  var to=(e.parameter.to||PropertiesService.getScriptProperties().getProperty('DEFAULT_TO')||'').trim();
  var subj=(e.parameter.subj||PropertiesService.getScriptProperties().getProperty('DEFAULT_SUBJ')||'Certificazione');
  var pecMode=(e.parameter.pecMode||'normal');
  if(to){
    try{
      if(pecMode==='key'||pecMode==='auto'){ if(hasPECKey_()){ logAppend_(logFile,'INVIO_PEC mode=relay'); sendPECViaKey_(zip,to,subj,sess,logFile); } else { logAppend_(logFile,'INVIO_PEC mode=mailapp (fallback)'); emailZip_(zip,to,subj,logFile); } }
      else { logAppend_(logFile,'INVIO_PEC mode=mailapp'); emailZip_(zip,to,subj,logFile); }
    }catch(err){ logAppend_(logFile,'EMAIL_ERR '+err); }
  }
  logAppend_(logFile,'SESSION_END');
  return {ok:true, zipUrl:fileUrl_(zip), zipName:zip.getName()};
}

/* ===== SNAPSHOT (Scarica asset) ===== */
function snapshot_(e){
  var id=e.parameter.id, url=(e.parameter.u||''); if(!id||!url) return {ok:false,error:'Missing id/url'};
  var sess=DriveApp.getFolderById(id), logFile=ensureLog_(sess);
  try{
    var rep=fetchAssetsAll_(url, sess, logFile);
    logAppend_(logFile, 'SNAPSHOT_SUMMARY found='+rep.found+' saved='+rep.count+' skipped='+rep.skipped+' errors='+rep.errors);
    return {ok:true, assets:true, count:rep.count};
  }catch(err){ logAppend_(logFile, 'SNAPSHOT_ERR '+err); return {ok:false,error:String(err)}; }
}

/* ===== SM / PSI ===== */
function sm_(e){
  var url=(e.parameter.u||''); if(!url) return {ok:false,error:'Missing url'};
  var dim=(e.parameter.dim||'1920xfull'); var data=smFetch_(url,dim);
  return {ok:true, dataUrl:data.dataUrl, meta:{provider:'screenshotmachine',dimension:dim}};
}
function psi_(e){
  var url=(e.parameter.u||''); if(!url) return {ok:false,error:'Missing url'};
  var key=PropertiesService.getScriptProperties().getProperty('PSI_KEY')||''; if(!key) return {ok:false,error:'PSI key mancante'};
  var api='https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url='+encodeURIComponent(url)+'&category=PERFORMANCE&strategy=DESKTOP&key='+encodeURIComponent(key);
  var r=UrlFetchApp.fetch(api,{followRedirects:true,muteHttpExceptions:true});
  var code=r.getResponseCode(); if(code>=400) return {ok:false,error:'PSI HTTP '+code};
  var o=JSON.parse(r.getContentText()); var dataUrl=''; try{ dataUrl=o.lighthouseResult.audits['final-screenshot'].details.data||''; }catch(_){}
  if(!dataUrl) return {ok:false,error:'No final-screenshot'}; return {ok:true,dataUrl:dataUrl,meta:{provider:'psi'}};
}
function smFetch_(url,dim){
  var key=PropertiesService.getScriptProperties().getProperty('SM_KEY'); if(!key) throw new Error('SM_KEY mancante (DATA → "Key screenshot")');
  var base=PropertiesService.getScriptProperties().getProperty('SM_BASE')||'https://api.screenshotmachine.com';
  var q=base+'?key='+encodeURIComponent(key)+'&url='+encodeURIComponent(url)+'&dimension='+encodeURIComponent(dim)+'&cacheLimit=0&format=png';
  var r=UrlFetchApp.fetch(q,{followRedirects:true,muteHttpExceptions:true});
  var ct=r.getHeaders()['Content-Type']||''; if(ct.indexOf('image')===-1) throw new Error('SM non-image: '+r.getContentText());
  var b=r.getBlob(); var b64=Utilities.base64Encode(b.getBytes());
  return {dataUrl:'data:'+ct+';base64,'+b64};
}

/* ===== NOTE / SAVE ===== */
function note_(e){
  var id=e.parameter.id; if(!id) return {ok:false};
  var sess=DriveApp.getFolderById(id), logFile=ensureLog_(sess);
  var msg=(e.parameter.msg||''); logAppend_(logFile, msg); return {ok:true};
}

function saveDataUrl_(body){
  var sid=body.sid, dataUrl=body.dataUrl; if(!sid||!dataUrl) return {ok:false,error:'Missing sid/dataUrl'};
  var sess=DriveApp.getFolderById(sid), logFile=ensureLog_(sess);
  var meta=body.meta||{}; var isVideo = dataUrl.startsWith('data:video');

  var sourceUrl = String(meta.url||'').trim();
  var resolved = sourceUrl ? resolveFinalUrlOnly_(sourceUrl) : {finalUrl:''};

  var blob=dataUrlToBlob_(dataUrl);
  var label=(meta.sourceMeta&&meta.sourceMeta.label)|| (isVideo?'video':'shot');
  var ext=isVideo?'.webm':'.png';
  var subPath = pickShotPath_(label, isVideo);
  var folder=ensurePath_(sess, subPath);
  var name=ts_()+'__'+label+ext; blob.setName(name);
  var file=folder.createFile(blob);
  var sha=sha256Hex_(file.getBlob().getBytes());

  logAppend_(logFile,'SAVE_OK type='+(isVideo?'video':'image')+' path='+subPath+'/'+name+' sha='+sha+' url='+sourceUrl+' final='+resolved.finalUrl);
  return {ok:true,name:name,sha256:sha,url:fileUrl_(file),finalUrl:resolved.finalUrl};
}
function pickShotPath_(label, isVideo){
  if(isVideo) return 'shot/video';
  if(/^SM_|^PSI_/i.test(label)) return 'shot/completi';
  if(/FRAME_FULL/i.test(label)) return 'shot/completi';
  if(/FRAME_CROP/i.test(label)) return 'shot/scatti_parziali';
  return 'shot/completi';
}

/* ===== ASSET FETCH ===== */
function fetchAssetsAll_(pageUrl, sess, logFile){
  var res0 = UrlFetchApp.fetch(pageUrl, {followRedirects:true, muteHttpExceptions:true, validateHttpsCertificates:true});
  var html = res0.getContentText();
  ensurePath_(sess,'asset/html').createFile('page.html', html, MimeType.HTML);
  logAppend_(logFile,'ASSET_HTML_SAVED size='+html.length);
  var base = pageUrl;

  var urls = [];
  function add(u){
    try{
      if(!u||/^data:/i.test(u)) return;
      var abs=resolveUrl_(base,u);
      if(abs){ urls.push(abs); }
    }catch(e){}
  }

  html.replace(/<img\b[^>]*?(?:src|data-src|data-original|data-lazy)=["']([^"']+)["'][^>]*>/gi, function(_,u){ add(u); return _; });
  html.replace(/<img\b[^>]*?srcset=["']([^"']+)["'][^>]*>/gi, function(_,set){ set.split(',').forEach(function(p){ var u=(p.trim().split(/\s+/)[0]||''); add(u); }); return _; });
  html.replace(/<link\b[^>]*rel=["'][^"']*stylesheet[^"']*["'][^>]*href=["']([^"']+)["'][^>]*>/gi, function(_,u){ add(u); return _; });
  html.replace(/<script\b[^>]*src=["']([^"']+)["'][^>]*><\/script>/gi, function(_,u){ add(u); return _; });
  html.replace(/<(?:video|audio)\b[^>]*src=["']([^"']+)["'][^>]*>/gi, function(_,u){ add(u); return _; });
  html.replace(/<source\b[^>]*src=["']([^"']+)["'][^>]*>/gi, function(_,u){ add(u); return _; });

  var styleBlocks=html.match(/<style[^>]*>([\s\S]*?)<\/style>/gi)||[];
  styleBlocks.forEach(function(b){
    var css=b.replace(/^<style[^>]*>|<\/style>$/gi,'');
    extractUrlsFromCss_(css, base).forEach(add);
  });

  logAppend_(logFile, 'ASSET_FOUND '+urls.length+' url');

  var saved=0, skipped=0, errors=0;
  function fetchAndSave(u){
    try{
      if(/(?:youtube\.com|youtu\.be|vimeo\.com|player\.vimeo\.com|dailymotion\.com)/i.test(u)){
        skipped++; logAppend_(logFile, 'ASSET_SKIP_STREAM url='+u); return;
      }
      var fr = fetchFollowBinary_(u); // {bytes, ct, finalUrl, headers, code}
      if(fr.code>=400){ errors++; logAppend_(logFile,'ASSET_ERR HTTP '+fr.code+' url='+u); return; }

      var ext = extFromMime_(fr.ct) || sniffExt_(fr.bytes) || extFromDispositionOrUrl_(fr.headers, fr.finalUrl) || '.bin';
      var sha = sha256Hex_(fr.bytes);
      var fname = baseNameFromUrl_(fr.finalUrl||u, 'asset_'+('0000'+(saved+1)).slice(-4)+'_'+sha.slice(0,8)+ext, ext);

      var blob = Utilities.newBlob(fr.bytes, fr.ct||contentTypeFromExt_(ext), fname);

      var dest = 'asset/other';
      if(/\.(png|jpe?g|gif|webp|svg)$/i.test(ext)) dest='asset/img';
      else if(/\.css$/i.test(ext)) dest='asset/css';
      else if(/\.js$/i.test(ext)) dest='asset/js';
      else if(/\.(woff2?|ttf|otf|eot)$/i.test(ext)) dest='asset/fonts';
      else if(/\.(mp4|webm|ogg|mp3|wav|m4a)$/i.test(ext)) dest='asset/video';

      var savedFile = ensurePath_(sess, dest).createFile(blob);
      saved++;
      logAppend_(logFile, 'ASSET_OK dest='+dest+' name='+fname+' ct='+(fr.ct||'?')+' size='+fr.bytes.length+' sha='+sha+' url='+u+' final='+fr.finalUrl);

      if(/\.css$/i.test(ext)){
        try{
          var cssText = savedFile.getBlob().getDataAsString();
          var more = extractUrlsFromCss_(cssText, fr.finalUrl||u);
          if(more && more.length){
            logAppend_(logFile, 'ASSET_CSS_FOUND '+more.length+' refs in '+fname);
            more.forEach(function(mu){ fetchAndSave(mu); });
          }
        }catch(errCss){ logAppend_(logFile, 'ASSET_CSS_PARSE_ERR '+String(errCss).slice(0,150)+' file='+fname); }
      }
    }catch(err){
      errors++; logAppend_(logFile, 'ASSET_ERR EXC '+String(err).slice(0,200)+' url='+u);
    }
  }

  urls.forEach(fetchAndSave);
  if(skipped){ logAppend_(logFile, 'ASSET_SKIPPED streaming-hosts='+skipped); }
  return {found:urls.length, count:saved, skipped:skipped, errors:errors};
}

/* ===== helper redirect/bytes ===== */
function resolveFinalUrlOnly_(u){
  var max=10, cur=u;
  for(var i=0;i<max;i++){
    var r=UrlFetchApp.fetch(cur,{muteHttpExceptions:true,followRedirects:false,validateHttpsCertificates:true});
    var c=r.getResponseCode();
    if(c>=300 && c<400){
      var loc=(r.getHeaders()['Location']||r.getHeaders()['location']||'').trim(); if(!loc) break;
      cur=resolveUrl_(cur,loc); continue;
    }
    break;
  }
  return {finalUrl:cur};
}
function fetchFollowBinary_(u){
  var max=10, cur=u, lastR=null;
  for(var i=0;i<max;i++){
    var r=UrlFetchApp.fetch(cur,{muteHttpExceptions:true,followRedirects:false,validateHttpsCertificates:true});
    lastR=r;
    var c=r.getResponseCode();
    if(c>=300 && c<400){
      var loc=(r.getHeaders()['Location']||r.getHeaders()['location']||'').trim();
      if(!loc) break;
      cur=resolveUrl_(cur,loc);
      continue;
    }
    break;
  }
  var bytes=lastR.getBlob().getBytes();
  var ct=lastR.getHeaders()['Content-Type']||'';
  return {bytes:bytes, ct:ct, finalUrl:cur, headers:lastR.getHeaders(), code:lastR.getResponseCode()};
}

/* ===== ISTRUZIONI ===== */
function README_TXT_(url,host,client){
  return [
'WEB EVIDENCE — GUIDA (v15.3.5)',
'URL iniziale: '+url,
'Dominio: '+host,
'Cliente: '+client,
'',
'PASSI:',
'1) Inizia certificazione (blocca URL/Cliente, crea struttura).',
'2) Apri sito in finestra → Condividi.',
'3) Cattura full page (SM 1920×1240 + SM full + PSI final).',
'4) Scatta → Salva (crop opzionale).',
'5) REC → STOP (video webm).',
'6) Scarica asset (html/css/js/img/fonts/video). Log per-URL con SHA e finalUrl.',
'7) Termina (SHA256 + ZIP + invio PEC/email).',
'',
'Antimanomissione: ad ogni operazione verifichiamo l’URL rispetto al manifest. La URL della tab condivisa non è accessibile via API: usiamo blocco URL + log + hash.'
  ].join('\n');
}
function ISTRUZIONI_TXT_(){
  return [
'STRUTTURA CARTELLE',
'asset/html   → HTML sorgente',
'asset/css    → CSS esterni (segue url() e @import)',
'asset/js     → JavaScript esterni',
'asset/img    → Immagini (png/jpg/webp/svg, …)',
'asset/fonts  → Webfont (woff/woff2/ttf/otf/eot)',
'asset/video  → Media diretti (mp4/webm/ogg, …)',
'asset/other  → Altri file',
'shot/completi         → Screenshot completi (SM/PSI + frame intero)',
'shot/scatti_parziali  → Ritagli/fence',
'shot/video            → Registrazioni schermo (webm)',
'logs/                 → Registri (session.log con SHA + URL finali + CHECK_URL)'
  ].join('\n');
}
function FAQ_LEGALE_TXT_(){
  return [
'FAQ LEGALI',
'Q) Come provate la pagina?','A) URL iniziale nel manifest; prima di ogni azione eseguiamo checkUrl. Se cambia, blocco + log.',
'Q) Integrità?','A) SHA256 per ogni file; elenco checksums + ZIP.',
'Q) Perché non verificate la URL della tab condivisa?','A) Le API di cattura non espongono l’URL della tab. Per questo vincoliamo l’URL inserita, logghiamo ogni check e alleghiamo hash.'
  ].join('\n');
}
function AVVISO_STREAMING_TXT_(){
  return [
'AVVISO STREAMING',
'Contenuti da piattaforme streaming (YouTube/Vimeo/Dailymotion) non vengono scaricati (TOS).',
'Gli asset diretti con URL pubblico vengono archiviati con estensione corretta, SHA e URL finale.'
  ].join('\n');
}

/* ===== UTILITY ===== */
function ensureRoot_(){ var rootName = PropertiesService.getScriptProperties().getProperty('ROOT_FOLDER') || 'WebEvidence'; var it = DriveApp.getFoldersByName(rootName); return it.hasNext()? it.next() : DriveApp.createFolder(rootName); }
function ensureLog_(sess){ var it=ensurePath_(sess,'logs').getFilesByName('session.log'); return it.hasNext()? it.next() : ensurePath_(sess,'logs').createFile('session.log','',MimeType.PLAIN_TEXT); }
function getChildFolder_(root, name){ var it=root.getFoldersByName(name); return it.hasNext()? it.next() : root.createFolder(name); }
function ensurePath_(root, path){ var parts=String(path).split('/'); var cur=root; for(var i=0;i<parts.length;i++){ if(!parts[i]) continue; cur=getChildFolder_(cur, parts[i]); } return cur; }
function driveUrl_(folder){ return 'https://drive.google.com/drive/folders/'+folder.getId(); }
function fileUrl_(file){ return 'https://drive.google.com/file/d/'+file.getId()+'/view'; }
function json_(obj){ return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON); }
function ts_(){ return Utilities.formatDate(new Date(),'UTC',"yyyyMMdd'T'HHmmss'Z'"); }
function hostOf_(u){ try{ return String(u).replace(/^[a-z]+:\/\//i,'').split('/')[0].replace(/^www\./,''); }catch(e){ return ''; } }
function clientSan_(s){ return String(s||'').replace(/[^a-z0-9._-]+/gi,'_').slice(0,80) || 'client'; }
function sha256Hex_(bytes){ var dig=Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, bytes); return dig.map(function(b){return ('0'+(b&255).toString(16)).slice(-2)}).join(''); }
function logAppend_(logFile, line){ var ex=''; try{ ex=logFile.getBlob().getDataAsString(); }catch(_){}
  logFile.setContent(ex+'['+Utilities.formatDate(new Date(),'Europe/Rome','HH:mm:ss')+'] '+line+'\n'); }
function dataUrlToBlob_(dataUrl){ var comma=dataUrl.indexOf(','); var meta=dataUrl.substring(5,comma); var b64=dataUrl.substring(comma+1); var bytes=Utilities.base64Decode(b64); var ct=meta.split(';')[0]||'application/octet-stream'; return Utilities.newBlob(bytes, ct, 'file'); }
function computeChecksumsAll_(folder){
  var out=[], it=folder.getFiles();
  while(it.hasNext()){ var f=it.next(); var sha=sha256Hex_(f.getBlob().getBytes()); out.push(sha+'  '+f.getName()); }
  var fit=folder.getFolders();
  while(fit.hasNext()){ var sub=fit.next(); var subTxt=computeChecksumsAll_(sub); if(subTxt){ out.push(subTxt); } }
  return out.join('\n');
}
function zipFolderBlob_(folder){
  var blobs=[], seen={};
  function unique(name){ if(!seen[name]){ seen[name]=1; return name; }
    var i=++seen[name]; var p=name.lastIndexOf('/'); var dir=p>=0?name.slice(0,p+1):''; var base=p>=0?name.slice(p+1):name;
    var dot=base.lastIndexOf('.'); var b0=dot>=0?base.slice(0,dot):base; var ext=dot>=0?base.slice(dot):''; return dir+b0+' ('+i+')'+ext; }
  function walk(f, pref){
    var itf=f.getFiles(); while(itf.hasNext()){ var file=itf.next(); var b=file.getBlob(); var name=pref+file.getName(); b.setName(unique(name)); blobs.push(b); }
    var it=f.getFolders(); while(it.hasNext()){ var sub=it.next(); walk(sub, pref+sub.getName()+'/'); }
  }
  walk(folder, folder.getName()+'/'); return Utilities.zip(blobs, folder.getName()+'.zip');
}
function resolveUrl_(base, href){
  href=String(href||'').trim(); base=String(base||'').trim(); if(!href) return '';
  if(/^[a-z]+:\/\//i.test(href)) return href;
  if(/^\/\//.test(href)){ var proto=(base.match(/^([a-z]+):/i)||['http:'])[0]; return proto+href; }
  var m=base.match(/^([a-z]+):\/\/([^\/?#]+)(\/[^?#]*)?/i); if(!m) return href;
  var proto=m[1]+'://', host=m[2], path=m[3]||'/';
  if(href[0]==='/') return proto+host+href;
  var dir=path.replace(/[^\/]*$/,''); var full=proto+host+dir+href;
  var seg=full.split('/'), out=[]; for(var i=0;i<seg.length;i++){ var p=seg[i]; if(p==='..'){ if(out.length>3) out.pop(); } else if(p==='.' || (p===''&&i>2)){} else out.push(p); }
  var result=out.join('/'); if(!/^https?:\/\//i.test(result)) result=proto+host+'/'+out.slice(3).join('/'); return result;
}
function baseNameFromUrl_(u, fallback, ext){
  try{
    var p=decodeURIComponent(u.split('#')[0].split('?')[0]); var seg=p.split('/'); var last=seg[seg.length-1]||'';
    if(!last){ return fallback; }
    if(ext && last.toLowerCase().endsWith(ext.toLowerCase())) return last;
    return last + (ext||'');
  }catch(_){ return fallback; }
}
function extFromDispositionOrUrl_(headers, url){
  try{
    var cd=headers['Content-Disposition']||headers['content-disposition']||'';
    var m=cd.match(/filename\*?=(?:UTF-8'')?"?([^";]+)"?/i);
    if(m){ var fn=m[1]; var me=fn.match(/\.([a-z0-9]+)$/i); if(me) return '.'+me[1].toLowerCase(); }
  }catch(_){}
  var m2=String(url||'').toLowerCase().match(/\.([a-z0-9]+)(?:\?|#|$)/);
  return m2?('.'+m2[1]):'';
}
function contentTypeFromExt_(ext){
  ext=(ext||'').toLowerCase();
  var map={'.png':'image/png','.jpg':'image/jpeg','.jpeg':'image/jpeg','.gif':'image/gif','.webp':'image/webp','.svg':'image/svg+xml','.css':'text/css','.js':'application/javascript','.woff':'font/woff','.woff2':'font/woff2','.ttf':'font/ttf','.otf':'font/otf','.eot':'application/vnd.ms-fontobject','.mp4':'video/mp4','.webm':'video/webm','.ogg':'video/ogg','.mp3':'audio/mpeg','.wav':'audio/wav','.m4a':'audio/mp4'};
  return map[ext]||'application/octet-stream';
}
function sniffExt_(bytes){
  if(!bytes||!bytes.length) return '';
  function starts(arr){ for(var i=0;i<arr.length;i++){ if(bytes[i]!==arr[i]) return false; } return true; }
  try{
    if(starts([0x89,0x50,0x4E,0x47])) return '.png';
    if(starts([0xFF,0xD8,0xFF])) return '.jpg';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='GIF8') return '.gif';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='RIFF' && String.fromCharCode(bytes[8],bytes[9],bytes[10],bytes[11])==='WEBP') return '.webp';
    var head = Utilities.newBlob(bytes.slice(0,64)).getDataAsString();
    if(/^<\?xml|^\s*<svg/i.test(head)) return '.svg';
    if(String.fromCharCode(bytes[4],bytes[5],bytes[6],bytes[7])==='ftyp') return '.mp4';
    if(starts([0x1A,0x45,0xDF,0xA3])) return '.webm';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2])==='ID3' || (bytes[0]===0xFF && (bytes[1]&0xE0)===0xE0)) return '.mp3';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='OggS') return '.ogg';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='RIFF' && String.fromCharCode(bytes[8],bytes[9],bytes[10],bytes[11])==='WAVE') return '.wav';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='wOFF') return '.woff';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='wOF2') return '.woff2';
    if(bytes[0]===0x00 && bytes[1]===0x01 && bytes[2]===0x00 && bytes[3]===0x00) return '.ttf';
    if(String.fromCharCode(bytes[0],bytes[1],bytes[2],bytes[3])==='OTTO') return '.otf';
  }catch(_){}
  return '';
}

/* ===== EMAIL / PEC ===== */
function emailZip_(zipFile,to,subj,logFile){
  try{
    var name=PropertiesService.getScriptProperties().getProperty('MAIL_FROM_NAME')||'Web Evidence';
    MailApp.sendEmail({to:to,subject:subj,name:name,body:'Pacchetto prove: '+fileUrl_(zipFile),attachments:[zipFile.getBlob()]});
    logAppend_(logFile,'EMAIL_OK to='+to);
  }catch(err){ logAppend_(logFile,'EMAIL_ERR '+err); throw err; }
}
function hasPECKey_(){ var p=PropertiesService.getScriptProperties(); return !!(p.getProperty('PEC_ENDPOINT')&&p.getProperty('PEC_KEY')&&p.getProperty('PEC_SENDER')); }
function sendPECViaKey_(zipFile,to,subj,sess,logFile){
  var p=PropertiesService.getScriptProperties();
  var endpoint=p.getProperty('PEC_ENDPOINT')||'', apiKey=p.getProperty('PEC_KEY')||'', sender=p.getProperty('PEC_SENDER')||'', fromName=p.getProperty('PEC_FROM_NAME')||'Web Evidence';
  if(!endpoint||!apiKey||!sender) throw new Error('PEC_ENDPOINT/PEC_KEY/PEC_SENDER non configurati');
  var payload={ from:sender, to:to.split(',').map(function(s){return s.trim();}).filter(String),
    subject:subj, html:'<p>Web Evidence – Bundle: '+sess.getName()+'</p><p>ZIP: '+fileUrl_(zipFile)+'</p>',
    attachments:[{ filename:zipFile.getName(), contentType:'application/zip', content:Utilities.base64Encode(zipFile.getBlob().getBytes()) }] };
  var r=UrlFetchApp.fetch(endpoint,{method:'post',muteHttpExceptions:true,contentType:'application/json',headers:{'Authorization':'Bearer '+apiKey,'X-From-Name':fromName},payload:JSON.stringify(payload)});
  var code=r.getResponseCode(); logAppend_(logFile,'PEC_HTTP '+code+' endpoint='+endpoint);
  if(code>=400) throw new Error('PEC API HTTP '+code+': '+r.getContentText().slice(0,300));
}
