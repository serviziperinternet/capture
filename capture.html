<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence</title>
<style>
  :root{--bd:#ddd;--ok:#18a957;--danger:#e11d48;--mut:#666}
  *{box-sizing:border-box}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0;color:#111;background:#fff}
  header{padding:10px;border-bottom:1px solid #eee}
  .hrow{display:grid;gap:8px;align-items:center}
  .row1{grid-template-columns:170px 1fr auto}
  .row2{grid-template-columns:auto auto 220px 1fr}
  input,button,select{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fafafa}
  input[type="url"],input[type="text"]{background:#fff}
  .success{background:var(--ok)!important;border-color:var(--ok)!important;color:#fff}
  .danger{background:var(--danger)!important;border-color:var(--danger)!important;color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .card{border:1px solid #eee;border-radius:12px;background:#fff}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #f3f4f4;font-size:13px;font-weight:700}
  .side{padding:12px}
  #thumb{width:300px;height:300px;display:block;background:#000;border:1px dashed #ccc;border-radius:10px}
  .mut{color:var(--mut)}
  .controls{display:flex;flex-direction:column;gap:10px;padding:12px}
  .controls .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .dim{opacity:.6}
  #logWrap{padding:0 12px 12px}
  #logBox{height:250px;border:1px solid #eee;border-radius:10px;padding:10px;overflow:auto;font:12px/1.55 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}
  .capCard{grid-column:2}
  .cap-wrap{position:relative;padding:12px;overflow:auto;border-top:1px solid #f3f4f6;min-height:360px}
  #imgLarge{max-width:100%;display:none;border-radius:12px;border:1px solid #eee;background:#000}
  #imgLarge.hasSrc{display:block}
  #rect{position:absolute;border:2px dashed #fff;display:none;pointer-events:none}
</style>
</head>
<body>
<header>
  <div class="hrow row1">
    <input id="client" placeholder="Cliente…" />
    <input id="addr" type="url" placeholder="https://…" />
    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
      <button id="btnStart" class="success" type="button">Inizia certificazione</button>
      <button id="btnFinish" class="danger" type="button" style="display:none">Termina certificazione</button>
    </div>
  </div>
  <div class="hrow row2" style="margin-top:8px">
    <button id="btnOpen" type="button" disabled class="dim" style="display:none">Apri sito in finestra</button>
    <button id="btnShare" type="button" disabled class="dim" style="display:none">Condividi</button>
    <select id="pecMode" title="Modalità invio PEC">
      <option value="normal" selected>PEC normale</option>
      <option value="key">PEC via KEY</option>
      <option value="auto">PEC auto</option>
    </select>
    <input id="rcpts" placeholder="Destinatari PEC/email (virgola per più indirizzi)" />
  </div>
</header>

<div class="wrap">
  <div class="card side">
    <h3>Anteprima LIVE (300×300)</h3>
    <canvas id="thumb" width="300" height="300" aria-label="Anteprima"></canvas>
    <div class="mut" style="margin-top:8px">1) Inizia → 2) Apri → 3) Condividi</div>
  </div>

  <div class="card">
    <h3>Controlli</h3>
    <div class="controls" id="controlsBox">
      <div class="row">
        <button id="btnFull" type="button" disabled class="dim">Cattura full page</button>
        <button id="btnAssets" type="button" disabled class="dim">Scarica asset</button>
      </div>
      <div class="row">
        <button id="btnSnap" type="button" disabled class="dim">Scatta</button>
        <button id="btnSave" type="button" disabled class="dim">Salva</button>
        <button id="btnRec" type="button" disabled class="dim">REC</button>
        <button id="btnStop" type="button" disabled class="dim">STOP</button>
      </div>
    </div>
    <div id="logWrap">
      <h3 style="border:none;padding:6px 0 6px 0;margin:0">Log</h3>
      <div id="logBox"></div>
    </div>
  </div>

  <div class="card capCard">
    <h3>Finestra di cattura (scatto)</h3>
    <div class="cap-wrap" id="capWrap">
      <img id="imgLarge" alt="Scatto"/>
      <div id="rect"></div>
    </div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
function logLine(s, important=false){ const L=$('logBox'); const entry='['+(new Date().toLocaleTimeString())+'] '+s+(important?'\n':''); L.textContent=entry+'\n'+L.textContent; L.scrollTop=0; }
function enable(el,on){ el.disabled=!on; el.classList.toggle('dim', !on); }
const sleep = ms => new Promise(r=>setTimeout(r,ms));

/* === Query === */
const qs=new URLSearchParams(location.search);
let APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
if(qs.get('u')) $('addr').value=qs.get('u');
if(qs.get('client')) $('client').value=qs.get('client');
if(qs.get('dom')) $('client').dataset.domain=qs.get('dom');
if(qs.get('domain')) $('client').dataset.domain=qs.get('domain');
if(qs.get('to')) $('rcpts').value=qs.get('to');
if(qs.get('pec')) $('pecMode').value=qs.get('pec');
if (APP && APP.indexOf('/a/macros/') >= 0) { logLine('ATTENZIONE: endpoint /a/macros/ → correggo in /macros/'); APP = APP.replace('/a/macros/','/macros/'); }

/* === Stato === */
let SID='', stream=null, rafId=null, hasShot=false, shareActive=false, recording=false;
let recorder=null, recChunks=[];
const video=document.createElement('video'); video.autoplay=true; video.muted=true; video.playsInline=true;
const thumb=$('thumb'), imgLarge=$('imgLarge'), rect=$('rect'), capWrap=$('capWrap');

/* === fetch helpers === */
async function GET(q){
  const url = APP+(APP.includes('?')?'&':'?')+q;
  logLine('REQ → '+url);
  const r=await fetch(url,{cache:'no-store'});
  if(!r.ok){ logLine('HTTP '+r.status+' ← '+url, true); throw new Error('HTTP '+r.status); }
  logLine('HTTP '+r.status+' ← '+url);
  return r.json();
}
async function POST(b){
  const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(b)});
  if(!r.ok){ logLine('HTTP '+r.status+' ← POST', true); throw new Error('HTTP '+r.status); }
  return r.json();
}

/* === UI state/busy === */
let BUSY=false, PREV_STATE=null;
function snapshotUIState(){ return {full:!$('btnFull').disabled, assets:!$('btnAssets').disabled, snap:!$('btnSnap').disabled, save:!$('btnSave').disabled, rec:!$('btnRec').disabled, stop:!$('btnStop').disabled, open:($('btnOpen').style.display!=='none' && !$('btnOpen').disabled), share:($('btnShare').style.display!=='none' && !$('btnShare').disabled), finish:($('btnFinish').style.display!=='none' && !$('btnFinish').disabled)};}
function setUIState(state){
  if(state==='idle'){ enable($('btnFull'), false); enable($('btnAssets'), false); enable($('btnSnap'), false); enable($('btnSave'), false); enable($('btnRec'), false); enable($('btnStop'), false); $('btnOpen').style.display='none'; $('btnShare').style.display='none'; }
  if(state==='started'){ $('btnOpen').style.display='inline-block'; enable($('btnOpen'), true); $('btnShare').style.display='none'; enable($('btnFull'), true); enable($('btnAssets'), true); enable($('btnSnap'), false); enable($('btnSave'), false); enable($('btnRec'), false); enable($('btnStop'), false); }
  if(state==='shared'){ enable($('btnFull'), true); enable($('btnAssets'), true); enable($('btnSnap'), true); enable($('btnSave'), hasShot); enable($('btnRec'), !recording); enable($('btnStop'), recording); }
  if(state==='recording'){ enable($('btnFull'), false); enable($('btnAssets'), false); enable($('btnSnap'), false); enable($('btnSave'), false); enable($('btnRec'), false); enable($('btnStop'), true); }
  if(state==='locked'){ enable($('btnSnap'), false); enable($('btnSave'), false); enable($('btnFull'), true); enable($('btnAssets'), true); enable($('btnRec'), false); enable($('btnStop'), false); }
  if(state==='finished'){ document.querySelectorAll('button').forEach(b=> b.disabled=true); }
}
async function withBusy(label, fn, opts){
  const restore=!(opts&&opts.restore===false);
  if(BUSY){ logLine('ATTESA PER: '+BUSY); return; }
  BUSY=label; PREV_STATE=snapshotUIState();
  document.querySelectorAll('button').forEach(b=> b.disabled=true);
  logLine('ATTESA PER: '+label, true);
  try{ const res=await fn(); logLine('PRONTO: '+label, true); return res; }
  catch(e){ logLine('ERRORE in '+label+': '+(e.message||e), true); }
  finally{
    BUSY=false;
    if(restore && PREV_STATE){
      enable($('btnFull'), !!PREV_STATE.full); enable($('btnAssets'), !!PREV_STATE.assets); enable($('btnSnap'), !!PREV_STATE.snap);
      enable($('btnSave'), !!PREV_STATE.save); enable($('btnRec'), !!PREV_STATE.rec); enable($('btnStop'), !!PREV_STATE.stop);
      if($('btnOpen').style.display!=='none') $('btnOpen').disabled=!PREV_STATE.open;
      if($('btnShare').style.display!=='none') $('btnShare').disabled=!PREV_STATE.share;
      if($('btnFinish').style.display!=='none') $('btnFinish').disabled=!PREV_STATE.finish;
    }
  }
}

/* === anteprima 300×300 === */
function drawPreview(){
  const ctx=thumb.getContext('2d'); const tw=thumb.width, th=thumb.height;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,tw,th);
  if(!(video.videoWidth && video.videoHeight)){ rafId=requestAnimationFrame(drawPreview); return; }
  const vw=video.videoWidth, vh=video.videoHeight; const br=vw/vh; let dw=tw, dh=tw/br; if(dh>th){ dh=th; dw=th*br; } const dx=(tw-dw)/2, dy=(th-dh)/2;
  ctx.drawImage(video, dx, dy, dw, dh); rafId=requestAnimationFrame(drawPreview);
}
(function(){ if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview); setUIState('idle'); logLine('BOOT — app='+(APP?'OK':'KO')+', token='+(TOKEN?'OK':'KO')); })();

/* === start === */
$('btnStart').onclick = async ()=>{
  if(SID){ logLine('Sessione già attiva.'); return; }
  const cli=$('client').value.trim(), url=($('addr').value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!url){ alert('URL obbligatoria'); return; }
  $('btnStart').style.opacity=.5; $('btnStart').disabled=true;
  $('addr').readOnly=true; $('addr').disabled=true; $('client').readOnly=true; $('client').disabled=true;
  logLine('Avvio certificazione…');
  await withBusy('Avvio certificazione', async ()=>{
    const host= ($('client').dataset.domain||'') || (new URL(url)).hostname.replace(/^www\./,'');
    const js=await GET('mode=start'
      +'&t='+encodeURIComponent(TOKEN||'')
      +'&u='+encodeURIComponent(url)
      +'&client='+encodeURIComponent(cli)
      +'&domain='+encodeURIComponent(host)
      +'&ua='+encodeURIComponent(navigator.userAgent||'')
      +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
      +'&lang='+encodeURIComponent(navigator.language||'')
      +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1));
    if(!js.ok) throw new Error(js.error||'Errore avvio');
    SID=js.sessionId;
    const now=new Date(), pad=n=>('0'+n).slice(-2);
    window._SUBJ_DEFAULT='Web Evidence – '+cli+' – '+host+' – '+now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+' '+pad(now.getHours())+':'+pad(now.getMinutes());
    logLine('SESSIONE: '+js.base+(js.folderUrl?(' → '+js.folderUrl):''), true);
    if(js.trace) js.trace.forEach(t=>logLine(t));
    $('btnStart').style.display='none'; $('btnFinish').style.display='inline-block'; $('btnFinish').disabled=false;
    setUIState('started');
  }, {restore:false});
};

/* === apri + condividi === */
$('btnOpen').onclick = ()=>{
  const url=($('addr').value||'').trim(); if(!url){ alert('URL obbligatoria'); return; }
  window.open(url, '_we_clean_'+Date.now(), 'noopener,noreferrer,width=1280,height=900,menubar=no,toolbar=no,location=no,status=no');
  logLine('Finestra/pagina aperta.');
  $('btnOpen').style.display='none'; $('btnShare').style.display='inline-block'; enable($('btnShare'), true);
};
$('btnShare').onclick = async ()=>{
  await withBusy('Condivisione schermo', async ()=>{
    const s = await navigator.mediaDevices.getDisplayMedia({video:{frameRate:30,displaySurface:'browser',preferCurrentTab:true},audio:false});
    stream = s; video.srcObject = s;
    await new Promise(r=>video.addEventListener('loadeddata', r, {once:true})); await video.play();
    if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview);
    shareActive=true; logLine('Condivisione attiva (anteprima a sinistra).', true);
    const vt = s.getVideoTracks()[0];
    vt.addEventListener('ended', ()=>{ logLine('Condivisione terminata. Scatto/REC disattivati per questa sessione.', true); shareActive=false; recording=false; setUIState('locked'); });
    setUIState('shared'); $('btnShare').disabled=true; $('btnShare').classList.add('dim');
  }, {restore:false});
};

/* === verifica URL via helper GET (stessa pipeline di start) === */

async function verifyUrlOrStop(){
  const rawU = (document.getElementById('addr').value || '').trim();
  const q = 'mode=checkUrl&sid='+encodeURIComponent(SID)+'&u='+encodeURIComponent(rawU);

  // (se usi già il mio GET “robusto”, va bene; altrimenti lascialo com’è)
  try{
    const js = await GET(q);
    if(!js || js.ok !== true){
      logLine('CHKURL ERR: risposta non OK dal server', true);
      return false;
    }
    // Log super esplicito:
    logLine('CHKURL ORIG(raw) = '+js.orig);
    logLine('CHKURL NOW (raw) = '+js.now);
    logLine('CHKURL ORIG(norm)= '+js.origNorm);
    logLine('CHKURL NOW (norm)= '+js.nowNorm);

    if(js.mismatch){
      const diffs = Object.keys(js.diff || {}).filter(k => js.diff[k]);
      logLine('URL DIVERGENTE — PARTI DIVERSE: '+(diffs.join(', ')||'(?)'), true);
      return false;
    }

    logLine('Verifica URL OK — combaciano (norm)');
    return true;
  }catch(e){
    // qui NON è mismatch: è errore rete/CORS
    logLine('CHKURL ERR: '+(e && e.message ? e.message : e), true);
    return false;
  }
}



/* === full page (SM + SM full + PSI) — con sid per enforcement server === */
$('btnFull').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=($('addr').value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  await withBusy('Cattura full page', async ()=>{
    let ok = await verifyUrlOrStop();
    if(ok === false) throw new Error('Verifica URL fallita');
    if(ok === null)  throw new Error('Verifica URL non raggiungibile (riprovare)');

    logLine('SM 1920×1240 in corso…');
    let sm1=await GET('mode=sm&sid='+encodeURIComponent(SID)+'&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u)+'&dim=1920x1240');
    if(!sm1.ok) throw new Error(sm1.error||'SM 1240');
    let sv1=await POST({authToken:TOKEN,sid:SID,dataUrl:sm1.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screenshotmachine',label:'SM_1920x1240'}}});
    logLine('Salvato: '+sv1.name+' sha='+sv1.sha256, true);

    logLine('SM 1920×full in corso…');
    let sm2=await GET('mode=sm&sid='+encodeURIComponent(SID)+'&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u)+'&dim=1920xfull');
    if(!sm2.ok) throw new Error(sm2.error||'SM full');
    let sv2=await POST({authToken:TOKEN,sid:SID,dataUrl:sm2.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screenshotmachine',label:'SM_1920xfull'}}});
    logLine('Salvato: '+sv2.name+' sha='+sv2.sha256, true);

    logLine('PSI final screenshot…');
    let psi=await GET('mode=psi&sid='+encodeURIComponent(SID)+'&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u));
    if(psi.ok && psi.dataUrl){
      let sv3=await POST({authToken:TOKEN,sid:SID,dataUrl:psi.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'psi',label:'PSI_FINAL'}}});
      logLine('PSI salvato: '+sv3.name+' sha='+sv3.sha256, true);
    }else{
      logLine('PSI non disponibile.');
    }
  });
};

/* === fence + scatto + salva === */
(function fence(){
  let drag=false,sx=0,sy=0;
  function bounds(e){ const r=capWrap.getBoundingClientRect(); return {x:Math.max(0,Math.min(e.clientX-r.left,r.width)), y:Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  capWrap.addEventListener('pointerdown', e=>{
    if(!imgLarge.classList.contains('hasSrc')) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; capWrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y; rect.style.display='block';
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; });
})();
async function ensureVideoReady(){
  for(let i=0;i<25;i++){
    if(video.videoWidth>0 && video.videoHeight>0) { await new Promise(r=>requestAnimationFrame(r)); await new Promise(r=>requestAnimationFrame(r)); return true; }
    await sleep(120);
  }
  return false;
}
function isBlank(canvas){
  try{
    const ctx=canvas.getContext('2d');
    const a=ctx.getImageData(0,0,Math.min(10,canvas.width||1),Math.min(10,canvas.height||1)).data;
    for(let i=0;i<a.length;i+=4){ if(a[i]+a[i+1]+a[i+2]>0) return false; }
  }catch(_){}
  return true;
}
$('btnSnap').onclick = async ()=>{
  const vw=video.videoWidth, vh=video.videoHeight;
  logLine('Click SCATTA (shareActive='+shareActive+', '+vw+'×'+vh+')');
  await withBusy('Scatto', async ()=>{
    if(!shareActive) throw new Error('Condivisione non attiva');

    // Verifica “morbida”: se rete/CORS non disponibile non blocco lo scatto; bloccherò al salvataggio.
    const vres = await verifyUrlOrStop();
    if(vres === false) throw new Error('Verifica URL fallita (mismatch) — correggi l’URL in alto');

    const ready = await ensureVideoReady(); if(!ready) throw new Error('Stream non pronto');

    let w=video.videoWidth||1, h=video.videoHeight||1;
    const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d');
    let used='drawImage';
    try{ ctx.drawImage(video,0,0,w,h); }catch(e){ used='drawImage_err:'+e; }

    if(isBlank(c)){
      try{
        const track=stream.getVideoTracks()[0];
        const cap=new ImageCapture(track);
        const bmp=await cap.grabFrame();
        w=bmp.width; h=bmp.height; c.width=w; c.height=h;
        ctx.drawImage(bmp,0,0);
        used='ImageCapture.grabFrame';
      }catch(e){ throw new Error('Fallback grabFrame fallito: '+e.message); }
    }
    imgLarge.src=c.toDataURL('image/png'); imgLarge.classList.add('hasSrc'); rect.style.display='none';
    hasShot=true; enable($('btnSave'), true);
    logLine('Scatto eseguito ('+used+') → immagine grande pronta. Verifica URL verrà ribadita al salvataggio.', true);
  });
};
function makePayload(){
  if(!imgLarge.classList.contains('hasSrc')) return null;
  const natW=imgLarge.naturalWidth, natH=imgLarge.naturalHeight;
  const dispW=imgLarge.clientWidth, dispH=imgLarge.clientHeight;
  const rx=parseFloat(rect.style.left)||0, ry=parseFloat(rect.style.top)||0;
  const rw=parseFloat(rect.style.width)||0, rh=parseFloat(rect.style.height)||0;
  const needCrop = rect.style.display!=='none' && rw>2 && rh>2;
  const c=document.createElement('canvas'); const ctx=c.getContext('2d'); const tmp=new Image(); tmp.src=imgLarge.src;
  return new Promise(res=>{
    tmp.onload=()=>{
      if(!needCrop){ c.width=natW; c.height=natH; ctx.drawImage(tmp,0,0); res({dataUrl:c.toDataURL('image/png'), crop:null}); return; }
      const ax=Math.round(rx*natW/dispW), ay=Math.round(ry*natH/dispH);
      const aw=Math.round(rw*natW/dispW), ah=Math.round(rh*natH/dispH);
      c.width=Math.max(1,aw); c.height=Math.max(1,ah); ctx.drawImage(tmp,ax,ay,aw,ah,0,0,c.width,c.height);
      res({dataUrl:c.toDataURL('image/png'), crop:{x:ax,y:ay,w:aw,h:ah,naturalW:natW,naturalH:natH}});
    };
  });
}
$('btnSave').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!hasShot){ alert('Fai prima uno scatto'); return; }
  await withBusy('Salvataggio scatto', async ()=>{
    // Verifica “dura”: qui DEVE passare
    const ok = await verifyUrlOrStop();
    if(ok !== true) throw new Error('Verifica URL fallita o non raggiungibile');

    const payload = await makePayload(); if(!payload){ logLine('Nessuna immagine.'); return; }
    const u=($('addr').value||'').trim();
    const label=(payload.crop?'FRAME_CROP':'FRAME_FULL');
    const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:payload.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screen-capture',label:label},crop:payload.crop}});
    if(!sv.ok) throw new Error(sv.error||'Errore salvataggio');
    logLine('PNG salvato: '+sv.name+' sha='+sv.sha256+' (url='+u+'; final='+sv.finalUrl+')', true);
  });
};

/* === REC/STOP === */
$('btnRec').onclick = async ()=>{
  if(!shareActive){ logLine('Condivisione non attiva: premi “Condividi”.', true); return; }
  if(recording){ logLine('Registrazione già in corso.'); return; }
  try{
    recChunks=[]; const mt = MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/webm';
    recorder = new MediaRecorder(stream, { mimeType: mt, videoBitsPerSecond: 3500000 });
    recorder.ondataavailable = e=>{ if(e.data && e.data.size) recChunks.push(e.data); };
    recorder.onstart = ()=>{ recording=true; setUIState('recording'); logLine('REC avviato…', true); };
    recorder.onstop = async ()=>{
      recording=false; setUIState('shared'); logLine('REC terminato. Salvataggio in corso…', true);
      const blob = new Blob(recChunks, { type: recorder.mimeType || 'video/webm' });
      const b64 = await (new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); }));
      const u=($('addr').value||'').trim();
      const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:b64,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screen-capture',label:'REC_VIDEO'}}});
      if(!sv.ok) throw new Error(sv.error||'Errore salvataggio video');
      logLine('VIDEO salvato: '+sv.name+' sha='+sv.sha256+' (url='+u+'; final='+sv.finalUrl+')', true);
    };
    recorder.start();
  }catch(e){ logLine('ERRORE REC: '+(e.message||e), true); }
};
$('btnStop').onclick = ()=>{ if(recorder && recording){ try{ recorder.stop(); }catch(e){ logLine('ERRORE STOP: '+e, true); } } };

/* === asset (deep snapshot) — enforcement via sid === */
$('btnAssets').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=($('addr').value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  await withBusy('Scarica asset', async ()=>{
    const ok = await verifyUrlOrStop(); if(ok !== true) throw new Error('Verifica URL fallita o non raggiungibile');
    const js=await GET('mode=snapshot&t='+encodeURIComponent(TOKEN||'')+'&id='+encodeURIComponent(SID)+'&u='+encodeURIComponent(u));
    if(!js.ok) throw new Error(js.error||'snapshot');
    logLine('HTML+asset salvati: '+(js.count||0), true);
  });
};

/* === termina === */
$('btnFinish').onclick = async ()=>{
  if(!SID){ alert('Nessuna sessione'); return; }
  await withBusy('Termina certificazione (ZIP + invio)', async ()=>{
    const q='mode=finish'
      +'&t='+encodeURIComponent(TOKEN||'')
      +'&id='+encodeURIComponent(SID)
      +($('rcpts').value?('&to='+encodeURIComponent($('rcpts').value)):'')
      +'&subj='+encodeURIComponent(window._SUBJ_DEFAULT||'Web Evidence')
      +'&pecMode='+encodeURIComponent(document.getElementById('pecMode').value);
    const js=await GET(q); if(!js.ok) throw new Error(js.error||'Errore finish');
    setUIState('finished'); $('btnFinish').disabled=true;
    logLine('FINE CERTIFICAZIONE — vai alla cartella: '+(js.zipUrl||' (apri la cartella sessione in Drive)'), true);
    if(js.zipName) logLine('ZIP: '+js.zipName);
    if(js.zipUrl)  logLine('Link ZIP: '+js.zipUrl);
  }, {restore:false});
};
</script>
</body>
</html>
