<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Web Evidence – Cattura</title>
<style>
  :root { --accent:#0a7cff; }
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0}
  header{display:flex;gap:8px;flex-wrap:wrap;align-items:center;border-bottom:1px solid #eee;padding:10px;position:sticky;top:0;background:#fff;z-index:10}
  input,select,button{padding:8px;border:1px solid #ddd;border-radius:8px;background:#fafafa}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button[disabled]{opacity:.5;cursor:not-allowed}
  #status{font-size:12px;color:#444;margin-left:auto}
  #work{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px}
  video,canvas{width:100%;background:#000;border-radius:8px}
  #cropWrap{position:relative;user-select:none;-webkit-user-select:none}
  #img{max-width:100%;display:block;-webkit-user-drag:none;user-drag:none}
  #rect{position:absolute;border:2px dashed #000;background:rgba(0,0,0,.12);display:none;pointer-events:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .toast{position:fixed;right:12px;bottom:12px;background:#222;color:#fff;padding:10px 12px;border-radius:10px;opacity:.95}
</style>
</head>
<body>
<header>
  <input id="addr" type="url" placeholder="https://…" style="min-width:340px">
  <select id="smDim">
    <option>1366xfull</option><option selected>1920xfull</option><option>2560xfull</option><option>3840xfull</option>
    <option disabled>──────────</option>
    <option>1366x768</option><option>1600x900</option><option>1920x1080</option><option>2560x1440</option><option>3840x2160</option>
  </select>
  <button id="btnStartCert" class="primary">Inizia certificazione</button>
  <button id="btnFinishCert" disabled>Termina certificazione</button>
  <button id="btnPSI">PSI</button>
  <button id="btnSM">SM full-page</button>
  <button id="start">Avvia cattura</button>
  <button id="freeze" disabled>Scatta frame</button>
  <button id="resetSel" disabled>Reset selezione</button>
  <span id="status">pronto</span>
</header>

<div class="row" style="padding:8px 10px">
  <label>Destinatari:</label><input id="rcpts" type="text" placeholder="a@pec.it, b@example.com" style="min-width:280px">
  <label>Oggetto:</label><input id="subj" type="text" placeholder="Web Evidence – Screenshot" style="min-width:260px">
  <button id="save" disabled>Salva PNG (fence/intero)</button>
  <button id="send" disabled>Salva+Email</button>
</div>

<div id="work">
  <div><video id="video" autoplay playsinline></video></div>
  <div id="cropWrap"><img id="img" alt="frame"><div id="rect"></div></div>
</div>

<script>
const q     = new URLSearchParams(location.search);
const APP   = q.get('app') || '';     // URL Web App /exec
const TOKEN = q.get('t')   || '';     // = DATA!B7
let   CURRENT = q.get('u') || '';     // URL indagata

const el = (id)=>document.getElementById(id);
const status = (s)=>{ el('status').textContent = s; };
const toast  = (s)=>{ const d=document.createElement('div'); d.className='toast'; d.textContent=s; document.body.appendChild(d); setTimeout(()=>d.remove(),3000); };

el('addr').value = CURRENT;

let session = { id:'', folderUrl:'' };
let stream = null;

/* ============ Helper fetch verso Apps Script ============ */
async function callGet(params){
  const url = APP + (APP.includes('?')?'&':'?') + params;
  const r = await fetch(url, { method:'GET' });
  if (!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}
async function callPost(body){
  const r = await fetch(APP, { method:'POST', headers:{'Content-Type':'text/plain; charset=utf-8'}, body: JSON.stringify(body) });
  if (!r.ok){ const t=await r.text().catch(()=> ''); throw new Error('HTTP '+r.status+' '+t.slice(0,200)); }
  return await r.json();
}

/* ============ Fence (pointer events, no “puntino”) ============ */
(function(){
  const wrap = el('cropWrap'), rect = el('rect'), img = el('img');
  let dragging=false, sx=0, sy=0;
  function bounds(e){
    const r = wrap.getBoundingClientRect();
    const x = Math.max(0, Math.min(e.clientX - r.left, r.width));
    const y = Math.max(0, Math.min(e.clientY - r.top , r.height));
    return {x,y};
  }
  wrap.addEventListener('pointerdown', e=>{
    if (!img.src) return;
    if (e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault();
    dragging=true; const p=bounds(e); sx=p.x; sy=p.y;
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px',display:'block'});
    el('resetSel').disabled=false;
    function onMove(ev){ if(!dragging) return; const p=bounds(ev);
      rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
      rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
    }
    function onUp(){ dragging=false; document.removeEventListener('pointermove', onMove); if((+rect.style.width.replace('px','')||0)<3 && (+rect.style.height.replace('px','')||0)<3){ rect.style.width='120px'; rect.style.height='80px'; } }
    document.addEventListener('pointermove', onMove); document.addEventListener('pointerup', onUp, {once:true});
  });
  el('resetSel').onclick=()=>{ rect.style.display='none'; rect.style.width=rect.style.height='0px'; el('resetSel').disabled=true; toast('Selezione cancellata'); };
})();

/* ============ Crop → dataURL ============ */
function buildCrop(){
  const img = el('img'), rect = el('rect');
  if (!img.src) return null;
  const naturalW = img.naturalWidth, naturalH = img.naturalHeight;
  const dispW = img.clientWidth || naturalW, dispH = img.clientHeight || naturalH;

  const hasSel = rect.style.display!=='none' && (+rect.style.width.replace('px','')||0)>1 && (+rect.style.height.replace('px','')||0)>1;

  const c = document.createElement('canvas'), ctx = c.getContext('2d');
  if (!hasSel){
    c.width=naturalW; c.height=naturalH; ctx.drawImage(img,0,0);
    return { dataUrl: c.toDataURL('image/png'), crop:{x:0,y:0,w:naturalW,h:naturalH,naturalW,naturalH}, label:'Intero' };
  }
  const scaleX = naturalW/dispW, scaleY = naturalH/dispH;
  const rx = Math.round(parseFloat(rect.style.left)*scaleX);
  const ry = Math.round(parseFloat(rect.style.top )*scaleY);
  const rw = Math.round(parseFloat(rect.style.width)*scaleX);
  const rh = Math.round(parseFloat(rect.style.height)*scaleY);
  c.width=Math.max(1,rw); c.height=Math.max(1,rh);
  ctx.drawImage(img, rx,ry,rw,rh, 0,0,c.width,c.height);
  return { dataUrl:c.toDataURL('image/png'), crop:{x:rx,y:ry,w:c.width,h:c.height,naturalW,naturalH}, label:'Fence' };
}

/* ============ START / FINISH sessione ============ */
el('btnStartCert').onclick = async ()=>{
  try{
    el('btnStartCert').disabled=true; status('creazione sessione…');
    CURRENT = el('addr').value.trim() || CURRENT;
    const js = await callGet(`mode=start&t=${encodeURIComponent(TOKEN)}&u=${encodeURIComponent(CURRENT)}`);
    if (!js.ok) throw new Error(js.error||'start failed');
    session.id = js.sessionId; session.folderUrl = js.folderUrl;
    el('btnFinishCert').disabled = false;
    toast('Sessione creata: ' + js.folderName);
    status('sessione pronta');
  }catch(e){
    alert('Errore start: ' + e.message);
  }finally{
    el('btnStartCert').disabled=false;
  }
};

el('btnFinishCert').onclick = async ()=>{
  if (!session.id){ alert('Nessuna sessione avviata'); return; }
  try{
    el('btnFinishCert').disabled=true; status('creo ZIP e invio PEC…');
    const to = encodeURIComponent(el('rcpts').value.trim() || '');
    const js = await callGet(`mode=finish&t=${encodeURIComponent(TOKEN)}&id=${encodeURIComponent(session.id)}&to=${to}`);
    if (!js.ok) throw new Error(js.error||'finish failed');
    toast('ZIP creato e PEC inviata'); status('completato');
  }catch(e){
    alert('Errore finish: ' + e.message);
    el('btnFinishCert').disabled=false;
  }
};

/* ============ SM / PSI (server-side) ============ */
el('btnSM').onclick = async ()=>{
  try{
    status('SM full-page…'); const u=(el('addr').value||CURRENT).trim();
    const js = await callGet(`mode=sm&u=${encodeURIComponent(u)}&dim=${encodeURIComponent(el('smDim').value)}`);
    if (!js.ok) throw new Error(js.error);
    el('img').src = js.dataUrl;
    el('save').disabled = el('send').disabled = false;
    toast('SM pronto'); status('pronto');
  }catch(e){ alert('Errore SM: '+e.message); status('errore'); }
};

el('btnPSI').onclick = async ()=>{
  try{
    status('PSI…'); const u=(el('addr').value||CURRENT).trim();
    const js = await callGet(`mode=psi&u=${encodeURIComponent(u)}`);
    if (!js.ok) throw new Error(js.error);
    el('img').src = js.dataUrl;
    el('save').disabled = el('send').disabled = false;
    toast('PSI pronto'); status('pronto');
  }catch(e){ alert('Errore PSI: '+e.message); status('errore'); }
};

/* ============ Screen capture (video->frame) ============ */
const video = el('video');
el('start').onclick = async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:false});
    video.srcObject = stream; await video.play();
    el('freeze').disabled = false;
    status('condivisione attiva');
  }catch(e){ alert('Cattura negata: '+e.message); }
};
el('freeze').onclick = async ()=>{
  if (!stream || !video.videoWidth){ alert('Stream non attivo'); return; }
  try{
    const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    el('img').src = c.toDataURL('image/png');
    el('save').disabled = el('send').disabled = false;
    toast('Frame acquisito');
  }catch(e){ alert('Errore scatto: ' + e.message); }
};

/* ============ SALVA (Drive/PEC) ============ */
async function sendSave(sendEmail){
  if (!session.id){ alert('Prima “Inizia certificazione”'); return; }
  const payload = buildCrop(); if(!payload){ alert('Nessuna immagine'); return; }
  const body = {
    authToken: TOKEN, sessionId: session.id,
    fileNameHint: `capture_${Date.now()}.png`,
    dataUrl: payload.dataUrl, sendEmail,
    recipients: el('rcpts').value.trim() || undefined,
    subject:    el('subj').value.trim()  || undefined,
    meta: {
      url: el('addr').value.trim() || CURRENT,
      finalUrl: el('addr').value.trim() || CURRENT,
      sourceMeta: { provider:'screen-capture', dimension:'na', label: payload.label },
      crop: payload.crop
    }
  };
  try{
    el('save').disabled = el('send').disabled = true; status('salvataggio…');
    const js = await callPost(body);
    if (!js.ok) throw new Error(js.error||'save failed');
    toast('Salvato: ' + js.name); status('pronto');
  }catch(e){ alert('Errore salvataggio: ' + e.message); status('errore'); }
  finally{ el('save').disabled = el('send').disabled = false; }
}
el('save').onclick = ()=> sendSave(false);
el('send').onclick = ()=> sendSave(true);
</script>
</body>
</html>
