<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence</title>
<style>
  :root{--bd:#ddd;--ok:#18a957;--danger:#e11d48}
  *{box-sizing:border-box}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0;color:#111;background:#fff}
  header{padding:10px;border-bottom:1px solid #eee}
  .hrow{display:grid;gap:8px;align-items:center}
  .row1{grid-template-columns:170px 1fr auto}
  .row2{grid-template-columns:auto auto 260px 1fr}
  input,button,select{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fafafa}
  input[type="url"], input[type="text"]{background:#fff}
  .success{background:var(--ok)!important;border-color:var(--ok)!important;color:#fff}
  .danger{background:var(--danger)!important;border-color:var(--danger)!important;color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .card{border:1px solid #eee;border-radius:12px;background:#fff}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #f3f4f4;font-size:13px;font-weight:700}
  .side{padding:12px}
  #thumb{width:300px;height:300px;display:block;background:#000;border:1px dashed #ccc;border-radius:10px}
  .mut{color:#666}
  .controls{display:flex;flex-direction:column;gap:10px;padding:12px}
  .controls .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .dim{opacity:.6}
  #logWrap{padding:0 12px 12px}
  #logBox{height:260px;border:1px solid #eee;border-radius:10px;padding:10px;overflow:auto;font:12px/1.55 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}
  .capCard{grid-column:2}
  .cap-wrap{position:relative;padding:12px;overflow:auto;border-top:1px solid #f3f4f6;min-height:300px}
  #imgLarge{max-width:100%;display:none;border-radius:12px;border:1px solid #eee;background:#000}
  #imgLarge.hasSrc{display:block}
  #rect{position:absolute;border:2px dashed #fff;display:none;pointer-events:none}
</style>
</head>
<body>

<header>
  <div class="hrow row1">
    <input id="client" placeholder="Cliente…" />
    <input id="addr" type="url" placeholder="https://…" />
    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
      <button id="btnStart" class="success" type="button">Inizia certificazione</button>
      <button id="btnFinish" class="danger" type="button" style="display:none">Termina certificazione</button>
    </div>
  </div>
  <div class="hrow row2" style="margin-top:8px">
    <button id="btnOpen" type="button" disabled class="dim" style="display:none">Apri sito in finestra</button>
    <button id="btnShare" type="button" disabled class="dim" style="display:none">Condividi</button>
    <select id="pecMode" title="Modalità invio PEC">
      <option value="normal" selected>PEC normale</option>
      <option value="key">PEC via KEY</option>
      <option value="auto">PEC auto</option>
    </select>
    <input id="rcpts" placeholder="Destinatari PEC/email (virgola per più indirizzi)" />
  </div>
</header>

<div class="wrap">
  <div class="card side">
    <h3>Anteprima LIVE (300×300)</h3>
    <canvas id="thumb" width="300" height="300" aria-label="Anteprima"></canvas>
    <div class="mut" style="margin-top:8px">1) Inizia → 2) Apri → 3) Condividi</div>
  </div>

  <div class="card">
    <h3>Controlli</h3>
    <div class="controls" id="controlsBox">
      <div class="row">
        <button id="btnFull" type="button" disabled class="dim">Cattura full page</button>
        <button id="btnAssets" type="button" disabled class="dim">Scarica asset</button>
      </div>
      <div class="row">
        <button id="btnSnap" type="button" disabled class="dim">Scatta</button>
        <button id="btnSave" type="button" disabled class="dim">Salva</button>
        <button id="btnRec" type="button" disabled class="dim">REC</button>
        <button id="btnStop" type="button" disabled class="dim">STOP</button>
      </div>
    </div>
    <div id="logWrap">
      <h3 style="border:none;padding:6px 0 6px 0;margin:0">Log</h3>
      <div id="logBox"></div>
    </div>
  </div>

  <div class="card capCard">
    <h3>Finestra di cattura (scatto)</h3>
    <div class="cap-wrap" id="capWrap">
      <img id="imgLarge" alt="Scatto"/>
      <div id="rect"></div>
    </div>
  </div>
</div>

<script>
/* ===== util ===== */
var $=function(id){ return document.getElementById(id); };
function logLine(s, important){ if(important===void 0) important=false; var L=$('logBox'); var entry='['+(new Date().toLocaleTimeString())+'] '+s+(important?'\n':''); L.textContent=entry+'\n'+L.textContent; L.scrollTop=0; }
function enable(el,on){ el.disabled=!on; if(on){ el.classList.remove('dim'); } else { el.classList.add('dim'); } }
function sleep(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }

/* ===== Query + Prefill ===== */
var qs=new URLSearchParams(location.search||'');
var APP = qs.get('app')||'';
var TOKEN = qs.get('t')||'';
if(qs.get('u')) $('addr').value = qs.get('u');
if(qs.get('client')) $('client').value = qs.get('client');
if(qs.get('to')) $('rcpts').value = qs.get('to');
if(qs.get('dom')||qs.get('domain')){ $('client').dataset.domain = qs.get('dom')||qs.get('domain'); }
logLine('BOOT — app='+(APP? 'OK' : 'MANCANTE')+', token='+(TOKEN? 'OK':'MANCANTE'));

/* ===== stato ===== */
var SID='', stream=null, rafId=null, hasShot=false, shareActive=false, recording=false;
var recorder=null, recChunks=[];
var video=document.createElement('video'); video.autoplay=true; video.muted=true; video.playsInline=true;
var thumb=$('thumb'), imgLarge=$('imgLarge'), rect=$('rect'), capWrap=$('capWrap');

/* ===== UI states ===== */
function setUIState(state){
  if(state==='idle'){
    enable($('btnFull'), false); enable($('btnAssets'), false); enable($('btnSnap'), false); enable($('btnSave'), false); enable($('btnRec'), false); enable($('btnStop'), false);
    $('btnOpen').style.display='none'; $('btnShare').style.display='none';
  }
  if(state==='started'){
    $('btnOpen').style.display='inline-block'; enable($('btnOpen'), true);
    $('btnShare').style.display='none';
    enable($('btnFull'), true); enable($('btnAssets'), true);
    enable($('btnSnap'), false); enable($('btnSave'), false);
    enable($('btnRec'), false); enable($('btnStop'), false);
  }
  if(state==='shared'){
    enable($('btnFull'), true); enable($('btnAssets'), true);
    enable($('btnSnap'), true); enable($('btnSave'), hasShot);
    enable($('btnRec'), !recording); enable($('btnStop'), recording);
  }
  if(state==='recording'){
    enable($('btnFull'), false); enable($('btnAssets'), false);
    enable($('btnSnap'), false); enable($('btnSave'), false);
    enable($('btnRec'), false); enable($('btnStop'), true);
  }
  if(state==='locked'){
    enable($('btnSnap'), false); enable($('btnSave'), false);
    enable($('btnFull'), true); enable($('btnAssets'), true);
    enable($('btnRec'), false); enable($('btnStop'), false);
  }
  if(state==='finished'){ Array.prototype.forEach.call(document.querySelectorAll('button'), function(b){ b.disabled=true; }); }
}
(function init(){ setUIState('idle'); drawPreview(); })();

/* ===== fetch helpers (con diagnostica + retry) ===== */
function fetchJsonWithDiag(url){
  logLine('REQ → '+url);
  return fetch(url,{cache:'no-store'})
    .then(function(r){
      logLine('HTTP '+r.status+' ← '+url);
      return r.json();
    });
}
function GET(q){
  var url = APP+(APP.indexOf('?')>=0?'&':'?')+q;
  return fetchJsonWithDiag(url);
}
function POST(b){
  return fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(b),cache:'no-store'})
    .then(function(r){
      logLine('HTTP '+r.status+' ← POST '+APP);
      return r.json();
    });
}

/* ===== anteprima ===== */
function drawPreview(){
  var ctx=thumb.getContext('2d'); var tw=thumb.width, th=thumb.height;
  ctx.fillStyle='#000'; ctx.fillRect(0,0,tw,th);
  if(!(video.videoWidth && video.videoHeight)){ rafId=requestAnimationFrame(drawPreview); return; }
  var vw=video.videoWidth, vh=video.videoHeight; var br=vw/vh; var dw=tw, dh=tw/br; if(dh>th){ dh=th; dw=th*br; } var dx=(tw-dw)/2, dy=(th-dh)/2;
  ctx.drawImage(video, dx, dy, dw, dh);
  rafId=requestAnimationFrame(drawPreview);
}

/* ===== Start ===== */
$('btnStart').onclick = function(){
  if(SID){ logLine('Sessione già attiva.'); return; }
  var cli=$('client').value.trim(), url=($('addr').value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!url){ alert('URL obbligatoria'); return; }
  $('btnStart').style.opacity=.5; $('btnStart').disabled=true;
  $('addr').readOnly=true; $('addr').disabled=true; $('client').readOnly=true; $('client').disabled=true;
  logLine('Avvio certificazione…');
  var host= ($('client').dataset.domain||'') || (new URL(url)).hostname.replace(/^www\./,'');
  GET('mode=start&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(url)+'&client='+encodeURIComponent(cli)+'&domain='+encodeURIComponent(host)+'&ua='+encodeURIComponent(navigator.userAgent||'')+'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')+'&lang='+encodeURIComponent(navigator.language||'')+'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)+'&page='+encodeURIComponent(location.href||''))
  .then(function(js){
    if(!js.ok) throw new Error(js.error||'Errore avvio');
    SID=js.sessionId;
    logLine('SESSIONE: '+js.base+(js.folderUrl?(' → '+js.folderUrl):''), true);
    if(js.trace){ for(var i=0;i<js.trace.length;i++){ logLine(js.trace[i]); } }
    $('btnStart').style.display='none';
    $('btnFinish').style.display='inline-block'; $('btnFinish').disabled=false;
    setUIState('started');
  })
  .catch(function(e){
    logLine('ERRORE start: '+(e.message||e), true);
    $('btnStart').disabled=false; $('addr').readOnly=false; $('client').readOnly=false; $('addr').disabled=false; $('client').disabled=false;
  });
};

/* ===== Apri/Condividi ===== */
$('btnOpen').onclick = function(){
  var url=($('addr').value||'').trim(); if(!url){ alert('URL obbligatoria'); return; }
  window.open(url, '_we_clean_'+Date.now(), 'noopener,noreferrer,width=1280,height=900,menubar=no,toolbar=no,location=no,status=no');
  logLine('Finestra/pagina aperta.');
  $('btnOpen').style.display='none';
  $('btnShare').style.display='inline-block';
  enable($('btnShare'), true);
};
$('btnShare').onclick = function(){
  navigator.mediaDevices.getDisplayMedia({video:{frameRate:30,displaySurface:'browser',preferCurrentTab:true},audio:false})
  .then(function(s){
    stream = s; video.srcObject = s;
    return new Promise(function(r){ video.addEventListener('loadeddata', r, {once:true}); });
  })
  .then(function(){ return video.play(); })
  .then(function(){ return sleep(120); }) // piccolo margine per evitare “stream non pronto”
  .then(function(){
    if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview);
    shareActive=true; setUIState('shared');
    logLine('Condivisione attiva (anteprima a sinistra).', true);
    var vt = stream.getVideoTracks()[0];
    vt.addEventListener('ended', function(){ logLine('Condivisione terminata. Scatto/REC disattivati per questa sessione.', true); shareActive=false; recording=false; setUIState('locked'); });
    $('btnShare').disabled=true; $('btnShare').classList.add('dim');
  })
  .catch(function(e){ logLine('Condivisione negata: '+(e.message||e), true); });
};

/* ===== Anti-manomissione: checkUrl con retry ===== */
function verifyUrlOrStop(){
  var now = ($('addr').value||'').trim();
  if(!now){ logLine('Verifica URL: campo vuoto', true); return Promise.resolve(false); }
  var q = 'mode=checkUrl&sid='+encodeURIComponent(SID)+'&u='+encodeURIComponent(now);

  var tries=0;
  function attempt(){
    tries++;
    return GET(q)
      .then(function(chk){
        if(!chk || !chk.ok){ logLine('ERRORE verifica URL (server): '+((chk&&chk.error)||'?'), true); return false; }
        if(chk.mismatch){
          logLine('URL variata / verifica fallita.\nOrig='+chk.orig+'\nNow ='+chk.now+'\nDiag='+(chk.diag||'-'), true);
          return false;
        }
        logLine('Verifica URL OK.\nOrig='+chk.orig+'\nNow ='+chk.now+'\nDiag='+(chk.diag||'-'));
        return true;
      })
      .catch(function(e){
        logLine('CHKURL GET errore ('+tries+'): '+(e&&e.message?e.message:e), true);
        if(tries<3){ return sleep(350).then(attempt); }
        return false;
      });
  }
  logLine('CHKURL GET → '+(APP+(APP.indexOf('?')>=0?'&':'?')+q));
  return attempt();
}

/* ===== helper scatto ===== */
function isBlank(canvas){
  try{
    var ctx=canvas.getContext('2d');
    var a=ctx.getImageData(0,0,Math.min(10,canvas.width||1),Math.min(10,canvas.height||1)).data;
    for(var i=0;i<a.length;i+=4){ if(a[i]+a[i+1]+a[i+2]>0) return false; }
  }catch(_){}
  return true;
}
function ensureVideoReady(){
  var tries=0;
  return new Promise(function(res){
    (function loop(){
      if(video.videoWidth>0 && video.videoHeight>0){ requestAnimationFrame(function(){ requestAnimationFrame(function(){ res(true); }); }); return; }
      tries++; if(tries>40){ res(false); return; } // ~5s
      setTimeout(loop,120);
    })();
  });
}

/* ===== Scatta ===== */
$('btnSnap').onclick = function(){
  var vw=video.videoWidth, vh=video.videoHeight;
  logLine('Click SCATTA (shareActive='+shareActive+', '+vw+'×'+vh+')');
  if(!shareActive){ logLine('ERRORE in Scatto: Condivisione non attiva', true); return; }
  verifyUrlOrStop()
  .then(function(ok){ if(!ok){ throw new Error('Verifica URL fallita'); } return ensureVideoReady(); })
  .then(function(ready){
    if(!ready){ throw new Error('Stream non pronto'); }
    var w=video.videoWidth||1, h=video.videoHeight||1;
    var c=document.createElement('canvas'); c.width=w; c.height=h; var ctx=c.getContext('2d');
    var used='drawImage';
    try{ ctx.drawImage(video,0,0,w,h); }catch(e){ used='drawImage_err:'+e; }
    if(isBlank(c)){
      var track=(stream && stream.getVideoTracks && stream.getVideoTracks()[0])? stream.getVideoTracks()[0] : null;
      if(!track){ throw new Error('Track video mancante'); }
      try{
        var cap=new ImageCapture(track);
        return cap.grabFrame().then(function(bmp){
          w=bmp.width; h=bmp.height; c.width=w; c.height=h; ctx.drawImage(bmp,0,0); used='ImageCapture.grabFrame';
          imgLarge.src=c.toDataURL('image/png'); imgLarge.classList.add('hasSrc'); rect.style.display='none';
          hasShot=true; enable($('btnSave'), true); setUIState('shared');
          logLine('Scatto eseguito ('+used+') → immagine grande pronta.', true);
        });
      }catch(e){ throw new Error('Fallback grabFrame fallito: '+e.message); }
    }else{
      imgLarge.src=c.toDataURL('image/png'); imgLarge.classList.add('hasSrc'); rect.style.display='none';
      hasShot=true; enable($('btnSave'), true); setUIState('shared');
      logLine('Scatto eseguito ('+used+') → immagine grande pronta.', true);
    }
  })
  .catch(function(e){ logLine('ERRORE in Scatto: '+(e.message||e), true); });
};

/* ===== Crop → Salva PNG ===== */
function makePayload(cb){
  if(!imgLarge.classList.contains('hasSrc')) return cb(null);
  var natW=imgLarge.naturalWidth, natH=imgLarge.naturalHeight;
  var dispW=imgLarge.clientWidth, dispH=imgLarge.clientHeight;
  var rx=parseFloat(rect.style.left)||0, ry=parseFloat(rect.style.top)||0;
  var rw=parseFloat(rect.style.width)||0, rh=parseFloat(rect.style.height)||0;
  var needCrop = rect.style.display!=='none' && rw>2 && rh>2;
  var c=document.createElement('canvas'); var ctx=c.getContext('2d'); var tmp=new Image(); tmp.src=imgLarge.src;
  tmp.onload=function(){
    if(!needCrop){ c.width=natW; c.height=natH; ctx.drawImage(tmp,0,0); cb({dataUrl:c.toDataURL('image/png'), crop:null}); return; }
    var ax=Math.round(rx*natW/dispW), ay=Math.round(ry*natH/dispH);
    var aw=Math.round(rw*natW/dispW), ah=Math.round(rh*natH/dispH);
    c.width=Math.max(1,aw); c.height=Math.max(1,ah); ctx.drawImage(tmp,ax,ay,aw,ah,0,0,c.width,c.height);
    cb({dataUrl:c.toDataURL('image/png'), crop:{x:ax,y:ay,w:aw,h:ah,naturalW:natW,naturalH:natH}});
  };
}
$('btnSave').onclick = function(){
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!hasShot){ alert('Fai prima uno scatto'); return; }
  verifyUrlOrStop().then(function(ok){ if(!ok) return; makePayload(function(payload){
    if(!payload){ logLine('Nessuna immagine.'); return; }
    var u=($('addr').value||'').trim();
    var label=(payload.crop?'FRAME_CROP':'FRAME_FULL');
    POST({authToken:TOKEN,sid:SID,dataUrl:payload.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screen-capture',label:label},crop:payload.crop}})
    .then(function(sv){ if(!sv.ok){ logLine('ERRORE Salvataggio scatto: '+(sv.error||'?'), true); return; }
      logLine('PNG salvato: '+sv.name+' sha='+sv.sha256+' (url='+u+'; final='+sv.finalUrl+')', true);
    })
    .catch(function(e){ logLine('ERRORE Salvataggio scatto: '+(e.message||e), true); });
  }); });
};

/* ===== Full page (SM + PSI) ===== */
$('btnFull').onclick = function(){
  if(!SID){ alert('Avvia certificazione'); return; }
  var u=($('addr').value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  verifyUrlOrStop().then(function(ok){
    if(!ok) throw new Error('Verifica URL fallita');
    logLine('SM 1920×1240 in corso…');
    return GET('mode=sm&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u)+'&dim=1920x1240')
      .then(function(sm1){
        if(!sm1.ok) throw new Error(sm1.error||'SM 1240');
        return POST({authToken:TOKEN,sid:SID,dataUrl:sm1.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screenshotmachine',label:'SM_1920x1240'}}});
      })
      .then(function(sv1){ logLine('Salvato: '+sv1.name+' sha='+sv1.sha256, true);
        logLine('SM 1920×full in corso…');
        return GET('mode=sm&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u)+'&dim=1920xfull');
      })
      .then(function(sm2){
        if(!sm2.ok) throw new Error(sm2.error||'SM full');
        return POST({authToken:TOKEN,sid:SID,dataUrl:sm2.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screenshotmachine',label:'SM_1920xfull'}}});
      })
      .then(function(sv2){ logLine('Salvato: '+sv2.name+' sha='+sv2.sha256, true);
        logLine('PSI final screenshot…');
        return GET('mode=psi&t='+encodeURIComponent(TOKEN||'')+'&u='+encodeURIComponent(u));
      })
      .then(function(psi){ if(psi.ok && psi.dataUrl){
          return POST({authToken:TOKEN,sid:SID,dataUrl:psi.dataUrl,sendEmail:false,meta:{url:u,sourceMeta:{provider:'psi',label:'PSI_FINAL'}}})
                 .then(function(sv3){ logLine('PSI salvato: '+sv3.name+' sha='+sv3.sha256, true); });
        } else { logLine('PSI non disponibile.'); }
      })
      .catch(function(e){ logLine('ERRORE in Cattura full page: '+(e.message||e), true); });
  });
};

/* ===== Snapshot asset ===== */
$('btnAssets').onclick = function(){
  if(!SID){ alert('Avvia certificazione'); return; }
  var u=($('addr').value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  verifyUrlOrStop().then(function(ok){
    if(!ok) throw new Error('Verifica URL fallita');
    logLine('Scarico asset…');
    return GET('mode=snapshot&t='+encodeURIComponent(TOKEN||'')+'&id='+encodeURIComponent(SID)+'&u='+encodeURIComponent(u));
  })
  .then(function(js){ if(js && js.ok){ logLine('HTML+asset salvati: '+(js.count||0), true); } })
  .catch(function(e){ logLine('ERRORE Snapshot: '+(e.message||e), true); });
};

/* ===== Fence (ritaglio) ===== */
(function fence(){
  var drag=false,sx=0,sy=0;
  function bounds(e){ var r=capWrap.getBoundingClientRect(); return {x:Math.max(0,Math.min(e.clientX-r.left,r.width)), y:Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  capWrap.addEventListener('pointerdown', function(e){
    if(!imgLarge.classList.contains('hasSrc')) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); if(capWrap.setPointerCapture) capWrap.setPointerCapture(e.pointerId);
    drag=true; var p=bounds(e); sx=p.x; sy=p.y; rect.style.display='block';
    rect.style.left=sx+'px'; rect.style.top=sy+'px'; rect.style.width='0px'; rect.style.height='0px';
  });
  window.addEventListener('pointermove', function(e){
    if(!drag) return; var p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', function(){ drag=false; });
})();

/* ===== REC/STOP ===== */
$('btnRec').onclick = function(){
  if(!shareActive){ logLine('Condivisione non attiva: premi “Condividi”.', true); return; }
  if(recording){ logLine('Registrazione già in corso.'); return; }
  try{
    recChunks=[]; var mt = (MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) ? 'video/webm;codecs=vp9' : 'video/webm';
    recorder = new MediaRecorder(stream, { mimeType: mt, videoBitsPerSecond: 3500000 });
    recorder.ondataavailable = function(e){ if(e.data && e.data.size) recChunks.push(e.data); };
    recorder.onstart = function(){ recording=true; setUIState('recording'); logLine('REC avviato…', true); };
    recorder.onstop = function(){
      recording=false; setUIState('shared'); logLine('REC terminato. Salvataggio in corso…', true);
      var blob = new Blob(recChunks, { type: recorder.mimeType || 'video/webm' });
      var fr=new FileReader(); fr.onload=function(){
        var b64=String(fr.result); var u=($('addr').value||'').trim();
        POST({authToken:TOKEN,sid:SID,dataUrl:b64,sendEmail:false,meta:{url:u,sourceMeta:{provider:'screen-capture',label:'REC_VIDEO'}}})
        .then(function(sv){ if(!sv.ok) throw new Error(sv.error||'Errore salvataggio video'); logLine('VIDEO salvato: '+sv.name+' sha='+sv.sha256+' (url='+u+'; final='+sv.finalUrl+')', true); })
        .catch(function(e){ logLine('ERRORE VIDEO: '+(e.message||e), true); });
      }; fr.readAsDataURL(blob);
    };
    recorder.start();
  }catch(e){ logLine('ERRORE REC: '+(e.message||e), true); }
};
$('btnStop').onclick = function(){ if(recorder && recording){ try{ recorder.stop(); }catch(e){ logLine('ERRORE STOP: '+e, true); } } };

/* ===== Termina ===== */
$('btnFinish').onclick = function(){
  if(!SID){ alert('Nessuna sessione'); return; }
  var subj='Web Evidence – '+($('client').value||'')+' – '+(($('client').dataset.domain)||'');
  var q='mode=finish'+'&t='+encodeURIComponent(TOKEN||'')+'&id='+encodeURIComponent(SID)+($('rcpts').value?('&to='+encodeURIComponent($('rcpts').value)):'')+'&subj='+encodeURIComponent(subj)+'&pecMode='+encodeURIComponent(document.getElementById('pecMode').value);
  GET(q).then(function(js){
    if(!js.ok) throw new Error(js.error||'Errore finish');
    setUIState('finished'); $('btnFinish').disabled=true;
    logLine('FINE CERTIFICAZIONE — vai alla cartella: '+(js.zipUrl||' (apri la cartella sessione in Drive)'), true);
    if(js.zipName) logLine('ZIP: '+js.zipName); if(js.zipUrl) logLine('Link ZIP: '+js.zipUrl);
  })
  .catch(function(e){ logLine('ERRORE finish: '+(e.message||e), true); });
};
</script>
</body>
</html>
