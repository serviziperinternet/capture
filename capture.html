<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Web Evidence – Certificazione</title>
<style>
  :root { --ok:#16a34a; --warn:#d97706; --err:#dc2626; --muted:#999; }
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0}
  header{display:grid;grid-template-columns:220px 1fr auto auto 1fr auto;gap:8px;padding:10px;border-bottom:1px solid #eee;align-items:center}
  input,select,button{padding:8px;border:1px solid #ddd;border-radius:8px;background:#fafafa}
  button.primary{background:#111;color:#fff}
  button[disabled]{opacity:.5;cursor:not-allowed}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 10px;border-bottom:1px solid #f0f0f0}
  #work{display:grid;grid-template-columns:1.2fr 0.8fr;gap:10px;padding:10px;align-items:start}
  video,canvas{width:100%;background:#000;border-radius:8px}
  #previewWrap{position:relative}
  #shot{max-width:100%;display:block;-webkit-user-drag:none;user-drag:none}
  #rect{position:absolute;border:2px dashed #000;background:rgba(0,0,0,.12);display:none;pointer-events:none}
  #log{height:180px;border:1px solid #eee;border-radius:8px;padding:8px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;background:#fafafa}
  .pill{padding:.2rem .5rem;border-radius:999px;background:#f3f4f6;color:#333;font-size:12px}
  .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:#777}
</style>
</head>
<body>

<header>
  <input id="client" placeholder="Cliente..." />
  <input id="url" type="url" placeholder="https://…" />
  <button id="btnPreview">Anteprima</button>
  <button id="btnOpen" onclick="open(url.value,'_blank');">Apri scheda</button>
  <span id="state" class="pill muted">Pronto</span>
  <div style="text-align:right">
    <label class="muted" style="font-size:12px">Destinatari</label>
    <input id="rcpts" placeholder="a@pec.it, b@example.com"/>
  </div>
  <div>
    <label class="muted" style="font-size:12px">Oggetto</label>
    <input id="subj" value="Web Evidence – Screenshot"/>
  </div>
  <button id="btnStart" class="primary">Inizia certificazione</button>
  <button id="btnFinish" disabled>Termina certificazione</button>
</header>

<div class="toolbar">
  <button id="capStart">Avvia cattura schermo</button>
  <button id="capFrame"  disabled>Scatta frame (selezione)</button>
  <button id="capFull"   disabled>Scatta intero</button>
  <button id="capReset"  disabled>Annulla selezione</button>

  <span style="margin-left:16px">
    <label class="muted">SM:</label>
    <select id="smDim">
      <option>1366xfull</option>
      <option selected>1920xfull</option>
      <option>2560xfull</option>
      <option>3840xfull</option>
      <option disabled>──────────</option>
      <option>1366x768</option>
      <option>1600x900</option>
      <option>1920x1080</option>
      <option>2560x1440</option>
      <option>3840x2160</option>
    </select>
    <button id="btnSMfull">SM full-page</button>
    <button id="btnSMview">SM view</button>
    <button id="btnPSI">PSI</button>
    <button id="btnProbe">Snapshot pagina</button>
  </span>

  <span style="margin-left:auto">
    <button id="savePng" disabled>Salva PNG (intero)</button>
    <button id="savePngEmail" disabled>Salva+Email</button>
    <button id="saveVideo" disabled>Salva VIDEO</button>
  </span>
</div>

<div id="work">
  <div>
    <video id="video" autoplay playsinline style="height:52vh"></video>
    <div style="margin-top:8px">
      <button id="recStart" disabled>REC video</button>
      <button id="recStop"  disabled>Stop REC</button>
      <span id="recState" class="pill muted">idle</span>
    </div>
  </div>
  <div id="previewWrap">
    <img id="shot" alt="anteprima"/>
    <div id="rect"></div>
  </div>
</div>

<div style="padding:8px 10px"><b>Log</b></div>
<div id="log"></div>

<script>
/* ===== Params ===== */
const qs = new URLSearchParams(location.search);
const APP   = qs.get('app') || '';
const TOKEN = qs.get('t')   || '';
const DEFU  = qs.get('u')   || '';
const DEFC  = qs.get('client') || '';
const DEFT  = qs.get('to')  || '';
const DEFS  = qs.get('subj')|| '';

url.value    = DEFU || '';
client.value = DEFC || '';
rcpts.value  = DEFT || '';
if (DEFS) subj.value = DEFS;

/* ===== State ===== */
let SID = '';                     // folderId sessione
let currentUrl = url.value.trim();
let stream = null;
let mediaRec = null, chunks=[];
let lastArtifact = null;          // { type:'image'|'video', dataUrl|blobUrl, meta:{} }
const shot = document.getElementById('shot');
const rect = document.getElementById('rect');
const wrap = document.getElementById('previewWrap');
const video= document.getElementById('video');

/* ===== Utils ===== */
const ts = ()=> new Date().toLocaleTimeString();
function log(msg, cls=''){
  const el = document.getElementById('log');
  const line = `[${ts()}] ${msg}`;
  el.textContent += (el.textContent?'\n':'') + line;
  el.scrollTop = el.scrollHeight;
  if (SID) fetch(APP+'?mode=log&sid='+encodeURIComponent(SID)+'&line='+encodeURIComponent(line));
}
function needSID(){ if(!SID){ alert('Avvia "Inizia certificazione" prima.'); return true;} return false; }
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function dataUrlFromImage(full=false){
  if (!shot.src) return null;
  const c = document.createElement('canvas'), ctx = c.getContext('2d');
  const natW = shot.naturalWidth, natH = shot.naturalHeight;
  if (full || rect.style.display==='none') {
    c.width = natW; c.height = natH; ctx.drawImage(shot,0,0); 
    return { dataUrl:c.toDataURL('image/png'), crop:null };
  }
  const dispW = shot.clientWidth, dispH = shot.clientHeight;
  const scaleX = natW/dispW, scaleY = natH/dispH;
  const rx = Math.round(parseFloat(rect.style.left)*scaleX);
  const ry = Math.round(parseFloat(rect.style.top )*scaleY);
  const rw = Math.round(parseFloat(rect.style.width )*scaleX);
  const rh = Math.round(parseFloat(rect.style.height)*scaleY);
  c.width = Math.max(1,rw); c.height = Math.max(1,rh);
  ctx.drawImage(shot, rx,ry,rw,rh, 0,0,c.width,c.height);
  return { dataUrl:c.toDataURL('image/png'), crop:{x:rx,y:ry,w:c.width,h:c.height,naturalW:natW,naturalH:natH} };
}

/* ===== Buttons & flows ===== */

// Anteprima (aggiorna currentUrl dallo UI)
btnPreview.onclick = ()=>{
  currentUrl = url.value.trim();
  if(!currentUrl){ alert('Inserisci una URL'); return; }
  log('Anteprima impostata: '+currentUrl, 'muted');
};

// Inizia certificazione
btnStart.onclick = async ()=>{
  const clientName = client.value.trim();
  currentUrl = url.value.trim();
  if (!clientName){ alert('Inserisci il Cliente'); return; }
  if (!currentUrl){ alert('Inserisci la URL'); return; }
  if (!APP || !TOKEN){ alert('Configura app=? e t=? nell’URL.'); return; }

  state.textContent = 'Avvio…'; state.className='pill';
  const res = await fetch(APP+'?mode=start&u='+encodeURIComponent(currentUrl)+'&client='+encodeURIComponent(clientName));
  const j   = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if(!j.ok){ state.textContent='Errore'; state.className='pill err'; alert('Errore start: '+j.error); return; }
  SID = j.sid;
  state.textContent = 'Sessione attiva'; state.className='pill ok';
  btnStart.disabled = true; btnFinish.disabled = false;

  // abilita cattura
  capStart.disabled=false; btnSMfull.disabled=false; btnSMview.disabled=false; btnPSI.disabled=false; btnProbe.disabled=false;

  log(`Sessione creata: ${j.sessionName}`);
};

// Termina certificazione
btnFinish.onclick = async ()=>{
  if (needSID()) return;
  state.textContent='Chiusura…'; state.className='pill';
  const res = await fetch(APP+'?mode=finish&sid='+encodeURIComponent(SID)+'&to='+encodeURIComponent(rcpts.value||'')+'&subj='+encodeURIComponent(subj.value||''));
  const j   = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if(!j.ok){ state.textContent='Errore'; state.className='pill err'; alert('Errore finish: '+j.error); return; }
  state.textContent='Chiuso'; state.className='pill ok';

  // blocca tutto
  [...document.querySelectorAll('button')].forEach(b=> b.disabled = true);
  log('Manifest e ZIP pronti.');
};

/* ---- Cattura schermo + fence ---- */

capStart.onclick = async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
    video.srcObject = stream; await video.play();
    capFrame.disabled=false; capFull.disabled=false; capReset.disabled=false;
    recStart.disabled=false;
    log('Cattura schermo attiva.');
  }catch(e){ alert('Cattura negata: '+e.message); }
};

// fence
(function fence(){
  let drag=false, sx=0, sy=0;
  function bounds(e){
    const r = wrap.getBoundingClientRect();
    const x = Math.max(0, Math.min(e.clientX-r.left, r.width));
    const y = Math.max(0, Math.min(e.clientY-r.top , r.height));
    return {x,y};
  }
  wrap.addEventListener('pointerdown', e=>{
    if (!shot.src) return;
    if (e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; wrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y;
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px',display:'block'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; const w=parseFloat(rect.style.width)||0,h=parseFloat(rect.style.height)||0; if(w<3&&h<3){rect.style.width='160px';rect.style.height='100px';}});
  window.addEventListener('keydown', e=>{ if(e.key==='Escape'){ rect.style.display='none'; log('Selezione annullata.','muted'); }});
})();
capReset.onclick = ()=>{ rect.style.display='none'; };

// scatta da <video> -> anteprima
capFrame.onclick = async ()=>{
  if(!stream || !video.videoWidth){ alert('Stream non attivo'); return; }
  const c=document.createElement('canvas'); c.width=video.videoWidth; c.height=video.videoHeight;
  c.getContext('2d').drawImage(video,0,0);
  shot.src = c.toDataURL('image/png');
  lastArtifact = { type:'image', dataUrl:shot.src, meta:{ provider:'screen-capture', kind:'fence' } };
  savePng.disabled=false; savePngEmail.disabled=false;
  log('Frame acquisito: seleziona area o salva intero.');
};
capFull.onclick = ()=>{
  capFrame.click(); rect.style.display='none';
  lastArtifact.meta.kind='intero';
};

/* ---- SM/PSI/Probe ---- */

async function getSM(dim){ 
  if (!currentUrl) currentUrl = url.value.trim();
  const r = await fetch(APP+'?mode=sm&u='+encodeURIComponent(currentUrl)+'&dim='+encodeURIComponent(dim));
  const j = await r.json(); if(!j.ok) throw new Error(j.error);
  shot.src = j.dataUrl;
  lastArtifact = { type:'image', dataUrl:j.dataUrl, meta:{ provider:'screenshotmachine', sourceMeta:j.meta, kind: /full/i.test(dim)?'full':'viewport' } };
  rect.style.display='none'; savePng.disabled=false; savePngEmail.disabled=false;
  log('SM pronto: '+dim);
}
btnSMfull.onclick = ()=> getSM(smDim.value);
btnSMview.onclick = ()=> getSM(smDim.value.replace('full','1080'));

btnPSI.onclick = async ()=>{
  if (!currentUrl) currentUrl = url.value.trim();
  const r = await fetch(APP+'?mode=psi&u='+encodeURIComponent(currentUrl));
  const j = await r.json(); if(!j.ok) { alert('PSI: '+j.error); return; }
  shot.src = j.dataUrl;
  lastArtifact = { type:'image', dataUrl:j.dataUrl, meta:{ provider:'psi', sourceMeta:j.meta, kind:'intero' } };
  rect.style.display='none'; savePng.disabled=false; savePngEmail.disabled=false;
  log('PSI pronto.');
};

btnProbe.onclick = async ()=>{
  if (needSID()) return;
  currentUrl = url.value.trim();
  const r = await fetch(APP+'?mode=probe&sid='+encodeURIComponent(SID)+'&u='+encodeURIComponent(currentUrl)+'&label=snap');
  const j = await r.json(); if(!j.ok){ alert('Probe: '+j.error); return; }
  log('Snapshot pagina salvato.');
};

/* ---- Salvataggi PNG/VIDEO ---- */

async function postSave(body){
  const res = await fetch(APP, { method:'POST', headers:{'Content-Type':'text/plain; charset=utf-8'}, body: JSON.stringify(body) });
  const j   = await res.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if(!j.ok) throw new Error(j.error);
  return j;
}

savePng.onclick = async ()=>{
  if (needSID()) return;
  const payload = dataUrlFromImage(rect.style.display==='none'); if(!payload){ alert('Nessuna immagine.'); return; }
  const meta = { url: currentUrl, finalUrl: currentUrl, sourceMeta: lastArtifact?.meta?.sourceMeta || {provider:lastArtifact?.meta?.provider||'screen-capture'}, crop: payload.crop, kind: payload.crop? 'fence':'intero' };
  const body = { authToken: TOKEN, sid: SID, fileNameHint: 'shot.png', dataUrl: payload.dataUrl, sendEmail:false, meta };
  const j = await postSave(body).catch(e=>{ alert('Errore salvataggio: '+e.message); });
  if (j?.ok) log('PNG salvato: '+j.name);
};
savePngEmail.onclick = async ()=>{
  if (needSID()) return;
  const payload = dataUrlFromImage(rect.style.display==='none'); if(!payload){ alert('Nessuna immagine.'); return; }
  const meta = { url: currentUrl, finalUrl: currentUrl, sourceMeta: lastArtifact?.meta?.sourceMeta || {provider:lastArtifact?.meta?.provider||'screen-capture'}, crop: payload.crop, kind: payload.crop? 'fence':'intero' };
  const body = { authToken: TOKEN, sid: SID, fileNameHint: 'shot.png', dataUrl: payload.dataUrl, sendEmail:true, recipients: rcpts.value, subject: subj.value, meta };
  const j = await postSave(body).catch(e=>{ alert('Errore salvataggio: '+e.message); });
  if (j?.ok) log('PNG inviato+salvato: '+j.name);
};

/* ---- Video recording ---- */

recStart.onclick = ()=>{
  if(!stream){ alert('Avvia cattura schermo prima'); return; }
  mediaRec = new MediaRecorder(stream, { mimeType:'video/webm;codecs=vp9' });
  chunks=[]; mediaRec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
  mediaRec.onstop = async ()=>{
    const blob = new Blob(chunks, {type:'video/webm'});
    const reader = new FileReader();
    reader.onload = async ()=>{
      const dataUrl = reader.result; // data:video/webm;base64,...
      lastArtifact = { type:'video', dataUrl, meta:{provider:'screen-record'} };
      saveVideo.disabled=false;
      log('Video pronto per il salvataggio.');
    };
    reader.readAsDataURL(blob);
  };
  mediaRec.start(); recState.textContent='REC'; recState.className='pill';
  recStart.disabled=true; recStop.disabled=false;
  log('Registrazione avviata.');
};
recStop.onclick = ()=>{
  mediaRec?.stop(); recState.textContent='idle'; recState.className='pill muted';
  recStart.disabled=false; recStop.disabled=true;
  log('Registrazione fermata.');
};

saveVideo.onclick = async ()=>{
  if (needSID()) return;
  if (!lastArtifact || lastArtifact.type!=='video'){ alert('Nessun video pronto.'); return; }
  const body = { authToken:TOKEN, sid:SID, fileNameHint:'rec.webm', dataUrl:lastArtifact.dataUrl, sendEmail:false, meta:{ url:currentUrl, finalUrl:currentUrl, sourceMeta:{provider:'screen-record'} } };
  const j = await postSave(body).catch(e=> alert('Errore video: '+e.message));
  if (j?.ok) log('VIDEO salvato: '+j.name);
};

/* ===== UX piccoli ===== */
url.addEventListener('change', ()=>{ currentUrl = url.value.trim(); });
</script>
</body>
</html>
