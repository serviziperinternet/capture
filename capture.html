<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Web Evidence – Cattura</title>
<style>
  :root { --pad:10px; --b:#e5e5e5; --mut:#777; }
  * { box-sizing: border-box; }
  body { font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; }
  header { display:flex; flex-wrap:wrap; gap:8px; padding:10px; border-bottom:1px solid var(--b); align-items:center; }
  button, select, input[type="text"] {
    padding:8px 10px; border:1px solid var(--b); border-radius:8px; background:#fafafa; cursor:pointer;
  }
  input[type="text"] { min-width:260px; }
  #hint { font-size:12px; color:var(--mut); padding:0 var(--pad) 8px; }
  #stage { padding:12px; height:calc(100vh - 200px); overflow:auto; }
  #wrap { position:relative; display:none; user-select:none; -webkit-user-select:none; touch-action:none; }
  #shot { display:block; height:auto; max-width:none; -webkit-user-drag:none; user-drag:none; }
  #rect { position:absolute; border:2px dashed #000; background:rgba(0,0,0,.12); display:none; pointer-events:none; }
  #previewNote { font-size:12px; color:var(--mut); padding:6px var(--pad) 0; }
  .sp { flex:1 1 16px }
  .badge { font:12px/1.8 monospace; background:#f3f3f3; border:1px solid var(--b); border-radius:6px; padding:2px 6px; }
</style>
</head>
<body>
  <header>
    <button id="btnStart">Avvia cattura</button>
    <button id="btnGrab" disabled>Scatta frame</button>
    <span class="sp"></span>
    <label>Zoom:</label>
    <input id="zoom" type="range" min="50" max="200" value="100" />
    <span id="zoomVal" class="badge">100%</span>
    <span class="sp"></span>
    <button id="btnAdd" disabled>Aggiungi segmento</button>
    <button id="btnClear" disabled>Reset segmenti</button>
    <button id="btnAssemble" disabled>Unisci (full-page)</button>
    <span class="sp"></span>
    <label>Destinatari:</label><input id="rcpts" type="text" placeholder="a@pec.it, b@example.com">
    <label>Oggetto:</label><input id="subj" type="text" value="Web Evidence – Screenshot">
    <button id="btnSave" disabled>Salva su Drive</button>
    <button id="btnSend" disabled>Salva + Email</button>
  </header>

  <div id="hint">
    Suggerimento: scegli Schermo intero oppure Finestra nel prompt del browser, vai sulla scheda del sito, chiudi cookie/login, torna qui e premi <b>Scatta frame</b>.
    Traccia la fence, <b>Aggiungi segmento</b> (puoi scrollare la pagina e ripetere), quindi <b>Unisci (full-page)</b> per ottenere l’immagine completa.
  </div>

  <div id="stage">
    <div id="wrap">
      <img id="shot" alt="frame">
      <div id="rect"></div>
    </div>
  </div>
  <div id="previewNote"></div>

<script>
/* ===== Config via querystring =====
   ?app=URL_WEBAPP_APPS_SCRIPT&t=TOKEN&to=destinatari&subj=oggetto
*/
const qs = new URLSearchParams(location.search);
const APP_URL = qs.get('app') || '';
const TOKEN   = qs.get('t')   || '';
const DEF_TO  = qs.get('to')  || '';
const DEF_SUB = qs.get('subj')|| '';

const el = (id)=>document.getElementById(id);

const btnStart = el('btnStart');
const btnGrab  = el('btnGrab');
const btnAdd   = el('btnAdd');
const btnClear = el('btnClear');
const btnAssem = el('btnAssemble');
const btnSave  = el('btnSave');
const btnSend  = el('btnSend');
const zoom     = el('zoom');
const zoomVal  = el('zoomVal');
const rcpts    = el('rcpts');
const subj     = el('subj');
const stage    = el('stage');
const wrap     = el('wrap');
const shot     = el('shot');
const rect     = el('rect');
const note     = el('previewNote');

rcpts.value = DEF_TO;
if (DEF_SUB) subj.value = DEF_SUB;

let stream = null;             // MediaStream
let lastBitmap = null;         // ImageBitmap del frame catturato
let naturalW = 0, naturalH = 0;
let sel = null;                // selezione corrente (px naturali)
let dragging = false, sx=0, sy=0;
let segments = [];             // [{img:ImageBitmap, crop:{x,y,w,h}}...]

/* ===== Screen capture ===== */

btnStart.onclick = async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({
      video: { displaySurface: "browser" },
      selfBrowserSurface: "include",
      preferCurrentTab: false
    });
    btnGrab.disabled = false;
    info('Condivisione avviata: torna sulla scheda del sito, sistema cookie/login, poi qui → Scatta frame.');
  }catch(e){
    warn('Cattura non concessa: ' + e.message);
  }
};

btnGrab.onclick = async ()=>{
  if(!stream){ warn('Avvia prima la cattura.'); return; }
  // acquisisci un frame dalla traccia video
  const [track] = stream.getVideoTracks();
  const imageCapture = new ImageCapture(track);
  const bitmap = await imageCapture.grabFrame();
  lastBitmap = bitmap;
  naturalW = bitmap.width;
  naturalH = bitmap.height;

  // disegna in un canvas → dataURL → <img>
  const c = document.createElement('canvas');
  c.width = naturalW; c.height = naturalH;
  c.getContext('2d').drawImage(bitmap, 0, 0);
  shot.src = c.toDataURL('image/png');
  wrap.style.display = 'block';
  rect.style.display = 'none';
  sel = null;

  btnAdd.disabled = false;
  btnSave.disabled = false;
  btnSend.disabled = false;

  setZoom(zoom.value);
  enableFence();
  info(`Frame acquisito: ${naturalW}×${naturalH}px. Traccia la fence e premi “Aggiungi segmento” (o salva direttamente).`);
};

/* ===== Fence robusta (drag continuo, document-level) ===== */

function enableFence(){
  wrap.onpointerdown = null;
  wrap.onpointermove = null;
  wrap.onpointerup   = null;

  wrap.style.cursor = 'crosshair';
  wrap.onpointerdown = (e)=>{
    if(e.button!==0) return;
    e.preventDefault();
    wrap.setPointerCapture?.(e.pointerId);
    dragging = true;
    const p = relToImg(e.clientX, e.clientY);
    sx = p.xd; sy = p.yd;
    Object.assign(rect.style, { left: p.xd+'px', top: p.yd+'px', width:'0px', height:'0px', display:'block' });
    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp, { once:true });
  };
}

function onMove(e){
  if(!dragging) return;
  const p = relToImg(e.clientX, e.clientY);
  rect.style.left   = Math.min(p.xd, sx) + 'px';
  rect.style.top    = Math.min(p.yd, sy) + 'px';
  rect.style.width  = Math.abs(p.xd - sx) + 'px';
  rect.style.height = Math.abs(p.yd - sy) + 'px';
}

function onUp(){
  dragging = false;
  document.removeEventListener('pointermove', onMove);
  const w = parseFloat(rect.style.width)||0;
  const h = parseFloat(rect.style.height)||0;
  if(w < 3 && h < 3){
    rect.style.width = '200px';
    rect.style.height= '120px';
  }
  sel = selectionToNatural();
}

/* coordinate display→natural con zoom */
function relToImg(clientX, clientY){
  const r = shot.getBoundingClientRect();
  // clamp entro l'immagine
  const xd = Math.max(0, Math.min(clientX - r.left, r.width));
  const yd = Math.max(0, Math.min(clientY - r.top , r.height));
  return { xd, yd, r };
}

function selectionToNatural(){
  const r = shot.getBoundingClientRect();
  const dispW = r.width, dispH = r.height;
  const scaleX = naturalW / dispW, scaleY = naturalH / dispH;

  const left = parseFloat(rect.style.left)||0;
  const top  = parseFloat(rect.style.top)||0;
  const w    = Math.max(1, parseFloat(rect.style.width)||naturalW);
  const h    = Math.max(1, parseFloat(rect.style.height)||naturalH);

  return {
    x: Math.round(left * scaleX),
    y: Math.round(top  * scaleY),
    w: Math.round(w    * scaleX),
    h: Math.round(h    * scaleY)
  };
}

/* ===== Zoom ===== */
zoom.oninput = e => setZoom(e.target.value);
function setZoom(val){
  const pct = Math.max(50, Math.min(200, Number(val)||100));
  zoomVal.textContent = pct + '%';
  if(shot) shot.style.width = pct + '%';
}

/* ===== Segmenti & full-page ===== */

btnAdd.onclick = async ()=>{
  if(!lastBitmap){ warn('Nessun frame.'); return; }
  const crop = sel || { x:0, y:0, w:naturalW, h:naturalH };
  // ritaglia in un offscreen canvas
  const c = document.createElement('canvas');
  c.width = crop.w; c.height = crop.h;
  const ctx = c.getContext('2d');
  ctx.drawImage(lastBitmap, crop.x, crop.y, crop.w, crop.h, 0, 0, crop.w, crop.h);

  const bm = await createImageBitmap(c);
  segments.push({ img: bm, crop: { ...crop } });

  btnClear.disabled = segments.length === 0;
  btnAssem.disabled = segments.length < 2;

  info(`Segmento aggiunto (${crop.w}×${crop.h}). Totale segmenti: ${segments.length}. Ora scrolla il sito, “Scatta frame”, traccia fence e “Aggiungi segmento” di nuovo.`);
};

btnClear.onclick = ()=>{
  segments = [];
  btnClear.disabled = true;
  btnAssem.disabled = true;
  info('Segmenti azzerati.');
};

btnAssem.onclick = async ()=>{
  if(segments.length < 2){ warn('Servono almeno 2 segmenti.'); return; }
  // calcola dimensioni output (larghezza massima, altezza somma)
  const outW = Math.max(...segments.map(s => s.crop.w));
  const outH = segments.reduce((acc,s)=> acc + s.crop.h, 0);
  const canvas = document.createElement('canvas');
  canvas.width = outW; canvas.height = outH;
  const ctx = canvas.getContext('2d');

  let y = 0;
  for(const s of segments){
    const src = s.img;
    // centra se larghezze diverse
    const dx = Math.round((outW - s.crop.w)/2);
    ctx.drawImage(src, 0, 0, s.crop.w, s.crop.h, dx, y, s.crop.w, s.crop.h);
    y += s.crop.h;
  }

  // mostra risultato
  shot.src = canvas.toDataURL('image/png');
  wrap.style.display = 'block';
  rect.style.display = 'none';
  lastBitmap = await createImageBitmap(canvas);
  naturalW = canvas.width; naturalH = canvas.height;
  sel = { x:0, y:0, w:naturalW, h:naturalH };
  setZoom(100);
  info(`Assemblato full-page: ${naturalW}×${naturalH}. Ora puoi salvare o inviare email.`);
};

/* ===== Salva / Invia ===== */

btnSave.onclick = ()=>postImage(false);
btnSend.onclick = ()=>postImage(true);

async function getPNGDataUrlCurrentSelection(){
  if(!lastBitmap){ warn('Nessun frame.'); return null; }
  const crop = sel || { x:0, y:0, w:naturalW, h:naturalH };
  const c = document.createElement('canvas');
  c.width = crop.w; c.height = crop.h;
  c.getContext('2d').drawImage(lastBitmap, crop.x, crop.y, crop.w, crop.h, 0, 0, crop.w, crop.h);
  return { dataUrl: c.toDataURL('image/png'), crop };
}

async function postImage(sendEmail){
  if(!APP_URL || !TOKEN){
    alert('Config mancante: app= e t= nel link.');
    return;
  }
  const payload = await getPNGDataUrlCurrentSelection();
  if(!payload) return;

  const meta = {
    url: document.referrer || '',   // opzionale
    finalUrl: document.referrer || '',
    canonical: '',
    sourceMeta: { provider: 'screen-capture', dimension: `${naturalW}x${naturalH}` },
    crop: payload.crop,
    authToken: TOKEN
  };
  const body = {
    fileNameHint: `capture_${Date.now()}.png`,
    dataUrl: payload.dataUrl,
    meta,
    sendEmail,
    recipients: rcpts.value || '',
    subject: subj.value || ''
  };

  try{
    const res = await fetch(APP_URL, {
      method:'POST',
      headers: { 'Content-Type':'text/plain' }, // niente preflight
      body: JSON.stringify(body)
    });
    const obj = await res.json();
    if(!obj.ok){ throw new Error(obj.error||'Errore salvataggio'); }
    alert(`OK: ${obj.name}\nSHA-256: ${obj.sha256}\nCartella: ${obj.folderUrl}${sendEmail?'\nEmail a: '+(obj.emailedTo||'') : ''}`);
  }catch(e){
    alert('Errore: ' + e.message);
  }
}

/* ===== Util ===== */
function info(m){ note.textContent = m; note.style.color = '#555'; }
function warn(m){ note.textContent = m; note.style.color = '#b00020'; }
</script>
</body>
</html>
