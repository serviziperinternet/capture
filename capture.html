<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence – v10</title>
<style>
  :root{--bd:#ddd;--accent:#0b5cff}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0}
  header{display:grid;grid-template-columns:190px 1fr auto auto 240px 1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:10px}
  input,button,select{padding:8px;border:1px solid var(--bd);border-radius:8px;background:#fafafa}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  button[data-on="1"]{box-shadow:0 0 0 3px rgba(11,92,255,.2)}
  #state{justify-self:end;font-size:12px;color:#222;background:#f3f4f6;border-radius:999px;padding:.25rem .6rem}
  .bar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 10px;border-bottom:1px solid #f0f0f0}
  #work{display:grid;grid-template-columns:1.2fr .8fr;gap:10px;padding:10px}
  video{width:100%;background:#000;border-radius:8px;height:72vh}
  #cropWrap{position:relative;user-select:none;-webkit-user-select:none}
  #img{max-width:100%;display:none;-webkit-user-drag:none;user-drag:none}
  #img.hasSrc{display:block}
  #rect{position:absolute;border:2px dashed #000;background:rgba(0,0,0,.12);display:none;pointer-events:none}
  #log{height:240px;border:1px solid #eee;border-radius:8px;padding:8px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <input id="client" placeholder="Cliente (obbligatorio)"/>
  <input id="addr"   placeholder="https://…"/>
  <button id="btnOpen">Apri scheda</button>
  <button id="btnShare" class="primary">Condividi finestra/scheda</button>

  <input id="rcpts" placeholder="Destinatari PEC/email"/>
  <input id="subj"  value="Web Evidence – Screenshot"/>
  <button id="btnStart">Inizia certificazione</button>
  <button id="btnFinish" disabled>Termina</button>

  <span id="state">Pronto</span>
</header>

<div class="bar">
  <button id="btnSnap"  disabled>Scatta</button>
  <button id="btnReset" disabled>Reset selezione</button>

  <span style="margin-left:16px">
    <label>SM:</label>
    <select id="smDim" disabled>
      <option>1366xfull</option><option selected>1920xfull</option><option>2560xfull</option><option>3840xfull</option>
      <option disabled>──────────</option>
      <option>1366x768</option><option>1600x900</option><option>1920x1080</option><option>2560x1440</option><option>3840x2160</option>
    </select>
    <button id="btnSMPSI" disabled>Salva completi (SM+PSI)</button>
    <button id="btnSnapshot" disabled>Deep Snapshot</button>
  </span>

  <span style="margin-left:auto">
    <button id="recStart" disabled>REC</button>
    <button id="recStop"  disabled>Stop</button>
    <button id="savePng"  disabled>Salva PNG</button>
    <button id="savePngEmail" disabled>Salva+Email</button>
    <button id="saveVideo" disabled>Salva VIDEO</button>
  </span>
</div>

<div id="work">
  <video id="video" autoplay playsinline></video>
  <div id="cropWrap">
    <img id="img" alt="">
    <div id="rect"></div>
  </div>
</div>

<div style="padding:8px 10px"><b>Log</b></div>
<div id="log"></div>

<script>
/* ===== Query ===== */
const qs=new URLSearchParams(location.search);
const APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
if(qs.get('u')) addr.value=qs.get('u');
if(qs.get('client')) client.value=qs.get('client');
if(qs.get('to')) rcpts.value=qs.get('to');
if(qs.get('subj')) subj.value=qs.get('subj');

/* ===== Stato ===== */
let SID=''; let currentUrl=(addr.value||'').trim();
let stream=null, rec=null, chunks=[];
let lastImgHasSrc=false;

const $=id=>document.getElementById(id);
const video=$('video'), img=$('img'), rect=$('rect'), wrap=$('cropWrap');

/* ===== UI ===== */
const setState=s=>$('state').textContent=s;
const log=s=>{ const L=$('log'); L.textContent+=(L.textContent?'\n':'')+'['+(new Date().toLocaleTimeString())+'] '+s; L.scrollTop=L.scrollHeight; setState(s); };
async function note(type, data={}){
  if(!SID) return;
  const q='mode=note&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)
        +'&msg='+encodeURIComponent(type+' '+JSON.stringify(data))+'&ua='+encodeURIComponent(navigator.userAgent||'');
  try{ await fetch(APP+(APP.includes('?')?'&':'?')+q); }catch(_){}
}
function hasStream(){ return !!(video.srcObject && video.videoWidth); }
function updateUI(){
  const s=!!SID, v=hasStream();
  // scatto/rec: sessione+stream
  ['btnSnap','btnReset','recStart'].forEach(id=> $(id).disabled = !(s && v));
  // salvataggi immagini
  $('savePng').disabled = !lastImgHasSrc;
  $('savePngEmail').disabled = $('savePng').disabled;
  // SM/PSI/snapshot: sessione
  ['smDim','btnSMPSI','btnSnapshot'].forEach(id=> $(id).disabled = !s);
  $('saveVideo').disabled = !('lastVideoB64' in window);
  $('btnFinish').disabled = !s;
}

/* ===== chiamate ===== */
async function GET(q){ const r=await fetch(APP+(APP.includes('?')?'&':'?')+q); if(!r.ok){throw new Error('HTTP '+r.status);} return r.json(); }
async function POST(body){ const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(body)}); if(!r.ok){throw new Error('HTTP '+r.status);} return r.json(); }

/* ===== Apertura + Condivisione ===== */
btnOpen.onclick = ()=>{
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  window.open(u, '_we_'+Date.now(), 'noopener,width=1280,height=900'); log('Scheda aperta. Ora “Condividi” e scegli quella scheda.');
};
btnShare.onclick = async ()=>{
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({video:{preferCurrentTab:true, displaySurface:'browser'}, audio:false});
    video.srcObject = stream; await video.play();
    log('Condivisione attiva (scheda/finestra/schermo).');
    note('PREVIEW_START',{surface: (stream.getVideoTracks()[0].getSettings()?.displaySurface||'')});
    stream.getVideoTracks()[0].addEventListener('ended', ()=>{ log('Condivisione terminata'); note('PREVIEW_END'); updateUI();});
  }catch(e){ alert('Condivisione negata: '+(e.message||e)); }
  updateUI();
};

/* ===== Fence ===== */
(function fence(){
  let drag=false,sx=0,sy=0;
  function bounds(e){ const r=wrap.getBoundingClientRect(); return {x:Math.max(0,Math.min(e.clientX-r.left,r.width)), y:Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  wrap.addEventListener('pointerdown', e=>{
    if(!lastImgHasSrc) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; wrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y;
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px',display:'block'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; const w=parseFloat(rect.style.width)||0,h=parseFloat(rect.style.height)||0; if(w<3&&h<3){rect.style.width='160px';rect.style.height='100px';} });
})();
btnReset.onclick = ()=>{ rect.style.display='none'; log('Selezione rimossa'); note('CROP_RESET'); };

/* ===== Start / Finish ===== */
btnStart.onclick = async ()=>{
  const cli=client.value.trim(), u=(addr.value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!u){ alert('URL obbligatoria'); return; }
  currentUrl=u; btnStart.dataset.on='1'; btnStart.disabled=true; setState('Creo sessione…');
  try{
    const js=await GET('mode=start&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)
      +'&client='+encodeURIComponent(cli)
      +'&ua='+encodeURIComponent(navigator.userAgent||'')
      +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
      +'&lang='+encodeURIComponent(navigator.language||'')
      +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)
      +'&page='+encodeURIComponent(location.href||''));
    if(!js.ok) throw new Error(js.error||'start failed');
    SID=js.sessionId; log('Sessione avviata: '+js.base+' (snapshot iniziale '+(js.snapshot?.saved||0)+' asset)'); note('SESSION_START_OK',{base:js.base});
  }catch(e){ alert('Errore start: '+e.message); btnStart.dataset.on='0'; btnStart.disabled=false; }
  updateUI();
};
btnFinish.onclick = async ()=>{
  if(!SID){ alert('Nessuna sessione'); return; }
  btnFinish.dataset.on='1'; btnFinish.disabled=true; setState('Creo ZIP…');
  try{
    const js=await GET('mode=finish&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)
      +(rcpts.value?('&to='+encodeURIComponent(rcpts.value)):'')
      +(subj.value?('&subj='+encodeURIComponent(subj.value)):''));
    if(!js.ok) throw new Error(js.error||'finish failed');
    log('ZIP: '+js.zipUrl); note('SESSION_FINISH',{zip:js.zipUrl}); setState('Completato');
    document.querySelectorAll('button').forEach(b=> b.disabled=true);
  }catch(e){ alert('Errore finish: '+e.message); btnFinish.dataset.on='0'; btnFinish.disabled=false; }
};

/* ===== Scatta (da stream) ===== */
btnSnap.onclick = ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!hasStream()){ alert('Attiva “Condividi finestra”'); return; }
  const vw=video.videoWidth, vh=video.videoHeight;
  const c=document.createElement('canvas'); c.width=vw; c.height=vh; c.getContext('2d').drawImage(video,0,0);
  img.src=c.toDataURL('image/png'); img.classList.add('hasSrc'); lastImgHasSrc=true; log('Frame acquisito (disegna una selezione per il crop se vuoi).'); note('FRAME_ACQUIRED',{vw,vh});
  updateUI();
};

/* ===== Registrazione ===== */
recStart.onclick = ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!hasStream()){ alert('Attiva “Condividi finestra”'); return; }
  chunks=[]; rec=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
  rec.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  rec.onstop=()=>{ const blob=new Blob(chunks,{type:'video/webm'}); const fr=new FileReader(); fr.onload=()=>{ window.lastVideoB64=String(fr.result); updateUI(); log('Video pronto da salvare'); note('REC_READY'); }; fr.readAsDataURL(blob); };
  rec.start(); recStart.disabled=true; recStop.disabled=false; log('REC…'); note('REC_START');
};
recStop.onclick = ()=>{ if(rec && rec.state!=='inactive') rec.stop(); recStart.disabled=false; recStop.disabled=true; log('REC stop'); note('REC_STOP'); };
saveVideo.onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!window.lastVideoB64){ alert('Nessun video'); return; }
  const u=(addr.value||currentUrl||'').trim();
  const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:window.lastVideoB64,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screen-record',label:'RECORDING'}}});
  if(!sv.ok){ alert(sv.error); return; }
  delete window.lastVideoB64; updateUI(); log('VIDEO salvato: '+sv.name+' sha='+sv.sha256); note('VIDEO_SAVED',{name:sv.name,sha:sv.sha256});
};

/* ===== Salva PNG (con/senza crop) ===== */
function makePayload(){
  if(!lastImgHasSrc) return null;
  const nW=img.naturalWidth, nH=img.naturalHeight; const c=document.createElement('canvas'), ctx=c.getContext('2d');
  const hasSel = rect.style.display!=='none' && (parseFloat(rect.style.width)||0)>1 && (parseFloat(rect.style.height)||0)>1;
  if(!hasSel){ c.width=nW; c.height=nH; ctx.drawImage(img,0,0); return {dataUrl:c.toDataURL('image/png'), crop:null, label:'FRAME_FULL'}; }
  const dW=img.clientWidth, dH=img.clientHeight;
  const rx=Math.round(parseFloat(rect.style.left)*nW/dW);
  const ry=Math.round(parseFloat(rect.style.top )*nH/dH);
  const rw=Math.round(parseFloat(rect.style.width)*nW/dW);
  const rh=Math.round(parseFloat(rect.style.height)*nH/dH);
  c.width=Math.max(1,rw); c.height=Math.max(1,rh); ctx.drawImage(img,rx,ry,rw,rh,0,0,c.width,c.height);
  return {dataUrl:c.toDataURL('image/png'), crop:{x:rx,y:ry,w:c.width,h:c.height,naturalW:nW,naturalH:nH}, label:'FRAME_CROP'};
}
async function savePNG(sendMail){
  if(!SID){ alert('Avvia certificazione'); return; }
  const p = makePayload(); if(!p){ alert('Nessuna immagine'); return; }
  const u=(addr.value||currentUrl||'').trim();
  const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:p.dataUrl,sendEmail:sendMail,recipients:rcpts.value||undefined,subject:subj.value||undefined,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screen-capture',label:p.label},crop:p.crop}});
  if(!sv.ok){ alert(sv.error); return; }
  log((sendMail?'PNG inviato e ':'PNG ')+'salvato: '+sv.name+' sha='+sv.sha256); note('PNG_SAVED',{name:sv.name,sha:sv.sha256});
}
savePng.onclick = ()=> savePNG(false);
savePngEmail.onclick = ()=> savePNG(true);

/* ===== SM+PSI in un click ===== */
btnSMPSI.onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||currentUrl||'').trim();
  const dim=smDim.value;
  try{
    setState('SM full-page…');
    let js=await GET('mode=sm&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)+'&dim='+encodeURIComponent(dim));
    if(!js.ok) throw new Error(js.error||'SM failed');
    let sv=await POST({authToken:TOKEN,sid:SID,dataUrl:js.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:js.meta}});
    if(!sv.ok) throw new Error(sv.error||'save SM failed');
    log('SM salvato: '+sv.name+' sha='+sv.sha256); note('SM_SAVED',{name:sv.name,sha:sv.sha256});

    setState('PSI…');
    js=await GET('mode=psi&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u));
    if(!js.ok) throw new Error(js.error||'PSI failed');
    sv=await POST({authToken:TOKEN,sid:SID,dataUrl:js.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:js.meta}});
    if(!sv.ok) throw new Error(sv.error||'save PSI failed');
    log('PSI salvato: '+sv.name+' sha='+sv.sha256); note('PSI_SAVED',{name:sv.name,sha:sv.sha256});
    setState('Pronto');
  }catch(e){ alert(e.message); setState('Errore'); }
};

/* ===== Deep Snapshot manuale ===== */
btnSnapshot.onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||currentUrl||'').trim(); setState('Snapshot…');
  const js=await GET('mode=snapshot&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)+'&u='+encodeURIComponent(u));
  if(!js.ok){ alert(js.error); setState('Errore'); return; }
  log('Snapshot salvato (asset='+js.assets+')'); note('SNAPSHOT_SAVED',{assets:js.assets}); setState('Pronto');
};

/* ===== Boot ===== */
updateUI();
</script>
</body>
</html>
