<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence – v14.5</title>
<style>
  :root{--bd:#ddd;--accent:#0b5cff}
  *{box-sizing:border-box}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0;color:#111;background:#fff}
  header{display:grid;grid-template-columns:170px 1fr auto auto 260px 1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:10px}
  input,button,select{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fafafa}
  input[type="url"], input[type="text"]{background:#fff}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  #state{justify-self:end;font-size:12px;color:#222;background:#f3f4f6;border-radius:999px;padding:.25rem .6rem}

  /* layout: preview (left) + center (controls+capture) + log (right) */
  .wrap{display:grid;grid-template-columns:320px 1fr 340px;gap:12px;padding:12px}
  .card{border:1px solid #eee;border-radius:12px;background:#fff}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #f3f4f4;font-size:13px;font-weight:700}

  .side{padding:12px}
  #thumb{width:300px;height:300px;display:block;background:#1b1b1b;border:1px dashed #ccc;border-radius:10px}

  .controls{display:flex;flex-direction:column;gap:10px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .capture{grid-column:2}
  .cap-wrap{position:relative;padding:12px}
  #imgLarge{max-width:100%;display:none;border-radius:12px;border:1px solid #eee;background:#000}
  #imgLarge.hasSrc{display:block}
  /* Fence senza overlay grigio */
  #rect{position:absolute;border:2px dashed #fff;display:none;pointer-events:none}

  /* right log panel */
  .logcol{grid-column:3; display:flex; flex-direction:column; gap:10px}
  #log{height:78vh;border:1px solid #eee;border-radius:10px;padding:8px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}

  .mut{color:#666}
</style>
</head>
<body>

<header>
  <input id="client" placeholder="Cliente…" />
  <input id="addr" type="url" placeholder="https://…" />
  <button id="btnOpen" type="button">Apri sito in finestra</button>
  <button id="btnPreview" class="primary" type="button" disabled>Condividi</button>

  <input id="rcpts" placeholder="Destinatari PEC/email" />
  <input id="subj" value="Web Evidence – Pacchetto prove" />
  <select id="pecMode" title="Modalità invio PEC">
    <option value="normal" selected>PEC normale</option>
    <option value="key">PEC via KEY</option>
    <option value="auto">PEC auto</option>
  </select>
  <button id="btnStart" type="button">Inizia certificazione</button>
  <button id="btnFinish" type="button" disabled>Termina</button>

  <span id="state">Pronto</span>
</header>

<div class="wrap">
  <!-- Colonna sinistra: ANTEPRIMA LIVE 300×300 -->
  <div class="card side" style="grid-column:1">
    <h3>Anteprima LIVE (300×300)</h3>
    <canvas id="thumb" width="300" height="300" aria-label="Anteprima"></canvas>
    <div class="mut" style="margin-top:8px">1) Apri sito → 2) Condividi → 3) Scatta</div>
  </div>

  <!-- Colonna centrale: CONTROLLI -->
  <div class="card" style="grid-column:2">
    <h3>Controlli</h3>
    <div class="controls">
      <div class="row">
        <button id="btnSnap" type="button">Scatta</button>
        <button id="btnSave" class="primary" type="button" disabled>Salva</button>
        <button id="btnReset" type="button">Reset</button>
      </div>
      <div class="row">
        <button id="btnFull" type="button" disabled>Screenshot cattura completa</button>
        <button id="btnAssets" type="button" disabled>Scarica asset</button>
      </div>
    </div>
  </div>

  <!-- Finestra di cattura (immagine scattata + fence) -->
  <div class="card capture">
    <h3>Finestra di cattura (scatto)</h3>
    <div class="cap-wrap" id="capWrap">
      <img id="imgLarge" alt="Scatto"/>
      <div id="rect"></div>
    </div>
  </div>

  <!-- Colonna destra: LOG -->
  <div class="logcol">
    <div class="card">
      <h3>Log</h3>
      <div id="log"></div>
    </div>
  </div>
</div>

<script>
/* ===== Query ===== */
const qs=new URLSearchParams(location.search);
const APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
if(qs.get('u')) addr.value=qs.get('u');
if(qs.get('client')) client.value=qs.get('client');
if(qs.get('dom')) client.dataset.domain=qs.get('dom');
if(qs.get('domain')) client.dataset.domain=qs.get('domain');
if(qs.get('to')) rcpts.value=qs.get('to');
if(qs.get('email')) rcpts.value=qs.get('email');
if(qs.get('subj')) subj.value=qs.get('subj');
if(qs.get('pecMode')) document.getElementById('pecMode').value=qs.get('pecMode');

/* ===== Stato ===== */
let SID=''; let stream=null; let rafId=null; let hasShot=false;

const $ = id => document.getElementById(id);
const video = document.createElement('video'); video.autoplay=true; video.muted=true; video.playsInline=true;
const thumb=$('thumb'), imgLarge=$('imgLarge'), rect=$('rect'), capWrap=$('capWrap');

/* ===== Helpers ===== */
const setState = s => $('state').textContent=s;
const log = s => { const L=$('log'); L.textContent+=(L.textContent?'\\n':'')+'['+(new Date().toLocaleTimeString())+'] '+s; L.scrollTop=L.scrollHeight; setState(s); };
async function note(type, data={}){ if(!SID) return; const q='mode=note&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)+'&msg='+encodeURIComponent(type+' '+JSON.stringify(data)); try{ await fetch(APP+(APP.includes('?')?'&':'?')+q); }catch(_){}}; 
function hasStream(){ return !!(video.srcObject && video.videoWidth); }
function parseHost(u){ try{ return new URL(u).hostname.replace(/^www\\./,''); }catch(e){ const a=document.createElement('a'); a.href=u; return (a.hostname||'').replace(/^www\\./,''); } }

function drawPreview(){
  if(!hasStream()){ rafId=requestAnimationFrame(drawPreview); return; }
  const ctx=thumb.getContext('2d'); const tw=thumb.width, th=thumb.height; const vw=video.videoWidth, vh=video.videoHeight; if(!vw||!vh){ rafId=requestAnimationFrame(drawPreview); return; }
  ctx.clearRect(0,0,tw,th);
  const br=vw/vh; let dw=tw, dh=tw/br; if(dh>th){ dh=th; dw=th*br; } const dx=(tw-dw)/2, dy=(th-dh)/2;
  ctx.drawImage(video, dx, dy, dw, dh);
  rafId=requestAnimationFrame(drawPreview);
}

/* ===== Apri sito in finestra + Condividi ===== */
function openClean(u){
  const url=(u||'').trim(); if(!url){ alert('URL obbligatoria'); return; }
  const features='noopener,noreferrer,width=1280,height=900,menubar=no,toolbar=no,location=no,status=no';
  window.open(url, '_we_clean_'+Date.now(), features);
  $('btnPreview').disabled=false; // ora puoi condividere
  log('Finestra/pagina aperta.');
}
$('btnOpen').addEventListener('click', ()=> openClean(addr.value));

$('btnPreview').onclick = async ()=>{
  try{
    const constraints={video:{displaySurface:'window',preferCurrentTab:true},audio:false};
    stream = await navigator.mediaDevices.getDisplayMedia(constraints);
    video.srcObject = stream; await video.play();
    if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(drawPreview);
    log('Condivisione attiva (anteprima LIVE in alto a sinistra).');
    stream.getVideoTracks()[0].addEventListener('ended', ()=>{ log('Condivisione terminata'); if(rafId){ cancelAnimationFrame(rafId); rafId=null; } });
    note('PREVIEW_START');
  }catch(e){ alert('Condivisione negata: '+(e.message||e)); }
};

/* ===== Sessione ===== */
async function GET(q){ const r=await fetch(APP+(APP.includes('?')?'&':'?')+q); return r.json(); }
async function POST(body){ const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(body)}); return r.json(); }

$('btnStart').onclick = async ()=>{
  const cli=client.value.trim(), u=(addr.value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!u){ alert('URL obbligatoria'); return; }
  const full=0, assets=0; // ora gestiti da pulsanti dedicati
  let domOverride = client.dataset.domain||parseHost(u);
  setState('Creo sessione…');
  const js=await GET('mode=start&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)
    +'&client='+encodeURIComponent(cli)
    +(domOverride?('&domain='+encodeURIComponent(domOverride)):'')
    +'&full='+full+'&assets='+assets
    +'&ua='+encodeURIComponent(navigator.userAgent||'')
    +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
    +'&lang='+encodeURIComponent(navigator.language||'')
    +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)
    +'&page='+encodeURIComponent(location.href||''));
  if(!js.ok){ alert(js.error||'Errore avvio'); setState('Errore'); return; }
  SID=js.sessionId; $('btnFinish').disabled=false; $('btnFull').disabled=false; $('btnAssets').disabled=false;
  log('Sessione: '+js.base); setState('Pronto'); note('SESSION_START',{base:js.base});
};

/* ===== Azioni: Full page (SM) e Asset ===== */
$('btnFull').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  log('Eseguo Screenshot cattura completa…');
  try{
    const sm=await GET('mode=sm&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)+'&dim=1920xfull');
    if(!sm.ok){ throw new Error(sm.error||'SM error'); }
    const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:sm.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screenshotmachine',label:'SM_FULL'}}});
    if(!sv.ok) throw new Error(sv.error||'Save error');
    log('Full-page salvato: '+sv.name+' sha='+sv.sha256); note('SM_FULL_SAVED',{name:sv.name,sha:sv.sha256});
  }catch(e){ log('Errore full-page: '+(e.message||e)); }
};

$('btnAssets').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  log('Scarico asset…');
  try{
    const sj=await GET('mode=snapshot&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)+'&u='+encodeURIComponent(u));
    if(!sj.ok) throw new Error(sj.error||'Snapshot error');
    log('HTML+asset salvati.'); note('ASSETS_SAVED');
  }catch(e){ log('Errore asset: '+(e.message||e)); }
};

/* ===== Fence + Scatto ===== */
(function fence(){
  let drag=false,sx=0,sy=0;
  function bounds(e){ const r=capWrap.getBoundingClientRect(); return {x:Math.max(0,Math.min(e.clientX-r.left,r.width)), y:Math.max(0,Math.min(e.clientY-r.top,r.height))}; }
  capWrap.addEventListener('pointerdown', e=>{
    if(!imgLarge.classList.contains('hasSrc')) return;
    if(e.button!==0 && e.pointerType==='mouse') return;
    e.preventDefault(); drag=true; capWrap.setPointerCapture?.(e.pointerId);
    const p=bounds(e); sx=p.x; sy=p.y; rect.style.display='block';
    Object.assign(rect.style,{left:sx+'px',top:sy+'px',width:'0px',height:'0px'});
  });
  window.addEventListener('pointermove', e=>{
    if(!drag) return; const p=bounds(e);
    rect.style.left=Math.min(p.x,sx)+'px'; rect.style.top=Math.min(p.y,sy)+'px';
    rect.style.width=Math.abs(p.x-sx)+'px'; rect.style.height=Math.abs(p.y-sy)+'px';
  });
  window.addEventListener('pointerup', ()=>{ drag=false; });
})();

$('btnSnap').onclick = async ()=>{
  if(!hasStream()){ alert('Attiva “Condividi”'); return; }
  try{
    const track=stream.getVideoTracks()[0]; const cap=new ImageCapture(track);
    const bitmap=await cap.grabFrame();
    const c=document.createElement('canvas'); c.width=bitmap.width; c.height=bitmap.height; c.getContext('2d').drawImage(bitmap,0,0);
    imgLarge.src=c.toDataURL('image/png'); imgLarge.classList.add('hasSrc'); rect.style.display='none';
    hasShot=true; $('btnSave').disabled=false;
    log('Scatto eseguito → immagine grande pronta.'); note('SNAP_OK',{w:bitmap.width,h:bitmap.height});
  }catch(e){ log('Errore scatto: '+(e.message||e)); }
};

function makePayload(){
  if(!imgLarge.classList.contains('hasSrc')) return null;
  const natW=imgLarge.naturalWidth, natH=imgLarge.naturalHeight;
  const dispW=imgLarge.clientWidth, dispH=imgLarge.clientHeight;
  const rx=parseFloat(rect.style.left)||0, ry=parseFloat(rect.style.top)||0;
  const rw=parseFloat(rect.style.width)||0, rh=parseFloat(rect.style.height)||0;
  const needCrop = rect.style.display!=='none' && rw>2 && rh>2;

  const c=document.createElement('canvas'); const ctx=c.getContext('2d');
  if(!needCrop){
    c.width=natW; c.height=natH; const tmp=new Image(); tmp.src=imgLarge.src;
    return new Promise(res=>{ tmp.onload=()=>{ ctx.drawImage(tmp,0,0); res({dataUrl:c.toDataURL('image/png'), crop:null}); }; });
  }
  const ax=Math.round(rx*natW/dispW), ay=Math.round(ry*natH/dispH);
  const aw=Math.round(rw*natW/dispW), ah=Math.round(rh*natH/dispH);
  c.width=Math.max(1,aw); c.height=Math.max(1,ah); const tmp=new Image(); tmp.src=imgLarge.src;
  return new Promise(res=>{ tmp.onload=()=>{ ctx.drawImage(tmp,ax,ay,aw,ah,0,0,c.width,c.height); res({dataUrl:c.toDataURL('image/png'), crop:{x:ax,y:ay,w:aw,h:ah,naturalW:natW,naturalH:natH}}); }; });
}

$('btnSave').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  if(!hasShot){ alert('Fai prima uno scatto'); return; }
  const payload = await makePayload(); if(!payload){ alert('Nessuna immagine'); return; }
  const u=(addr.value||'').trim();
  const sv=await POST({authToken:TOKEN,sid:SID,dataUrl:payload.dataUrl,sendEmail:false,meta:{url:u,finalUrl:u,sourceMeta:{provider:'screen-capture',label:(payload.crop?'FRAME_CROP':'FRAME_FULL')},crop:payload.crop}});
  if(!sv.ok){ alert(sv.error||'Errore salvataggio'); return; }
  log('PNG salvato: '+sv.name+' sha='+sv.sha256); note('PNG_SAVED',{name:sv.name,sha:sv.sha256});
};

$('btnReset').onclick = ()=>{
  const tctx=thumb.getContext('2d'); tctx.clearRect(0,0,thumb.width,thumb.height);
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){} stream=null; }
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  imgLarge.removeAttribute('src'); imgLarge.classList.remove('hasSrc'); rect.style.display='none';
  hasShot=false; $('btnSave').disabled=true;
  log('Reset effettuato'); note('RESET');
};

setState('Pronto');
</script>
</body>
</html>
