/***** Web Evidence — v10 (sessioni, Deep Snapshot, SM/PSI, PNG/WEBM, MANIFEST+ZIP, email) *****/

const DATA_SHEET = 'DATA';
const CELL_SM_KEY = 'B1';
const CELL_PSI_KEY = 'B2';
const CELL_EMAIL  = 'B3';
const CELL_SUBJ   = 'B4';
const CELL_FOLDER = 'B5';   // opzionale override
const CELL_TOKEN  = 'B7';
const ROOT_FOLDER_ID = '';  // opzionale cartella radice su Drive

/* ===================== ROUTER ===================== */

function doGet(e){
  try {
    const mode = String(e.parameter.mode||'').toLowerCase();
    if (!mode) return _json({ok:false, error:'Missing mode'});

    // proteggi tutte le azioni “mutanti”
    const needsTok = ['start','sm','psi','snapshot','finish','note'].includes(mode);
    if (needsTok) _requireToken(String(e.parameter.t||''));

    if (mode==='start')    return _json(_startSession(e));
    if (mode==='sm')       return _json(_getSM(e));
    if (mode==='psi')      return _json(_getPSI(e));
    if (mode==='snapshot') return _json(_snapshot(e));
    if (mode==='finish')   return _json(_finish(e));
    if (mode==='note')     return _json(_serverNote(e)); // append a _events.log.txt

    return _json({ok:false, error:'Unknown mode'});
  } catch (err) {
    return _json({ok:false, error:String(err && err.message || err)});
  }
}

function doPost(e){
  try{
    const body = e.postData ? e.postData.contents : '';
    const obj  = JSON.parse(body || '{}');

    _requireToken(String(obj.authToken||''));
    const sid = String(obj.sid||'').trim();
    if (!sid) throw new Error('Missing sid');

    const res = _saveInSession(
      sid,
      obj.fileNameHint || `capture_${Date.now()}.png`,
      obj.dataUrl,                        // data:image/... o data:video/webm
      obj.meta || {},                     // {url,finalUrl,sourceMeta{provider,dimension,label},crop}
      !!obj.sendEmail,
      obj.recipients || '',
      obj.subject || ''
    );
    return _json({ok:true, ...res});
  }catch(err){
    return _json({ok:false, error:String(err && err.message || err)});
  }
}

function _json(o){ return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); }

/* ===================== START (cartella + Deep Snapshot) ===================== */

function _startSession(e){
  const rawU = String(e.parameter.u||'').trim(); if (!rawU) throw new Error('Missing u');
  const url  = _coerceUrl(rawU);

  // dominio robusto lato server
  let domain = '';
  try{ domain = new URL(url).hostname || ''; }catch(_){}
  if (!domain){
    const m = url.match(/^[a-z]+:\/\/([^/]+)/i);
    domain = m ? m[1] : 'no-host';
  }
  const client = _sanitize(String(e.parameter.client||'').trim() || 'cliente');

  const nowIso = new Date().toISOString();
  const root = ROOT_FOLDER_ID ? DriveApp.getFolderById(ROOT_FOLDER_ID) : DriveApp.getRootFolder();
  const baseName = `${client}__${_sanitize(domain)}__${_fmtDateIt(nowIso)}__${_fmtTimeIt(nowIso)}`;

  // override manuale opzionale (DATA!B5)
  const ov = _getFolderOverride();
  const finalName = ov ? `${_sanitize(ov)}__${_fmtDateIt(nowIso)}__${_fmtTimeIt(nowIso)}` : baseName;

  const sess = root.createFolder(finalName);

  // contesto iniziale
  const details = {
    url, domain, client,
    startedAt: nowIso,
    userAgent: String(e.parameter.ua||''),
    timezone:  String(e.parameter.tz||''),
    language:  String(e.parameter.lang||''),
    viewport: { vw:+(e.parameter.vw||0), vh:+(e.parameter.vh||0) },
    screen:   { sw:+(e.parameter.sw||0), sh:+(e.parameter.sh||0), dpr:+(e.parameter.dpr||0) },
    pageUrl: String(e.parameter.page||'')
  };
  _writeJson(sess, '_manifest_start.json', details);
  _writeJson(sess, '_index.json', []);
  _appendEvent(sess, 'SESSION_START', { url, client, domain });

  // DNS A/AAAA
  try {
    const a = UrlFetchApp.fetch('https://dns.google/resolve?name='+encodeURIComponent(domain)+'&type=A',    {muteHttpExceptions:true,timeout:10000});
    const b = UrlFetchApp.fetch('https://dns.google/resolve?name='+encodeURIComponent(domain)+'&type=AAAA', {muteHttpExceptions:true,timeout:10000});
    _writeJson(sess, 'dns.json', {
      domain,
      A:(JSON.parse(a.getContentText()).Answer||[]).map(r=>r.data),
      AAAA:(JSON.parse(b.getContentText()).Answer||[]).map(r=>r.data),
      at: nowIso
    });
  }catch(_){}

  // Deep snapshot iniziale (HTML+HEADERS+ASSET)
  const first = _takeDeepSnapshot(sess, url, 'start');

  _regenerateIndexHtml(sess);
  return { ok:true, sessionId: sess.getId(), base: sess.getName(), snapshot: first };
}

/* ===================== EXTERNAL FETCH (SM / PSI) ===================== */

function _getSM(e){
  const url = _coerceUrl(String(e.parameter.u||'')); if(!url) throw new Error('Missing u');
  const dim = String(e.parameter.dim||'1920xfull').trim();
  const key = _getSMKey();
  const q = { key, url, dimension: dim, delay: 6000, cacheLimit: 0, format: 'png' };
  const api = 'https://api.screenshotmachine.com?' + _toQuery(q);

  const r = UrlFetchApp.fetch(api, { muteHttpExceptions:true, followRedirects:true, timeout:120000 });
  if (r.getResponseCode()>=400) throw new Error(`SM ${dim} HTTP ${r.getResponseCode()} – ${r.getContentText().slice(0,300)}`);

  const b64 = Utilities.base64Encode(r.getBlob().getBytes());
  return {
    ok:true,
    dataUrl: 'data:image/png;base64,' + b64,
    meta: { provider:'screenshotmachine',
            dimension: dim,
            label: /\bfull\b/i.test(dim) ? `SM_FULL(${dim})` : `SM_VIEW(${dim})`,
            request: api.replace(/([?&]key=)[^&]+/i,'$1***') }
  };
}

function _getPSI(e){
  const url = _coerceUrl(String(e.parameter.u||'')); if(!url) throw new Error('Missing u');
  const key = _getPSIKey();
  const api = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed?category=performance&strategy=desktop'
            + '&url=' + encodeURIComponent(url) + '&key=' + encodeURIComponent(key);

  const r = UrlFetchApp.fetch(api, { muteHttpExceptions:true, followRedirects:true, timeout:60000 });
  if (r.getResponseCode()>=400) throw new Error(`PSI HTTP ${r.getResponseCode()} – ${r.getContentText().slice(0,300)}`);

  const obj = JSON.parse(r.getContentText());
  const audits = obj?.lighthouseResult?.audits || {};
  const full  = audits['full-page-screenshot']?.details?.screenshot?.data;
  const final = audits['final-screenshot']?.details?.data;
  const thumb = audits['screenshot-thumbnails']?.details?.items?.[0]?.data;
  const dataUrl = full || final || thumb;
  if (!dataUrl) throw new Error('PSI: nessuno screenshot disponibile');

  const mode = full ? 'FULLPAGE' : final ? 'FINAL' : 'THUMB';
  return { ok:true, dataUrl, meta: { provider:'psi', label:`PSI_${mode}`, dimension: mode } };
}

/* ===================== SNAPSHOT (HTML+HEADERS+ASSET) ===================== */

function _snapshot(e){
  const sid = String(e.parameter.id||'').trim(); if (!sid) throw new Error('Missing id');
  const url = _coerceUrl(String(e.parameter.u||'')); if(!url) throw new Error('Missing u');
  const sess = DriveApp.getFolderById(sid);
  const info = _takeDeepSnapshot(sess, url, 'manual');
  _appendEvent(sess, 'SNAPSHOT', info);
  _updateIndex(sess, {
    url: info.url, finalUrl: info.finalUrl, canonical:'',
    timestamp: new Date().toISOString(),
    sha256:'', type:'snapshot', name: info.folder, driveUrl: info.folderUrl,
    source:{provider:'snapshot', dimension: info.saved+' assets', label:'SNAPSHOT'}, crop:null
  });
  return { ok:true, assets: info.saved, folderUrl: info.folderUrl };
}

// “Deep” snapshot riutilizzabile
function _takeDeepSnapshot(sessFolder, url, tag){
  const ts = _fmtTsFiles(new Date().toISOString());
  const snapRoot = (function(){
    const it = sessFolder.getFoldersByName('snapshot');
    return it.hasNext()? it.next() : sessFolder.createFolder('snapshot');
  })();
  const sub = snapRoot.createFolder(`snapshot_${ts}__${tag||''}`);

  const resp = UrlFetchApp.fetch(url, {muteHttpExceptions:true, followRedirects:true, validateHttpsCertificates:true, timeout:30000});
  const code = resp.getResponseCode();
  const finalUrl = resp.getHeaders()['X-Final-Url'] || url;
  const headers = resp.getAllHeaders ? resp.getAllHeaders() : resp.getHeaders();
  const htmlBytes = resp.getContent();
  const htmlText  = Utilities.newBlob(htmlBytes,'text/html').getDataAsString('UTF-8');
  const htmlSha   = _shaHex(htmlBytes);

  _writeJson(sub, 'HEADERS.json', {code, url, finalUrl, headers, html_sha256: htmlSha});
  sub.createFile(Utilities.newBlob(htmlBytes,'text/html','PAGE.html'));

  // Estrai asset (img/css/video/audio) con limiti
  const maxFiles = 120, maxBytes = 25*1024*1024; // ~25MB budget
  const assets = _extractAssets(htmlText, finalUrl, maxFiles, maxBytes);
  let saved = 0;
  for (const a of assets){
    sub.createFile(a.blob);
    saved++;
  }

  return { url, finalUrl, folder: sub.getName(), folderUrl: sub.getUrl(), saved, html_sha256: htmlSha };
}

// parser molto pratico (img/src, srcset, link rel=stylesheet/preload, video/source, bg-image inline)
function _extractAssets(html, baseUrl, maxFiles, maxTotalBytes){
  function resolve(h){
    try{
      if (/^https?:\/\//i.test(h)) return h;
      if (h.startsWith('//')) return 'https:'+h;
      const b = new URL(baseUrl);
      if (h.startsWith('/')) return b.origin + h;
      return new URL(h, b.href).href;
    }catch(_){ return null; }
  }
  function extFromCT(ct){
    const c = (ct||'').toLowerCase();
    if (c.includes('image/jpeg') || c.includes('image/jpg')) return '.jpg';
    if (c.includes('image/png'))  return '.png';
    if (c.includes('image/webp')) return '.webp';
    if (c.includes('image/gif'))  return '.gif';
    if (c.includes('image/svg'))  return '.svg';
    if (c==='text/css' || c.includes('text/css')) return '.css';
    if (c.includes('video/mp4'))  return '.mp4';
    if (c.includes('video/webm')) return '.webm';
    if (c.includes('audio/')) return '.audio';
    return '';
  }

  const urls = new Set();

  html.replace(/<(?:img|source|video)\b[^>]*?\bsrc\s*=\s*["']([^"']+)["']/ig,(m,u)=>{urls.add(u);return m;});
  html.replace(/<img\b[^>]*?\bsrcset\s*=\s*["']([^"']+)["']/ig,(m,set)=>{
    const best = String(set).split(',').map(s=>s.trim()).map(s=>s.split(/\s+/)[0]).filter(Boolean)[0];
    if (best) urls.add(best); return m;
  });
  html.replace(/<link\b[^>]*rel=["'](?:stylesheet|preload)["'][^>]*\bhref=["']([^"']+)["'][^>]*>/ig,(m,u)=>{urls.add(u);return m;});
  html.replace(/style\s*=\s*["'][^"']*?background-image\s*:\s*url\(([^)]+)\)[^"']*?["']/ig,(m,u)=>{ urls.add(u.replace(/^['"]|['"]$/g,'')); return m; });

  const list = Array.from(urls).map(resolve).filter(Boolean);
  const out = [];
  let total = 0, idx=0;
  for (const u of list){
    if (out.length>=maxFiles) break;
    try{
      const r = UrlFetchApp.fetch(u, {muteHttpExceptions:true,followRedirects:true,timeout:20000});
      if (r.getResponseCode()>=400) continue;
      const blob = r.getBlob();
      const ct = (blob.getContentType()||'').toLowerCase();
      const bytes = blob.getBytes();
      if (total + bytes.length > maxTotalBytes) break;
      total += bytes.length;
      const ext = extFromCT(ct) || '';
      const name = `ASSET_${String(++idx).padStart(3,'0')}${ext}`;
      out.push({ blob: Utilities.newBlob(bytes, ct||'application/octet-stream', name) });
    }catch(_){}
  }
  return out;
}

/* ===================== SAVE IN SESSION (PNG/WEBM) ===================== */

function _saveInSession(sid, fileNameHint, dataUrl, meta, sendEmail, recipients, subject){
  if (!/^data:(image\/(png|jpeg)|video\/webm);base64,/i.test(dataUrl)) throw new Error('Formato data URL non supportato (png/jpeg/webm)');
  const [, mime] = dataUrl.match(/^data:([^;]+);base64,/i) || [];
  const bytes = Utilities.base64Decode(String(dataUrl).split(',')[1]);
  const isVideo = /^video\/webm/i.test(mime);
  const ext = isVideo ? 'webm' : 'png';

  const sess = DriveApp.getFolderById(sid);

  const sha  = _shaHex(bytes);
  const nowIso = new Date().toISOString();

  const label = _sanitize(meta?.sourceMeta?.label || (isVideo?'RECORDING':'FRAME'));
  const base  = `${label}__${_fmtTsFiles(nowIso)}__sha_${sha.slice(0,12)}`;
  const fileName = base + '.' + ext;
  const jsonName = base + '.json';

  const file = sess.createFile(Utilities.newBlob(bytes, mime, fileName));
  const info = {
    url: String(meta?.url||'').trim(),
    finalUrl: String(meta?.finalUrl||meta?.url||'').trim(),
    canonical: String(meta?.canonical||'').trim(),
    driveFileId: file.getId(),
    driveUrl: file.getUrl(),
    sha256: sha,
    timestamp: nowIso,
    source: meta?.sourceMeta || {},
    crop: meta?.crop || null
  };
  _writeJson(sess, jsonName, info);

  _appendEvent(sess, 'SAVE', { file:fileName, bytes: bytes.length, sha256: sha, label });
  _updateIndex(sess, {
    url: info.url, finalUrl: info.finalUrl, canonical: info.canonical,
    timestamp: nowIso, sha256: sha, type: isVideo?'video':'image',
    name: fileName, driveUrl: file.getUrl(),
    source: info.source, crop: info.crop
  });

  // email opzionale
  let emailedTo='', usedSubject='';
  if (sendEmail){
    const defs = _getEmailDefaults();
    const to   = (recipients || defs.to || '').trim();
    const subj = (subject && subject.trim()) || defs.subject || 'Web Evidence – Cattura';
    if (!to) throw new Error('Nessun destinatario (DATA!B3 o parametro “recipients”).');

    const htmlBody = `<div style="font:14px Arial">
      <p><b>Web Evidence – ${isVideo?'Video':'Screenshot'}</b></p>
      <p><b>Label:</b> ${label}</p>
      <p><b>URL:</b> <a href="${info.url||info.finalUrl}" target="_blank" rel="noopener">${info.url||info.finalUrl}</a></p>
      <p><b>SHA-256:</b> <code>${sha}</code></p>
      <p><b>Drive:</b> <a href="${info.driveUrl}" target="_blank" rel="noopener">${fileName}</a></p>
      <hr/><p>Allegati: ${isVideo?'WEBM':'PNG'} + metadati JSON.</p>
    </div>`;

    try{
      GmailApp.sendEmail(to, subj, 'Vedi HTML', {
        htmlBody,
        attachments: [
          Utilities.newBlob(bytes, mime, fileName),
          Utilities.newBlob(JSON.stringify(info,null,2),'application/json',jsonName)
        ],
        name:'Web Evidence Bot'
      });
    }catch(_){
      MailApp.sendEmail({ to, subject:subj, htmlBody,
        attachments:[
          Utilities.newBlob(bytes, mime, fileName),
          Utilities.newBlob(JSON.stringify(info,null,2),'application/json',jsonName)
        ],
        name:'Web Evidence Bot'
      });
    }
    emailedTo = to; usedSubject = subj;
  }

  return { id:file.getId(), name:fileName, url:file.getUrl(), sha256:sha, emailedTo, subject:usedSubject };
}

/* ===================== FINISH (MANIFEST + ZIP + EMAIL) ===================== */

function _finish(e){
  const sid = String(e.parameter.id||'').trim(); if (!sid) throw new Error('Missing id/sid');
  const sess = DriveApp.getFolderById(sid);

  const nowIso = new Date().toISOString();
  _appendEvent(sess, 'SESSION_END', { endedAt: nowIso });
  _writeJson(sess, '_manifest_end.json', { endedAt: nowIso });

  // MANIFEST.txt con tutti i file + SHA
  const listing = _listRecursive(sess, '');
  const lines = listing.map(it=> `${it.sha256}  ${it.path}`);
  sess.createFile(Utilities.newBlob(lines.join('\n')+'\n','text/plain','MANIFEST.txt'));

  _regenerateIndexHtml(sess);

  // ZIP dell’intera sessione
  const zipped = Utilities.zip(listing.map(it => Utilities.newBlob(it.bytes, it.mime, it.path)), sess.getName() + '__bundle.zip');
  const zipFile = sess.createFile(zipped);
  _appendEvent(sess, 'ZIP', { file: zipFile.getName(), bytes: zipped.getBytes().length });

  // email opzionale
  let to = String(e.parameter.to||'').trim();
  if (!to) to = (_getEmailDefaults().to||'').trim();
  if (to){
    const subj = (String(e.parameter.subj||'').trim()) || (_getEmailDefaults().subject||'Web Evidence – Bundle sessione');
    const htmlBody = `<div style="font:14px Arial">
      <p><b>Web Evidence – Bundle sessione</b></p>
      <p><b>Cartella:</b> ${sess.getName()}</p>
      <p><b>ZIP:</b> <a href="${zipFile.getUrl()}" target="_blank" rel="noopener">${zipFile.getName()}</a></p>
    </div>`;
    try { GmailApp.sendEmail(to, subj, 'Vedi HTML', {htmlBody, attachments:[zipFile.getBlob()], name:'Web Evidence Bot'}); }
    catch(_){ MailApp.sendEmail({to, subject:subj, htmlBody, attachments:[zipFile.getBlob()], name:'Web Evidence Bot'}); }
  }

  return { ok:true, zipUrl: zipFile.getUrl() };
}

/* ===================== NOTE (log da frontend) ===================== */
function _serverNote(e){
  const sid = String(e.parameter.id||'').trim(); if (!sid) throw new Error('Missing id');
  const msg = String(e.parameter.msg||'').trim();
  const ua  = String(e.parameter.ua||'');
  const sess = DriveApp.getFolderById(sid);
  _appendEvent(sess, 'NOTE', { msg, ua });
  return { ok:true };
}

/* ===================== INDEX / LOG ===================== */

function _appendEvent(folder, type, data){
  const name = '_events.log.txt';
  const line = `${new Date().toISOString()}\t${type}\t${JSON.stringify(data)}\n`;
  const it = folder.getFilesByName(name);
  if (it.hasNext()){
    const f = it.next(); f.setContent(f.getBlob().getDataAsString() + line);
  } else {
    folder.createFile(name, line, MimeType.PLAIN_TEXT);
  }
}

function _updateIndex(folder, entry){
  let list = [];
  const it = folder.getFilesByName('_index.json');
  if (it.hasNext()) list = JSON.parse(it.next().getBlob().getDataAsString('UTF-8')||'[]');
  list.push(entry);
  _writeJson(folder, '_index.json', list);
  _regenerateIndexHtml(folder);
}

function _regenerateIndexHtml(folder){
  let list = [];
  const it = folder.getFilesByName('_index.json');
  if (it.hasNext()) list = JSON.parse(it.next().getBlob().getDataAsString('UTF-8')||'[]');

  const rows = list.map(e=>{
    const label = e.source?.label || (e.source?.provider||'');
    const crop  = e.crop ? `x=${e.crop.x},y=${e.crop.y},w=${e.crop.w},h=${e.crop.h}` : '';
    return `<tr>
      <td>${e.timestamp||''}</td>
      <td>${label||e.type||''}</td>
      <td>${e.sha256||''}</td>
      <td><a href="${e.driveUrl||'#'}" target="_blank" rel="noopener">${e.name||''}</a></td>
      <td><a href="${e.finalUrl||e.url||'#'}" target="_blank" rel="noopener">${(e.finalUrl||e.url||'').replace(/https?:\/\//,'')}</a></td>
      <td>${e.source?.dimension||''}</td>
      <td>${crop}</td>
    </tr>`;
  }).join('\n');

  const html = `<!doctype html><meta charset="utf-8">
  <title>Web Evidence – Index</title>
  <style>body{font:13px/1.4 system-ui,Segoe UI,Roboto,Arial;padding:16px}
  table{border-collapse:collapse;width:100%} th,td{border:1px solid #ddd;padding:6px} th{background:#f6f6f6;text-align:left}</style>
  <h1>Indice prove</h1>
  <table><thead><tr>
    <th>Timestamp</th><th>Tipo</th><th>SHA-256</th><th>File</th><th>URL</th><th>Dimension</th><th>Crop</th>
  </tr></thead><tbody>${rows}</tbody></table>`;
  _writeText(folder, '_index.html', html, MimeType.HTML);
}

/* ===================== FILE & UTIL ===================== */

function _writeJson(folder, name, obj){
  const blob = Utilities.newBlob(JSON.stringify(obj,null,2), 'application/json', name);
  const it = folder.getFilesByName(name);
  if (it.hasNext()){ const f=it.next(); f.setContent(blob.getDataAsString()); }
  else folder.createFile(blob);
}
function _writeText(folder, name, text, mime){
  const it = folder.getFilesByName(name);
  if (it.hasNext()){ const f=it.next(); f.setContent(text); }
  else folder.createFile(Utilities.newBlob(text, mime||MimeType.PLAIN_TEXT, name));
}

function _listRecursive(folder, rel){
  const res = [];
  const files = folder.getFiles();
  while(files.hasNext()){
    const f = files.next();
    const bytes = f.getBlob().getBytes();
    res.push({ path:(rel?rel+'/':'')+f.getName(), sha256:_shaHex(bytes), bytes, mime:f.getMimeType()||'application/octet-stream' });
  }
  const subs = folder.getFolders();
  while(subs.hasNext()){
    const sub = subs.next();
    res.push(..._listRecursive(sub, (rel?rel+'/':'')+sub.getName()));
  }
  return res;
}

function _getEmailDefaults(){
  const sh = SpreadsheetApp.getActive().getSheetByName(DATA_SHEET);
  if (!sh) return {to:'',subject:''};
  return {
    to: String(sh.getRange(CELL_EMAIL).getValue()||'').trim(),
    subject: String(sh.getRange(CELL_SUBJ).getValue()||'').trim()
  };
}
function _getFolderOverride(){
  const sh = SpreadsheetApp.getActive().getSheetByName(DATA_SHEET);
  if (!sh) return '';
  return String(sh.getRange(CELL_FOLDER).getValue()||'').trim();
}
function _getSMKey(){
  const sh = SpreadsheetApp.getActive().getSheetByName(DATA_SHEET);
  if (!sh) throw new Error(`Foglio ${DATA_SHEET} mancante`);
  const k = String(sh.getRange(CELL_SM_KEY).getValue()||'').trim();
  if (!k) throw new Error(`Inserisci ScreenshotMachine key in ${DATA_SHEET}!${CELL_SM_KEY}`);
  return k;
}
function _getPSIKey(){
  const sh = SpreadsheetApp.getActive().getSheetByName(DATA_SHEET);
  if (!sh) throw new Error(`Foglio ${DATA_SHEET} mancante`);
  const k = String(sh.getRange(CELL_PSI_KEY).getValue()||'').trim();
  if (!k) throw new Error(`Inserisci PageSpeed key in ${DATA_SHEET}!${CELL_PSI_KEY}`);
  return k;
}
function _requireToken(tok){
  const sh = SpreadsheetApp.getActive().getSheetByName(DATA_SHEET);
  const expect = sh ? String(sh.getRange(CELL_TOKEN).getValue()||'').trim() : '';
  if (!expect) throw new Error(`Imposta token in ${DATA_SHEET}!${CELL_TOKEN}`);
  if (String(tok||'').trim() !== expect) throw new Error('Token non valido');
}
function _toQuery(o){ return Object.keys(o).map(k=>encodeURIComponent(k)+'='+encodeURIComponent(String(o[k]))).join('&'); }
function _coerceUrl(u){ let s=String(u||'').trim().replace(/[<>]/g,''); if(!/^https?:\/\//i.test(s)&&/\.[A-Za-z]{2,}/.test(s)) s='https://'+s; return s; }
function _sanitize(s){ return String(s||'').replace(/[\\/:*?"<>|]+/g,'_').replace(/\s+/g,' ').trim().slice(0,128); }
function _fmtDateIt(iso){ const tz=Session.getScriptTimeZone?Session.getScriptTimeZone():'Europe/Rome'; return Utilities.formatDate(new Date(iso),tz,'dd-MM-yyyy'); }
function _fmtTimeIt(iso){ const tz=Session.getScriptTimeZone?Session.getScriptTimeZone():'Europe/Rome'; return Utilities.formatDate(new Date(iso),tz,'HH-mm'); }
function _fmtTsFiles(iso){ return iso.replace('T','-').replace(/[:.].*Z?$/,'').replace(/:/g,'-'); }
function _shaHex(bytes){ return Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, bytes).map(b=>('0'+(b&255).toString(16)).slice(-2)).join(''); }
