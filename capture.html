<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web Evidence – v14</title>
<style>
  :root{--bd:#ddd;--accent:#0b5cff;--mut:#666}
  *{box-sizing:border-box}
  body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0;color:#111}
  header{display:grid;grid-template-columns:170px 1fr auto auto 260px 1fr auto auto;gap:8px;align-items:center;border-bottom:1px solid #eee;padding:10px}
  input,button{padding:8px;border:1px solid var(--bd);border-radius:10px;background:#fafafa}
  input[type="url"], input[type="text"]{background:#fff}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button[disabled]{opacity:.55;cursor:not-allowed}
  #state{justify-self:end;font-size:12px;color:#222;background:#f3f4f6;border-radius:999px;padding:.25rem .6rem}

  /* layout principale: colonna sinistra (anteprima) + destra (controlli) */
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  .card{border:1px solid #eee;border-radius:12px;background:#fff}
  .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #f3f4f4;font-size:13px;font-weight:700}

  /* anteprima 300×300 */
  .side{padding:12px}
  #thumb{width:300px;height:300px;display:block;background:#f5f5f5;border:1px dashed #ccc;border-radius:10px}

  /* controlli */
  .controls{display:flex;flex-direction:column;gap:10px;padding:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .checks{display:flex;gap:18px;align-items:center}

  /* area cattura grande (sotto, full width) */
  .capture{grid-column:1 / -1}
  #video{width:100%;max-height:70vh;background:#000;border-radius:12px}

  /* log */
  #log{height:160px;border:1px solid #eee;border-radius:10px;padding:8px;overflow:auto;font:12px/1.5 ui-monospace,Menlo,Consolas,monospace;background:#fafafa;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <input id="client" placeholder="Cliente…" />
  <input id="addr" type="url" placeholder="https://…" />
  <button id="btnOpen">Apri finestra pulita</button>
  <button id="btnPreview" class="primary">Seleziona finestra</button>

  <input id="rcpts" placeholder="Destinatari PEC/email" />
  <input id="subj" value="Web Evidence – Screenshot" />
  <button id="btnStart">Inizia certificazione</button>
  <button id="btnFinish" disabled>Termina</button>

  <span id="state">Pronto</span>
</header>

<div class="wrap">
  <!-- Colonna sinistra: ANTEPRIMA 300×300 -->
  <div class="card side">
    <h3>Anteprima (300×300)</h3>
    <canvas id="thumb" width="300" height="300" aria-label="Anteprima"></canvas>
  </div>

  <!-- Colonna destra: CONTROLLI -->
  <div class="card">
    <h3>Controlli</h3>
    <div class="controls">
      <div class="row checks">
        <label><input type="checkbox" id="chkFull"> Screenshot cattura completa</label>
        <label><input type="checkbox" id="chkAssets"> Scarica asset</label>
      </div>
      <div class="row">
        <button id="btnSnap">Scatta</button>
        <button id="btnSave" class="primary">Salva</button>
        <button id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <!-- Riga sotto: FINESTRA DI CATTURA grande -->
  <div class="card capture">
    <h3>Finestra di cattura</h3>
    <video id="video" autoplay muted playsinline></video>
  </div>
</div>

<div style="padding:8px 12px"><b>Log</b></div>
<div id="log"></div>

<script>
/* ===== Query (compat con tuo backend) ===== */
const qs=new URLSearchParams(location.search);
const APP=qs.get('app')||'', TOKEN=qs.get('t')||'';
if(qs.get('u')) addr.value=qs.get('u');
if(qs.get('client')) client.value=qs.get('client');
if(qs.get('to')) rcpts.value=qs.get('to');
if(qs.get('subj')) subj.value=qs.get('subj');

/* ===== Stato ===== */
let SID=''; let currentUrl=(addr.value||'').trim();
let stream=null;

const $ = id => document.getElementById(id);
const video=$('video'), thumb=$('thumb');

/* ===== UI helpers ===== */
const setState = s => $('state').textContent=s;
const log = s => { const L=$('log'); L.textContent+=(L.textContent?'\n':'')+'['+(new Date().toLocaleTimeString())+'] '+s; L.scrollTop=L.scrollHeight; setState(s); };
async function note(type, data={}){
  if(!SID) return;
  const q='mode=note&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)
        +'&msg='+encodeURIComponent(type+' '+JSON.stringify(data))+'&ua='+encodeURIComponent(navigator.userAgent||'');
  try{ await fetch(APP+(APP.includes('?')?'&':'?')+q); }catch(_){}
}
function hasStream(){ return !!(video.srcObject && video.videoWidth); }
function enableSession(on){ $('btnFinish').disabled=!on; }

/* ===== chiamate ===== */
async function GET(q){ const r=await fetch(APP+(APP.includes('?')?'&':'?')+q); return r.json(); }
async function POST(body){ const r=await fetch(APP,{method:'POST',headers:{'Content-Type':'text/plain; charset=utf-8'},body:JSON.stringify(body)}); return r.json(); }

/* ===== Apertura finestra pulita + Selezione ===== */
$('btnOpen').onclick = ()=>{
  const u=(addr.value||'').trim(); if(!u){ alert('URL obbligatoria'); return; }
  window.open(u, '_we_clean_'+Date.now(), 'noopener,width=1280,height=900,menubar=no,toolbar=no,location=no,status=no');
  log('Finestra/pagina aperta. Ora premi “Seleziona finestra”.');
};
$('btnPreview').onclick = async ()=>{
  try{
    const constraints={video:{displaySurface:'window',preferCurrentTab:true},audio:false};
    stream = await navigator.mediaDevices.getDisplayMedia(constraints);
    video.srcObject = stream; await video.play();
    log('Condivisione attiva.');
    note('PREVIEW_START',{surface:(stream.getVideoTracks()[0].getSettings()?.displaySurface||'')});
    stream.getVideoTracks()[0].addEventListener('ended', ()=>{ log('Condivisione terminata'); note('PREVIEW_END'); });
  }catch(e){ alert('Condivisione negata: '+(e.message||e)); }
};

/* ===== Sessione ===== */
$('btnStart').onclick = async ()=>{
  const cli=client.value.trim(), u=(addr.value||'').trim();
  if(!cli){ alert('Cliente obbligatorio'); return; }
  if(!u){ alert('URL obbligatoria'); return; }
  currentUrl=u; setState('Creo sessione…');
  const js=await GET('mode=start&t='+encodeURIComponent(TOKEN)+'&u='+encodeURIComponent(u)
    +'&client='+encodeURIComponent(cli)
    +'&ua='+encodeURIComponent(navigator.userAgent||'')
    +'&tz='+encodeURIComponent(Intl.DateTimeFormat().resolvedOptions().timeZone||'')
    +'&lang='+encodeURIComponent(navigator.language||'')
    +'&vw='+innerWidth+'&vh='+innerHeight+'&sw='+screen.width+'&sh='+screen.height+'&dpr='+(window.devicePixelRatio||1)
    +'&page='+encodeURIComponent(location.href||''));
  if(!js.ok){ alert(js.error||'Errore avvio'); setState('Errore'); return; }
  SID=js.sessionId; enableSession(true);
  log('Sessione: '+js.base); note('SESSION_START',{base:js.base,url:u});
};
$('btnFinish').onclick = async ()=>{
  if(!SID){ alert('Nessuna sessione'); return; }
  setState('Creo ZIP…');
  const js=await GET('mode=finish&t='+encodeURIComponent(TOKEN)+'&id='+encodeURIComponent(SID)
    +(rcpts.value?('&to='+encodeURIComponent(rcpts.value)):'')
    +(subj.value?('&subj='+encodeURIComponent(subj.value)):''));
  if(!js.ok){ alert(js.error||'Errore finish'); setState('Errore'); return; }
  log('ZIP: '+js.zipUrl); note('SESSION_FINISH',{zip:js.zipUrl}); setState('Completato');
  document.querySelectorAll('button').forEach(b=> b.disabled=true);
};

/* ===== Scatta → aggiorna anteprima 300×300 ===== */
function drawToThumb(bitmap){
  const ctx=thumb.getContext('2d');
  ctx.clearRect(0,0,thumb.width,thumb.height);
  const tw=thumb.width, th=thumb.height; const br=bitmap.width/bitmap.height;
  let dw=tw, dh=tw/br; if(dh>th){ dh=th; dw=th*br; }
  const dx=(tw-dw)/2, dy=(th-dh)/2; ctx.drawImage(bitmap,dx,dy,dw,dh);
}
$('btnSnap').onclick = async ()=>{
  if(!hasStream()){ alert('Attiva “Seleziona finestra”'); return; }
  try{
    const track=stream.getVideoTracks()[0]; const cap=new ImageCapture(track);
    const bitmap=await cap.grabFrame(); drawToThumb(bitmap); log('Scatto eseguito → anteprima 300×300.');
    note('SNAP_OK',{w:bitmap.width,h:bitmap.height});
  }catch(e){ log('Errore scatto: '+(e.message||e)); }
};

/* ===== Salva → invia PNG (con flag Full/Assets) ===== */
$('btnSave').onclick = async ()=>{
  if(!SID){ alert('Avvia certificazione'); return; }
  const ctx=thumb.getContext('2d');
  // se anteprima è vuota, forzo uno scatto rapido
  const pixels=ctx.getImageData(0,0,thumb.width,thumb.height).data; let empty=true; for(let i=0;i<pixels.length;i+=32){ if(pixels[i]|pixels[i+1]|pixels[i+2]|pixels[i+3]){empty=false;break;} }
  if(empty){ $('btnSnap').click(); }

  const dataUrl=thumb.toDataURL('image/png');
  const u=(addr.value||currentUrl||'').trim();
  const meta={ url:u, finalUrl:u, sourceMeta:{provider:'screen-capture',label: $('chkFull').checked?'FRAME_FULL':'FRAME_PREVIEW'}, flags:{ fullCapture: $('chkFull').checked, fetchAssets: $('chkAssets').checked } };
  const sv=await POST({authToken:TOKEN, sid:SID, dataUrl, sendEmail:false, meta});
  if(!sv.ok){ alert(sv.error||'Errore salvataggio'); return; }
  log('PNG salvato: '+sv.name+' sha='+sv.sha256+' (full='+meta.flags.fullCapture+', assets='+meta.flags.fetchAssets+')');
  note('PNG_SAVED', {name:sv.name, sha:sv.sha256, flags:meta.flags});
};

/* ===== Reset ===== */
$('btnReset').onclick = ()=>{
  const ctx=thumb.getContext('2d'); ctx.clearRect(0,0,thumb.width,thumb.height);
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){} stream=null; video.srcObject=null; }
  log('Reset effettuato'); note('RESET');
};

/* ===== Avvio ===== */
setState('Pronto');
</script>
</body>
</html>
